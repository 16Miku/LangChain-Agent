# Plan-V9: ç°ä»£åŒ–å‰ç«¯é‡æ„ä¸å¤šæ¨¡æ€å¢å¼º

> **ç‰ˆæœ¬**: V9.0
> **æ—¥æœŸ**: 2025-12-31
> **ç›®æ ‡**: ä½¿ç”¨ Next.js é‡æ„å‰ç«¯ï¼Œé›†æˆå¤šæ¨¡æ€èƒ½åŠ›ï¼Œå¢å¼º RAG æ£€ç´¢ï¼Œå¼•å…¥ç”¨æˆ·è®¤è¯ç³»ç»Ÿ
> **çŠ¶æ€**: ğŸš§ å¼€å‘ä¸­ (Phase 3: Week 7)

---

## ğŸ“‘ ç›®å½•

1. [ç‰ˆæœ¬æ¦‚è¿°](#ä¸€ç‰ˆæœ¬æ¦‚è¿°)
2. [éœ€æ±‚è§„æ ¼è¯´æ˜](#äºŒéœ€æ±‚è§„æ ¼è¯´æ˜)
3. [ç³»ç»Ÿæ¶æ„è®¾è®¡](#ä¸‰ç³»ç»Ÿæ¶æ„è®¾è®¡)
4. [æ¨¡å—è¯¦ç»†è®¾è®¡](#å››æ¨¡å—è¯¦ç»†è®¾è®¡)
5. [æ•°æ®åº“è®¾è®¡](#äº”æ•°æ®åº“è®¾è®¡)
6. [API æ¥å£è®¾è®¡](#å…­api-æ¥å£è®¾è®¡)
7. [å‰ç«¯é¡µé¢è®¾è®¡](#ä¸ƒå‰ç«¯é¡µé¢è®¾è®¡)
8. [éƒ¨ç½²æ¶æ„](#å…«éƒ¨ç½²æ¶æ„)
9. [å¼€å‘è®¡åˆ’](#ä¹å¼€å‘è®¡åˆ’)
10. [é£é™©è¯„ä¼°ä¸åº”å¯¹](#åé£é™©è¯„ä¼°ä¸åº”å¯¹)
11. [éªŒæ”¶æ ‡å‡†](#åä¸€éªŒæ”¶æ ‡å‡†)
12. [é™„å½•](#åäºŒé™„å½•)

---

## ä¸€ã€ç‰ˆæœ¬æ¦‚è¿°

### 1.1 ç‰ˆæœ¬ç›®æ ‡

V9.0 æ˜¯ My-Chat-LangChain é¡¹ç›®çš„é‡å¤§å‡çº§ç‰ˆæœ¬ï¼Œæ ¸å¿ƒç›®æ ‡æ˜¯ï¼š

1. **å‰ç«¯ç°ä»£åŒ–**: ä½¿ç”¨ Next.js + shadcn/ui å®Œå…¨é‡æ„å‰ç«¯ï¼Œæ›¿ä»£ Streamlit
2. **å¤šæ¨¡æ€äº¤äº’**: æ”¯æŒå›¾ç‰‡ç†è§£/OCR å’Œè¯­éŸ³äº¤äº’
3. **RAG èƒ½åŠ›å¢å¼º**: æ··åˆæ£€ç´¢ã€å¼•ç”¨è¿½æº¯ã€é‡æ’åºã€MinerU æ–‡æ¡£è§£æ
4. **ç”¨æˆ·ç³»ç»Ÿ**: ä¼ ç»Ÿè´¦å·è®¤è¯ + JWT
5. **ç”Ÿäº§çº§éƒ¨ç½²**: Docker Compose ä¸€é”®éƒ¨ç½²

### 1.2 ç‰ˆæœ¬å¯¹æ¯”

```
V8.0 (å½“å‰)                              V9.0 (ç›®æ ‡)
â”œâ”€â”€ Streamlit å‰ç«¯                        â”œâ”€â”€ Next.js 14 + shadcn/ui å‰ç«¯
â”œâ”€â”€ æ— ç”¨æˆ·ç³»ç»Ÿ                            â”œâ”€â”€ å®Œæ•´ç”¨æˆ·è®¤è¯ç³»ç»Ÿ (JWT)
â”œâ”€â”€ ChromaDB å‘é‡å­˜å‚¨                     â”œâ”€â”€ Milvus å‘é‡æ•°æ®åº“
â”œâ”€â”€ SQLite æŒä¹…åŒ–                         â”œâ”€â”€ PostgreSQL ç”¨æˆ·æ•°æ®åº“
â”œâ”€â”€ æ–‡æœ¬èŠå¤©                              â”œâ”€â”€ æ–‡æœ¬ + å›¾ç‰‡ + è¯­éŸ³ å¤šæ¨¡æ€
â”œâ”€â”€ åŸºç¡€ RAG æ£€ç´¢                         â”œâ”€â”€ æ··åˆæ£€ç´¢ + é‡æ’åº + å¼•ç”¨è¿½æº¯
â”œâ”€â”€ æ‰‹åŠ¨æ–‡ä»¶ä¸Šä¼ è§£æ                       â”œâ”€â”€ MinerU æ™ºèƒ½æ–‡æ¡£è§£æ
â”œâ”€â”€ å•å®¹å™¨éƒ¨ç½²                            â”œâ”€â”€ Docker Compose å¾®æœåŠ¡éƒ¨ç½²
â””â”€â”€ 96+ å·¥å…·                              â””â”€â”€ 96+ å·¥å…· (ä¿æŒ)
```

### 1.3 æ ¸å¿ƒåŠŸèƒ½æ¸…å•

| åŠŸèƒ½æ¨¡å— | å­åŠŸèƒ½ | ä¼˜å…ˆçº§ | é˜¶æ®µ |
|---------|--------|--------|------|
| **Next.js å‰ç«¯** | èŠå¤©ç•Œé¢ | P0 | Phase 1 |
| | æ¶ˆæ¯æµå¼æ¸²æŸ“ | P0 | Phase 1 |
| | å·¥å…·è°ƒç”¨å¯è§†åŒ– | P0 | Phase 1 |
| | å›¾è¡¨/å›¾ç‰‡æ¸²æŸ“ | P0 | Phase 1 |
| | å“åº”å¼è®¾è®¡ | P1 | Phase 1 |
| | æš—è‰²æ¨¡å¼ | P2 | Phase 1 |
| **ç”¨æˆ·ç³»ç»Ÿ** | æ³¨å†Œ/ç™»å½• | P0 | Phase 1 |
| | JWT è®¤è¯ | P0 | Phase 1 |
| | ä¼šè¯ç®¡ç† | P0 | Phase 1 |
| | ç”¨æˆ·è®¾ç½® | P1 | Phase 1 |
| | API Key ç®¡ç† | P1 | Phase 1 |
| **å¤šæ¨¡æ€** | å›¾ç‰‡ä¸Šä¼ ä¸ç†è§£ | P0 | Phase 2 |
| | OCR æ–‡å­—è¯†åˆ« | P1 | Phase 2 |
| | è¯­éŸ³è¾“å…¥ (Whisper) | P1 | Phase 2 |
| | è¯­éŸ³è¾“å‡º (Edge TTS) | P2 | Phase 2 |
| **RAG å¢å¼º** | Milvus å‘é‡å­˜å‚¨è¿ç§» | P0 | Phase 3 |
| | æ··åˆæ£€ç´¢ (å‘é‡+BM25) | P0 | Phase 3 |
| | å¼•ç”¨è¿½æº¯ | P0 | Phase 3 |
| | Reranker é‡æ’åº | P1 | Phase 3 |
| | MinerU æ–‡æ¡£è§£æ | P1 | Phase 3 |
| | å¤šè½®å¯¹è¯æ£€ç´¢ | P2 | Phase 3 |
| **éƒ¨ç½²** | Docker Compose | P0 | Phase 1 |
| | ç¯å¢ƒé…ç½®ç®¡ç† | P0 | Phase 1 |
| | å¥åº·æ£€æŸ¥ | P1 | Phase 1 |

---

## äºŒã€éœ€æ±‚è§„æ ¼è¯´æ˜

### 2.1 åŠŸèƒ½éœ€æ±‚

#### 2.1.1 Next.js å‰ç«¯ (FR-01)

**FR-01-01: å¯¹è¯å¼èŠå¤©ç•Œé¢**
- ç±»ä¼¼ ChatGPT çš„å¯¹è¯ UI é£æ ¼
- æ”¯æŒ Markdown æ¸²æŸ“ï¼ˆä»£ç é«˜äº®ã€è¡¨æ ¼ã€åˆ—è¡¨ç­‰ï¼‰
- æ”¯æŒ LaTeX æ•°å­¦å…¬å¼æ¸²æŸ“
- æ¶ˆæ¯æ°”æ³¡åŒºåˆ†ç”¨æˆ·/AI
- æ”¯æŒæ¶ˆæ¯å¤åˆ¶ã€é‡æ–°ç”Ÿæˆ
- è¾“å…¥æ¡†æ”¯æŒå¤šè¡Œã€å¿«æ·é”®å‘é€

**FR-01-02: æµå¼å“åº”æ¸²æŸ“**
- å®æ—¶æ˜¾ç¤º AI å›å¤ï¼ˆSSE/WebSocketï¼‰
- æ‰“å­—æœºæ•ˆæœé€å­—æ˜¾ç¤º
- æ”¯æŒä¸­æ–­ç”Ÿæˆ
- åŠ è½½çŠ¶æ€æŒ‡ç¤º

**FR-01-03: å·¥å…·è°ƒç”¨å¯è§†åŒ–**
- æŠ˜å å¼å·¥å…·è°ƒç”¨é¢æ¿
- æ˜¾ç¤ºå·¥å…·åç§°ã€å‚æ•°ã€è€—æ—¶
- å·¥å…·æ‰§è¡ŒçŠ¶æ€æŒ‡ç¤ºï¼ˆè¿›è¡Œä¸­/æˆåŠŸ/å¤±è´¥ï¼‰
- å·¥å…·è¾“å‡ºæ™ºèƒ½æ‘˜è¦ï¼ˆéåŸå§‹ JSONï¼‰

**FR-01-04: å¤šåª’ä½“æ¸²æŸ“**
- å›¾è¡¨æ¸²æŸ“ï¼ˆBase64 å›¾ç‰‡ï¼‰
- ä»£ç å—è¯­æ³•é«˜äº®
- è¡¨æ ¼å“åº”å¼æ˜¾ç¤º
- å¤–éƒ¨å›¾ç‰‡æ‡’åŠ è½½

**FR-01-05: ä¾§è¾¹æ åŠŸèƒ½**
- ä¼šè¯å†å²åˆ—è¡¨
- æ–°å»º/åˆ é™¤/é‡å‘½åä¼šè¯
- ä¼šè¯æœç´¢
- ç”¨æˆ·è®¾ç½®å…¥å£
- API Key é…ç½®

**FR-01-06: å“åº”å¼è®¾è®¡**
- æ¡Œé¢ç«¯å®Œæ•´åŠŸèƒ½
- ç§»åŠ¨ç«¯è‡ªé€‚åº”å¸ƒå±€
- ä¾§è¾¹æ å¯æŠ˜å 

#### 2.1.2 ç”¨æˆ·è®¤è¯ç³»ç»Ÿ (FR-02)

**FR-02-01: ç”¨æˆ·æ³¨å†Œ**
- ç”¨æˆ·å + é‚®ç®± + å¯†ç æ³¨å†Œ
- å¯†ç å¼ºåº¦éªŒè¯
- ç”¨æˆ·å/é‚®ç®±å”¯ä¸€æ€§æ£€æŸ¥
- æ³¨å†ŒæˆåŠŸè‡ªåŠ¨ç™»å½•

**FR-02-02: ç”¨æˆ·ç™»å½•**
- ç”¨æˆ·å/é‚®ç®± + å¯†ç ç™»å½•
- JWT Token ç”Ÿæˆä¸éªŒè¯
- è®°ä½ç™»å½•çŠ¶æ€ï¼ˆRefresh Tokenï¼‰
- ç™»å½•å¤±è´¥æ¬¡æ•°é™åˆ¶

**FR-02-03: ä¼šè¯ç®¡ç†**
- Token è‡ªåŠ¨åˆ·æ–°
- å¤šè®¾å¤‡ç™»å½•æ”¯æŒ
- å¼ºåˆ¶ç™»å‡ºåŠŸèƒ½
- ä¼šè¯è¿‡æœŸæç¤º

**FR-02-04: ç”¨æˆ·è®¾ç½®**
- ä¿®æ”¹å¯†ç 
- ä¿®æ”¹ç”¨æˆ·å/é‚®ç®±
- ä¸ªäºº API Key ç®¡ç†
- åå¥½è®¾ç½®ï¼ˆä¸»é¢˜ã€è¯­è¨€ç­‰ï¼‰

**FR-02-05: æƒé™æ§åˆ¶**
- æœªç™»å½•ï¼šä»…å¯è®¿é—®ç™»å½•/æ³¨å†Œé¡µ
- å·²ç™»å½•ï¼šå®Œæ•´åŠŸèƒ½è®¿é—®
- API è¯·æ±‚ Token éªŒè¯

#### 2.1.3 å¤šæ¨¡æ€èƒ½åŠ› (FR-03)

**FR-03-01: å›¾ç‰‡ç†è§£**
- æ”¯æŒä¸Šä¼ å›¾ç‰‡ï¼ˆJPG/PNG/GIF/WebPï¼‰
- æ”¯æŒç²˜è´´å‰ªè´´æ¿å›¾ç‰‡
- æ”¯æŒæ‹–æ‹½ä¸Šä¼ 
- å›¾ç‰‡é¢„è§ˆä¸åˆ é™¤
- è°ƒç”¨ Gemini Vision API åˆ†æå›¾ç‰‡
- æ”¯æŒå¤šå›¾åŒæ—¶ä¸Šä¼ 

**FR-03-02: OCR æ–‡å­—è¯†åˆ«**
- è¯†åˆ«å›¾ç‰‡ä¸­çš„æ–‡å­—
- æ”¯æŒä¸­è‹±æ–‡æ··åˆè¯†åˆ«
- è¿”å›ç»“æ„åŒ–æ–‡æœ¬

**FR-03-03: è¯­éŸ³è¾“å…¥**
- å½•éŸ³æŒ‰é’®ï¼ˆæŒ‰ä½å½•éŸ³/ç‚¹å‡»åˆ‡æ¢ï¼‰
- æœ¬åœ° Whisper è¯­éŸ³è¯†åˆ«
- è¯†åˆ«ç»“æœå¡«å…¥è¾“å…¥æ¡†
- æ”¯æŒä¸­æ–‡/è‹±æ–‡/æ··åˆè¯­éŸ³

**FR-03-04: è¯­éŸ³è¾“å‡º**
- AI å›å¤æ–‡å­—è½¬è¯­éŸ³
- Edge TTS è¯­éŸ³åˆæˆ
- æ’­æ”¾/æš‚åœæ§åˆ¶
- è¯­éŸ³é€‰æ‹©ï¼ˆå£°éŸ³ç±»å‹ï¼‰

#### 2.1.4 RAG å¢å¼º (FR-04)

**FR-04-01: Milvus å‘é‡å­˜å‚¨**
- è¿ç§» ChromaDB è‡³ Milvus
- æ”¯æŒå¤§è§„æ¨¡å‘é‡å­˜å‚¨
- é«˜æ€§èƒ½ç›¸ä¼¼åº¦æœç´¢
- Collection ç®¡ç†

**FR-04-02: æ··åˆæ£€ç´¢**
- å‘é‡ç›¸ä¼¼åº¦æ£€ç´¢
- BM25 å…³é”®è¯æ£€ç´¢
- RRF (Reciprocal Rank Fusion) èåˆ
- å¯é…ç½®æ£€ç´¢æƒé‡

**FR-04-03: å¼•ç”¨è¿½æº¯**
- æ¯æ®µå›å¤æ ‡æ³¨æ¥æºæ–‡æ¡£
- æ˜¾ç¤ºå…·ä½“é¡µç /ç« èŠ‚
- ç‚¹å‡»å¼•ç”¨è·³è½¬åŸæ–‡
- å¼•ç”¨ç½®ä¿¡åº¦è¯„åˆ†

**FR-04-04: ç»“æœé‡æ’åº**
- ä½¿ç”¨ Reranker æ¨¡å‹ï¼ˆå¦‚ bge-rerankerï¼‰
- å¯¹æ£€ç´¢ç»“æœäºŒæ¬¡æ’åº
- æå‡ç›¸å…³æ€§å‡†ç¡®åº¦

**FR-04-05: MinerU æ–‡æ¡£è§£æ**
- è°ƒç”¨ MinerU äº‘æœåŠ¡ API
- æ”¯æŒ PDF/Word/PPT ç­‰æ ¼å¼
- æ™ºèƒ½åˆ†å—ï¼ˆè¯­ä¹‰åˆ‡åˆ†ï¼‰
- è¡¨æ ¼/å›¾è¡¨æå–
- å…¬å¼è¯†åˆ«

**FR-04-06: å¤šè½®å¯¹è¯æ£€ç´¢**
- å¯¹è¯å†å²ä¸Šä¸‹æ–‡ç†è§£
- æŸ¥è¯¢æ”¹å†™ï¼ˆQuery Rewritingï¼‰
- è¿½é—®åœºæ™¯ä¼˜åŒ–

#### 2.1.5 éƒ¨ç½²ä¸è¿ç»´ (FR-05)

**FR-05-01: Docker Compose éƒ¨ç½²**
- ä¸€é”®å¯åŠ¨æ‰€æœ‰æœåŠ¡
- æœåŠ¡ä¾èµ–ç®¡ç†
- ç½‘ç»œéš”ç¦»é…ç½®
- æ•°æ®å·æŒä¹…åŒ–

**FR-05-02: ç¯å¢ƒé…ç½®**
- ç¯å¢ƒå˜é‡ç»Ÿä¸€ç®¡ç†
- å¼€å‘/ç”Ÿäº§ç¯å¢ƒåˆ†ç¦»
- æ•æ„Ÿä¿¡æ¯åŠ å¯†

**FR-05-03: å¥åº·æ£€æŸ¥**
- æœåŠ¡å­˜æ´»æ£€æŸ¥
- ä¾èµ–æœåŠ¡æ£€æŸ¥
- è‡ªåŠ¨é‡å¯ç­–ç•¥

### 2.2 éåŠŸèƒ½éœ€æ±‚

#### 2.2.1 æ€§èƒ½éœ€æ±‚ (NFR-01)

| æŒ‡æ ‡ | ç›®æ ‡å€¼ |
|------|--------|
| é¦–å±åŠ è½½æ—¶é—´ | < 2s |
| æ¶ˆæ¯å‘é€å“åº” | < 500ms |
| æµå¼é¦– Token | < 1s |
| RAG æ£€ç´¢å»¶è¿Ÿ | < 500ms |
| å¹¶å‘ç”¨æˆ·æ•° | 100+ |

#### 2.2.2 å®‰å…¨éœ€æ±‚ (NFR-02)

- å¯†ç  bcrypt åŠ å¯†å­˜å‚¨
- JWT Token ç­¾åéªŒè¯
- HTTPS ä¼ è¾“åŠ å¯†
- SQL æ³¨å…¥é˜²æŠ¤
- XSS é˜²æŠ¤
- CORS é…ç½®

#### 2.2.3 å¯ç”¨æ€§éœ€æ±‚ (NFR-03)

- æœåŠ¡å¯ç”¨æ€§ > 99%
- ä¼˜é›…é™çº§ï¼ˆå¤–éƒ¨æœåŠ¡æ•…éšœæ—¶ï¼‰
- é”™è¯¯æç¤ºç”¨æˆ·å‹å¥½

#### 2.2.4 å¯ç»´æŠ¤æ€§éœ€æ±‚ (NFR-04)

- ä»£ç è§„èŒƒä¸€è‡´
- å®Œæ•´çš„é”™è¯¯æ—¥å¿—
- API æ–‡æ¡£è‡ªåŠ¨ç”Ÿæˆ
- å•å…ƒæµ‹è¯•è¦†ç›–ç‡ > 60%

---

## ä¸‰ã€ç³»ç»Ÿæ¶æ„è®¾è®¡

### 3.1 æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           My-Chat-LangChain V9.0                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                        Frontend (Next.js 14)                         â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚ Chat Page â”‚ â”‚Login/Reg  â”‚ â”‚ Settings  â”‚ â”‚ Conversation List â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚                    shadcn/ui + Tailwind                      â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â”‚                                        â”‚
â”‚                          HTTP/REST + SSE                                    â”‚
â”‚                                    â”‚                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                        API Gateway (Nginx)                           â”‚   â”‚
â”‚  â”‚                    - åå‘ä»£ç† - SSL ç»ˆæ­¢ - è´Ÿè½½å‡è¡¡                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â”‚                                        â”‚
â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚          â”‚                         â”‚                         â”‚              â”‚
â”‚          â–¼                         â–¼                         â–¼              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  Auth Service â”‚        â”‚  Chat Service â”‚        â”‚  RAG Service  â”‚       â”‚
â”‚  â”‚  (FastAPI)    â”‚        â”‚  (FastAPI)    â”‚        â”‚  (FastAPI)    â”‚       â”‚
â”‚  â”‚               â”‚        â”‚               â”‚        â”‚               â”‚       â”‚
â”‚  â”‚ - ç”¨æˆ·æ³¨å†Œ    â”‚        â”‚ - èŠå¤©æµå¼    â”‚        â”‚ - æ–‡æ¡£è§£æ    â”‚       â”‚
â”‚  â”‚ - ç”¨æˆ·ç™»å½•    â”‚        â”‚ - Agent è°ƒç”¨  â”‚        â”‚ - å‘é‡æ£€ç´¢    â”‚       â”‚
â”‚  â”‚ - Token ç®¡ç†  â”‚        â”‚ - å·¥å…·æ‰§è¡Œ    â”‚        â”‚ - æ··åˆæ£€ç´¢    â”‚       â”‚
â”‚  â”‚ - æƒé™éªŒè¯    â”‚        â”‚ - ä¼šè¯ç®¡ç†    â”‚        â”‚ - é‡æ’åº      â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚          â”‚                         â”‚                         â”‚              â”‚
â”‚          â”‚                         â”‚                         â”‚              â”‚
â”‚          â–¼                         â–¼                         â–¼              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚                         Data Layer                                 â”‚     â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚     â”‚
â”‚  â”‚  â”‚ PostgreSQL  â”‚  â”‚   Milvus    â”‚  â”‚    Redis    â”‚  â”‚ MinIO/S3 â”‚ â”‚     â”‚
â”‚  â”‚  â”‚ - ç”¨æˆ·æ•°æ®  â”‚  â”‚ - å‘é‡å­˜å‚¨  â”‚  â”‚ - ä¼šè¯ç¼“å­˜  â”‚  â”‚ - æ–‡ä»¶   â”‚ â”‚     â”‚
â”‚  â”‚  â”‚ - ä¼šè¯è®°å½•  â”‚  â”‚ - ç›¸ä¼¼æœç´¢  â”‚  â”‚ - Token     â”‚  â”‚   å­˜å‚¨   â”‚ â”‚     â”‚
â”‚  â”‚  â”‚ - è®¾ç½®é…ç½®  â”‚  â”‚             â”‚  â”‚             â”‚  â”‚          â”‚ â”‚     â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚                       External Services                            â”‚     â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚     â”‚
â”‚  â”‚  â”‚ Gemini  â”‚ â”‚  E2B    â”‚ â”‚  MCP    â”‚ â”‚ MinerU  â”‚ â”‚ Whisper     â”‚ â”‚     â”‚
â”‚  â”‚  â”‚ Vision  â”‚ â”‚ Sandbox â”‚ â”‚ Tools   â”‚ â”‚  API    â”‚ â”‚ (Local)     â”‚ â”‚     â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 æœåŠ¡æ‹†åˆ†

| æœåŠ¡ | èŒè´£ | æŠ€æœ¯æ ˆ | ç«¯å£ |
|------|------|--------|------|
| **frontend** | Next.js å‰ç«¯åº”ç”¨ | Next.js 14, React 18, shadcn/ui | 3000 |
| **auth-service** | ç”¨æˆ·è®¤è¯æœåŠ¡ | FastAPI, SQLAlchemy | 8001 |
| **chat-service** | èŠå¤©æ ¸å¿ƒæœåŠ¡ | FastAPI, LangGraph | 8002 |
| **rag-service** | RAG æ£€ç´¢æœåŠ¡ | FastAPI, LangChain | 8004 |
| **whisper-service** | è¯­éŸ³è¯†åˆ«æœåŠ¡ | FastAPI, faster-whisper | 8003 |
| **nginx** | API ç½‘å…³ | Nginx | 80/443 |
| **postgres** | å…³ç³»æ•°æ®åº“ | PostgreSQL 15 | 5432 |
| **milvus** | å‘é‡æ•°æ®åº“ | Milvus 2.x | 19530 |
| **redis** | ç¼“å­˜/ä¼šè¯ | Redis 7 | 6379 |
| **minio** | æ–‡ä»¶å­˜å‚¨ | MinIO | 9000 |

### 3.3 æœåŠ¡é—´é€šä¿¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     HTTP/REST      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Frontend  â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚   Nginx     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                                           â”‚
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚                  â”‚                  â”‚
                        â–¼                  â–¼                  â–¼
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ Auth Service  â”‚  â”‚ Chat Service  â”‚  â”‚  RAG Service  â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚                  â”‚                  â”‚
                        â”‚    Internal gRPC/HTTP              â”‚
                        â”‚                  â”‚                  â”‚
                        â–¼                  â–¼                  â–¼
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                    Data Layer                        â”‚
                â”‚  PostgreSQL â”‚ Milvus â”‚ Redis â”‚ MinIO                â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.4 æŠ€æœ¯é€‰å‹è¯¦è§£

| ç±»åˆ« | æŠ€æœ¯ | ç‰ˆæœ¬ | é€‰å‹ç†ç”± |
|------|------|------|---------|
| **å‰ç«¯æ¡†æ¶** | Next.js | 14.x | App Routerã€SSRã€API Routes |
| **UI ç»„ä»¶åº“** | shadcn/ui | latest | å¯å®šåˆ¶ã€ç°ä»£ã€ä¸ Tailwind é›†æˆ |
| **CSS æ¡†æ¶** | Tailwind CSS | 3.x | åŸå­åŒ– CSSã€å“åº”å¼ |
| **çŠ¶æ€ç®¡ç†** | Zustand | 4.x | è½»é‡ã€ç®€æ´ã€TypeScript å‹å¥½ |
| **HTTP å®¢æˆ·ç«¯** | Axios | 1.x | æ‹¦æˆªå™¨ã€è¯·æ±‚å–æ¶ˆ |
| **åç«¯æ¡†æ¶** | FastAPI | 0.115+ | å¼‚æ­¥ã€è‡ªåŠ¨æ–‡æ¡£ã€ç±»å‹å®‰å…¨ |
| **ORM** | SQLAlchemy | 2.x | æˆç†Ÿã€åŠŸèƒ½å…¨é¢ |
| **è®¤è¯** | python-jose | 3.x | JWT å¤„ç† |
| **å¯†ç åŠ å¯†** | passlib[bcrypt] | 1.7+ | è¡Œä¸šæ ‡å‡† |
| **å‘é‡æ•°æ®åº“** | Milvus | 2.x | é«˜æ€§èƒ½ã€åˆ†å¸ƒå¼ã€åŠŸèƒ½ä¸°å¯Œ |
| **å…³ç³»æ•°æ®åº“** | PostgreSQL | 15.x | ç¨³å®šã€åŠŸèƒ½å¼ºå¤§ |
| **ç¼“å­˜** | Redis | 7.x | é«˜æ€§èƒ½ã€ä¼šè¯å­˜å‚¨ |
| **æ–‡ä»¶å­˜å‚¨** | MinIO | latest | S3 å…¼å®¹ã€è‡ªæ‰˜ç®¡ |
| **è¯­éŸ³è¯†åˆ«** | faster-whisper | 1.x | æœ¬åœ°è¿è¡Œã€é«˜ç²¾åº¦ |
| **è¯­éŸ³åˆæˆ** | edge-tts | 6.x | å…è´¹ã€é«˜è´¨é‡ |
| **æ–‡æ¡£è§£æ** | MinerU API | - | æ™ºèƒ½åˆ†å—ã€OCR |
| **å®¹å™¨ç¼–æ’** | Docker Compose | 2.x | ç®€å•éƒ¨ç½² |

---

## å››ã€æ¨¡å—è¯¦ç»†è®¾è®¡

### 4.1 å‰ç«¯æ¨¡å—è®¾è®¡

#### 4.1.1 é¡¹ç›®ç»“æ„

```
frontend/
â”œâ”€â”€ app/                          # Next.js App Router
â”‚   â”œâ”€â”€ (auth)/                   # è®¤è¯ç›¸å…³è·¯ç”±ç»„
â”‚   â”‚   â”œâ”€â”€ login/
â”‚   â”‚   â”‚   â””â”€â”€ page.tsx
â”‚   â”‚   â”œâ”€â”€ register/
â”‚   â”‚   â”‚   â””â”€â”€ page.tsx
â”‚   â”‚   â””â”€â”€ layout.tsx
â”‚   â”œâ”€â”€ (main)/                   # ä¸»åº”ç”¨è·¯ç”±ç»„
â”‚   â”‚   â”œâ”€â”€ chat/
â”‚   â”‚   â”‚   â”œâ”€â”€ [id]/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ page.tsx      # å•ä¸ªä¼šè¯é¡µé¢
â”‚   â”‚   â”‚   â””â”€â”€ page.tsx          # æ–°ä¼šè¯é¡µé¢
â”‚   â”‚   â”œâ”€â”€ settings/
â”‚   â”‚   â”‚   â””â”€â”€ page.tsx
â”‚   â”‚   â””â”€â”€ layout.tsx            # å¸¦ä¾§è¾¹æ çš„å¸ƒå±€
â”‚   â”œâ”€â”€ api/                      # API Routes (å¯é€‰)
â”‚   â”‚   â””â”€â”€ auth/
â”‚   â”‚       â””â”€â”€ [...nextauth]/
â”‚   â”‚           â””â”€â”€ route.ts
â”‚   â”œâ”€â”€ layout.tsx                # æ ¹å¸ƒå±€
â”‚   â”œâ”€â”€ page.tsx                  # é¦–é¡µï¼ˆé‡å®šå‘åˆ° /chatï¼‰
â”‚   â””â”€â”€ globals.css
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ chat/
â”‚   â”‚   â”œâ”€â”€ ChatContainer.tsx     # èŠå¤©å®¹å™¨
â”‚   â”‚   â”œâ”€â”€ MessageList.tsx       # æ¶ˆæ¯åˆ—è¡¨
â”‚   â”‚   â”œâ”€â”€ MessageBubble.tsx     # å•æ¡æ¶ˆæ¯æ°”æ³¡
â”‚   â”‚   â”œâ”€â”€ InputArea.tsx         # è¾“å…¥åŒºåŸŸ
â”‚   â”‚   â”œâ”€â”€ ToolCallPanel.tsx     # å·¥å…·è°ƒç”¨é¢æ¿
â”‚   â”‚   â”œâ”€â”€ CodeBlock.tsx         # ä»£ç å—ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ ImageUploader.tsx     # å›¾ç‰‡ä¸Šä¼ 
â”‚   â”‚   â””â”€â”€ VoiceRecorder.tsx     # è¯­éŸ³å½•åˆ¶
â”‚   â”œâ”€â”€ sidebar/
â”‚   â”‚   â”œâ”€â”€ Sidebar.tsx           # ä¾§è¾¹æ ä¸»ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ ConversationList.tsx  # ä¼šè¯åˆ—è¡¨
â”‚   â”‚   â”œâ”€â”€ ConversationItem.tsx  # å•ä¸ªä¼šè¯é¡¹
â”‚   â”‚   â””â”€â”€ UserMenu.tsx          # ç”¨æˆ·èœå•
â”‚   â”œâ”€â”€ settings/
â”‚   â”‚   â”œâ”€â”€ SettingsPanel.tsx
â”‚   â”‚   â”œâ”€â”€ APIKeyForm.tsx
â”‚   â”‚   â””â”€â”€ ThemeSelector.tsx
â”‚   â”œâ”€â”€ ui/                       # shadcn/ui ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ button.tsx
â”‚   â”‚   â”œâ”€â”€ input.tsx
â”‚   â”‚   â”œâ”€â”€ dialog.tsx
â”‚   â”‚   â””â”€â”€ ...
â”‚   â””â”€â”€ providers/
â”‚       â”œâ”€â”€ AuthProvider.tsx
â”‚       â””â”€â”€ ThemeProvider.tsx
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ client.ts             # Axios å®¢æˆ·ç«¯
â”‚   â”‚   â”œâ”€â”€ auth.ts               # è®¤è¯ API
â”‚   â”‚   â”œâ”€â”€ chat.ts               # èŠå¤© API
â”‚   â”‚   â””â”€â”€ rag.ts                # RAG API
â”‚   â”œâ”€â”€ hooks/
â”‚   â”‚   â”œâ”€â”€ useAuth.ts
â”‚   â”‚   â”œâ”€â”€ useChat.ts
â”‚   â”‚   â”œâ”€â”€ useSSE.ts             # SSE æµå¼å¤„ç†
â”‚   â”‚   â””â”€â”€ useVoice.ts
â”‚   â”œâ”€â”€ stores/
â”‚   â”‚   â”œâ”€â”€ authStore.ts          # Zustand è®¤è¯çŠ¶æ€
â”‚   â”‚   â”œâ”€â”€ chatStore.ts          # èŠå¤©çŠ¶æ€
â”‚   â”‚   â””â”€â”€ settingsStore.ts      # è®¾ç½®çŠ¶æ€
â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â”œâ”€â”€ markdown.ts           # Markdown å¤„ç†
â”‚   â”‚   â”œâ”€â”€ format.ts             # æ ¼å¼åŒ–å·¥å…·
â”‚   â”‚   â””â”€â”€ storage.ts            # æœ¬åœ°å­˜å‚¨
â”‚   â””â”€â”€ types/
â”‚       â”œâ”€â”€ auth.ts
â”‚       â”œâ”€â”€ chat.ts
â”‚       â””â”€â”€ api.ts
â”œâ”€â”€ public/
â”‚   â””â”€â”€ ...
â”œâ”€â”€ tailwind.config.ts
â”œâ”€â”€ next.config.js
â”œâ”€â”€ package.json
â””â”€â”€ tsconfig.json
```

#### 4.1.2 æ ¸å¿ƒç»„ä»¶è®¾è®¡

**MessageBubble ç»„ä»¶**

```typescript
// components/chat/MessageBubble.tsx

interface MessageBubbleProps {
  message: Message;
  isStreaming?: boolean;
  onRegenerate?: () => void;
  onCopy?: () => void;
}

interface Message {
  id: string;
  role: 'user' | 'assistant';
  content: string;
  timestamp: Date;
  toolCalls?: ToolCall[];
  images?: string[];      // Base64 å›¾ç‰‡
  citations?: Citation[]; // å¼•ç”¨æ¥æº
}

interface ToolCall {
  id: string;
  name: string;
  args: Record<string, any>;
  status: 'running' | 'success' | 'error';
  output?: string;
  duration?: number;
}

interface Citation {
  sourceId: string;
  sourceName: string;
  pageNumber?: number;
  content: string;
  confidence: number;
}
```

**InputArea ç»„ä»¶**

```typescript
// components/chat/InputArea.tsx

interface InputAreaProps {
  onSend: (message: string, images?: File[]) => void;
  onVoiceInput: (transcript: string) => void;
  disabled?: boolean;
  placeholder?: string;
}

// åŠŸèƒ½:
// - å¤šè¡Œæ–‡æœ¬è¾“å…¥ (Shift+Enter æ¢è¡Œ, Enter å‘é€)
// - å›¾ç‰‡ä¸Šä¼ æŒ‰é’® (æ”¯æŒå¤šé€‰)
// - å›¾ç‰‡æ‹–æ‹½ä¸Šä¼ 
// - å›¾ç‰‡ç²˜è´´ (Ctrl+V)
// - è¯­éŸ³å½•åˆ¶æŒ‰é’®
// - å‘é€æŒ‰é’®
// - å·²é€‰å›¾ç‰‡é¢„è§ˆæ¡
```

#### 4.1.3 çŠ¶æ€ç®¡ç†

**è®¤è¯çŠ¶æ€ (authStore.ts)**

```typescript
import { create } from 'zustand';
import { persist } from 'zustand/middleware';

interface AuthState {
  user: User | null;
  accessToken: string | null;
  refreshToken: string | null;
  isAuthenticated: boolean;
  isLoading: boolean;

  login: (email: string, password: string) => Promise<void>;
  register: (data: RegisterData) => Promise<void>;
  logout: () => void;
  refreshAccessToken: () => Promise<void>;
}

export const useAuthStore = create<AuthState>()(
  persist(
    (set, get) => ({
      user: null,
      accessToken: null,
      refreshToken: null,
      isAuthenticated: false,
      isLoading: false,

      login: async (email, password) => { /* ... */ },
      register: async (data) => { /* ... */ },
      logout: () => { /* ... */ },
      refreshAccessToken: async () => { /* ... */ },
    }),
    {
      name: 'auth-storage',
      partialize: (state) => ({
        accessToken: state.accessToken,
        refreshToken: state.refreshToken,
      }),
    }
  )
);
```

**èŠå¤©çŠ¶æ€ (chatStore.ts)**

```typescript
interface ChatState {
  conversations: Conversation[];
  currentConversationId: string | null;
  messages: Message[];
  isStreaming: boolean;

  // Actions
  createConversation: () => Promise<string>;
  loadConversation: (id: string) => Promise<void>;
  deleteConversation: (id: string) => Promise<void>;
  sendMessage: (content: string, images?: File[]) => Promise<void>;
  stopStreaming: () => void;
  regenerateMessage: (messageId: string) => Promise<void>;
}
```

### 4.2 åç«¯æ¨¡å—è®¾è®¡

#### 4.2.1 Auth Service

```
backend/auth-service/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ main.py                 # FastAPI åº”ç”¨å…¥å£
â”‚   â”œâ”€â”€ config.py               # é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ database.py             # æ•°æ®åº“è¿æ¥
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ user.py             # ç”¨æˆ·æ¨¡å‹
â”‚   â”œâ”€â”€ schemas/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ user.py             # ç”¨æˆ· Schema
â”‚   â”‚   â””â”€â”€ token.py            # Token Schema
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ v1/
â”‚   â”‚       â”œâ”€â”€ __init__.py
â”‚   â”‚       â”œâ”€â”€ auth.py         # è®¤è¯è·¯ç”±
â”‚   â”‚       â””â”€â”€ users.py        # ç”¨æˆ·è·¯ç”±
â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ security.py         # å¯†ç åŠ å¯†ã€Token ç”Ÿæˆ
â”‚   â”‚   â””â”€â”€ deps.py             # ä¾èµ–æ³¨å…¥
â”‚   â””â”€â”€ services/
â”‚       â”œâ”€â”€ __init__.py
â”‚       â””â”€â”€ user_service.py     # ç”¨æˆ·ä¸šåŠ¡é€»è¾‘
â”œâ”€â”€ requirements.txt
â””â”€â”€ Dockerfile
```

**æ ¸å¿ƒæ¥å£:**

```python
# app/api/v1/auth.py

@router.post("/register", response_model=UserResponse)
async def register(user_data: UserCreate, db: Session = Depends(get_db)):
    """ç”¨æˆ·æ³¨å†Œ"""
    pass

@router.post("/login", response_model=TokenResponse)
async def login(form_data: OAuth2PasswordRequestForm = Depends()):
    """ç”¨æˆ·ç™»å½•"""
    pass

@router.post("/refresh", response_model=TokenResponse)
async def refresh_token(refresh_token: str):
    """åˆ·æ–° Access Token"""
    pass

@router.post("/logout")
async def logout(current_user: User = Depends(get_current_user)):
    """ç”¨æˆ·ç™»å‡º"""
    pass
```

#### 4.2.2 Chat Service (ç°æœ‰æ”¹é€ )

```
backend/chat-service/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ main.py                 # FastAPI å…¥å£ (åŸ backend/main.py)
â”‚   â”œâ”€â”€ config.py
â”‚   â”œâ”€â”€ agent_service.py        # Agent æ ¸å¿ƒ (ä¿æŒ)
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”œâ”€â”€ conversation.py     # ä¼šè¯æ¨¡å‹
â”‚   â”‚   â””â”€â”€ message.py          # æ¶ˆæ¯æ¨¡å‹
â”‚   â”œâ”€â”€ schemas/
â”‚   â”‚   â”œâ”€â”€ chat.py
â”‚   â”‚   â””â”€â”€ tool.py
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â””â”€â”€ v1/
â”‚   â”‚       â”œâ”€â”€ chat.py         # èŠå¤©è·¯ç”±
â”‚   â”‚       â”œâ”€â”€ conversation.py # ä¼šè¯ç®¡ç†
â”‚   â”‚       â””â”€â”€ upload.py       # æ–‡ä»¶ä¸Šä¼ 
â”‚   â””â”€â”€ tools/                  # å·¥å…·é›† (ä¿æŒ)
â”‚       â”œâ”€â”€ e2b_tools.py
â”‚       â”œâ”€â”€ rag_tools.py
â”‚       â””â”€â”€ search_tools.py
â”œâ”€â”€ requirements.txt
â””â”€â”€ Dockerfile
```

**èŠå¤© API æ”¹é€ :**

```python
# app/api/v1/chat.py

@router.post("/stream")
async def chat_stream(
    request: ChatRequest,
    current_user: User = Depends(get_current_user)
):
    """æµå¼èŠå¤© (éœ€è¦è®¤è¯)"""
    return StreamingResponse(
        generate_stream(request, current_user),
        media_type="text/event-stream"
    )

@router.get("/conversations")
async def list_conversations(
    current_user: User = Depends(get_current_user),
    skip: int = 0,
    limit: int = 20
):
    """è·å–ç”¨æˆ·ä¼šè¯åˆ—è¡¨"""
    pass

@router.post("/conversations")
async def create_conversation(
    current_user: User = Depends(get_current_user)
):
    """åˆ›å»ºæ–°ä¼šè¯"""
    pass

@router.delete("/conversations/{conversation_id}")
async def delete_conversation(
    conversation_id: str,
    current_user: User = Depends(get_current_user)
):
    """åˆ é™¤ä¼šè¯"""
    pass
```

#### 4.2.3 RAG Service

```
backend/rag-service/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ main.py
â”‚   â”œâ”€â”€ config.py
â”‚   â”œâ”€â”€ milvus_client.py        # Milvus å®¢æˆ·ç«¯
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”œâ”€â”€ document.py
â”‚   â”‚   â””â”€â”€ chunk.py
â”‚   â”œâ”€â”€ schemas/
â”‚   â”‚   â”œâ”€â”€ document.py
â”‚   â”‚   â””â”€â”€ search.py
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â””â”€â”€ v1/
â”‚   â”‚       â”œâ”€â”€ documents.py    # æ–‡æ¡£ç®¡ç†
â”‚   â”‚       â”œâ”€â”€ search.py       # æ£€ç´¢æ¥å£
â”‚   â”‚       â””â”€â”€ ingest.py       # æ–‡æ¡£æ‘„å–
â”‚   â””â”€â”€ services/
â”‚       â”œâ”€â”€ embedding_service.py
â”‚       â”œâ”€â”€ search_service.py   # æ··åˆæ£€ç´¢
â”‚       â”œâ”€â”€ rerank_service.py   # é‡æ’åº
â”‚       â””â”€â”€ mineru_service.py   # MinerU é›†æˆ
â”œâ”€â”€ requirements.txt
â””â”€â”€ Dockerfile
```

**æ··åˆæ£€ç´¢å®ç°:**

```python
# app/services/search_service.py

class HybridSearchService:
    def __init__(self, milvus_client, bm25_index, reranker):
        self.milvus = milvus_client
        self.bm25 = bm25_index
        self.reranker = reranker

    async def search(
        self,
        query: str,
        top_k: int = 10,
        alpha: float = 0.5,  # å‘é‡æƒé‡
        rerank: bool = True
    ) -> List[SearchResult]:
        """æ··åˆæ£€ç´¢"""
        # 1. å‘é‡æ£€ç´¢
        vector_results = await self.milvus.search(
            query_embedding=self.embed(query),
            top_k=top_k * 2
        )

        # 2. BM25 å…³é”®è¯æ£€ç´¢
        bm25_results = self.bm25.search(query, top_k=top_k * 2)

        # 3. RRF èåˆ
        fused_results = self.rrf_fusion(
            vector_results, bm25_results, alpha=alpha
        )

        # 4. Reranker é‡æ’åº (å¯é€‰)
        if rerank:
            fused_results = await self.reranker.rerank(
                query, fused_results, top_k=top_k
            )

        return fused_results[:top_k]

    def rrf_fusion(self, vec_results, bm25_results, alpha=0.5):
        """Reciprocal Rank Fusion"""
        scores = {}
        k = 60  # RRF å¸¸æ•°

        for rank, doc in enumerate(vec_results):
            scores[doc.id] = scores.get(doc.id, 0) + alpha / (k + rank)

        for rank, doc in enumerate(bm25_results):
            scores[doc.id] = scores.get(doc.id, 0) + (1-alpha) / (k + rank)

        return sorted(scores.items(), key=lambda x: x[1], reverse=True)
```

#### 4.2.4 Whisper Service

```
backend/whisper-service/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ main.py
â”‚   â”œâ”€â”€ config.py
â”‚   â””â”€â”€ api/
â”‚       â””â”€â”€ v1/
â”‚           â””â”€â”€ transcribe.py
â”œâ”€â”€ requirements.txt
â””â”€â”€ Dockerfile
```

```python
# app/api/v1/transcribe.py

from faster_whisper import WhisperModel

model = WhisperModel("base", device="cpu", compute_type="int8")

@router.post("/transcribe")
async def transcribe_audio(
    file: UploadFile = File(...),
    language: str = "zh"
):
    """è¯­éŸ³è½¬æ–‡å­—"""
    audio_bytes = await file.read()
    segments, info = model.transcribe(
        audio_bytes,
        language=language,
        beam_size=5
    )

    text = "".join([segment.text for segment in segments])
    return {"text": text, "language": info.language}
```

### 4.3 å¤šæ¨¡æ€å¤„ç†æµç¨‹

#### 4.3.1 å›¾ç‰‡ç†è§£æµç¨‹

```
ç”¨æˆ·ä¸Šä¼ å›¾ç‰‡
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‰ç«¯é¢„å¤„ç†      â”‚
â”‚ - å‹ç¼©å›¾ç‰‡      â”‚
â”‚ - è½¬ Base64     â”‚
â”‚ - é¢„è§ˆæ˜¾ç¤º      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‘é€åˆ°åç«¯      â”‚
â”‚ POST /chat/streamâ”‚
â”‚ {               â”‚
â”‚   content: "...",â”‚
â”‚   images: [...]  â”‚
â”‚ }               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Agent Service                        â”‚
â”‚ 1. æ„å»ºå¤šæ¨¡æ€æ¶ˆæ¯                    â”‚
â”‚ 2. è°ƒç”¨ Gemini Vision API            â”‚
â”‚    - å›¾ç‰‡åˆ†æ                        â”‚
â”‚    - ç»“åˆæ–‡æœ¬ prompt                 â”‚
â”‚ 3. æµå¼è¿”å›ç»“æœ                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å¤šæ¨¡æ€æ¶ˆæ¯æ„å»º:**

```python
# agent_service.py

def build_multimodal_message(content: str, images: List[str]) -> dict:
    """æ„å»ºå¤šæ¨¡æ€æ¶ˆæ¯"""
    parts = []

    # æ·»åŠ å›¾ç‰‡
    for img_base64 in images:
        parts.append({
            "type": "image_url",
            "image_url": {
                "url": f"data:image/jpeg;base64,{img_base64}"
            }
        })

    # æ·»åŠ æ–‡æœ¬
    parts.append({
        "type": "text",
        "text": content
    })

    return {"role": "user", "content": parts}
```

#### 4.3.2 è¯­éŸ³äº¤äº’æµç¨‹

```
                        è¯­éŸ³è¾“å…¥æµç¨‹
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·ç‚¹å‡»å½•éŸ³                                                   â”‚
â”‚      â”‚                                                        â”‚
â”‚      â–¼                                                        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                          â”‚
â”‚ â”‚ æµè§ˆå™¨å½•éŸ³ API   â”‚                                          â”‚
â”‚ â”‚ MediaRecorder   â”‚                                          â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                          â”‚
â”‚          â”‚ å½•éŸ³ç»“æŸ                                            â”‚
â”‚          â–¼                                                    â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     POST /api/whisper/transcribe         â”‚
â”‚ â”‚ ä¸Šä¼ éŸ³é¢‘æ–‡ä»¶     â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º    â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                          â”‚
â”‚          â”‚                                                    â”‚
â”‚          â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚          â”‚   â”‚ Whisper Service                            â”‚  â”‚
â”‚          â”‚   â”‚ - faster-whisper è¯†åˆ«                      â”‚  â”‚
â”‚          â”‚   â”‚ - è¿”å›æ–‡å­—                                  â”‚  â”‚
â”‚          â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚          â”‚                                                    â”‚
â”‚          â–¼                                                    â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                          â”‚
â”‚ â”‚ å¡«å…¥è¾“å…¥æ¡†       â”‚                                          â”‚
â”‚ â”‚ (å¯ç¼–è¾‘ç¡®è®¤)     â”‚                                          â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                        è¯­éŸ³è¾“å‡ºæµç¨‹
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AI å›å¤å®Œæˆ                                                    â”‚
â”‚      â”‚                                                        â”‚
â”‚      â–¼                                                        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     POST /api/tts/synthesize              â”‚
â”‚ â”‚ è¯·æ±‚è¯­éŸ³åˆæˆ     â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º    â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                          â”‚
â”‚          â”‚                                                    â”‚
â”‚          â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚          â”‚   â”‚ TTS Service (Edge TTS)                     â”‚  â”‚
â”‚          â”‚   â”‚ - æ–‡å­—è½¬è¯­éŸ³                                â”‚  â”‚
â”‚          â”‚   â”‚ - è¿”å›éŸ³é¢‘æµ                                â”‚  â”‚
â”‚          â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚          â”‚                                                    â”‚
â”‚          â–¼                                                    â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                          â”‚
â”‚ â”‚ Audio æ’­æ”¾å™¨     â”‚                                          â”‚
â”‚ â”‚ - æ’­æ”¾/æš‚åœ     â”‚                                          â”‚
â”‚ â”‚ - è¿›åº¦æ¡        â”‚                                          â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## äº”ã€æ•°æ®åº“è®¾è®¡

### 5.1 PostgreSQL Schema

```sql
-- ç”¨æˆ·è¡¨
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    is_active BOOLEAN DEFAULT TRUE,
    is_verified BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ç”¨æˆ·è®¾ç½®è¡¨
CREATE TABLE user_settings (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    theme VARCHAR(20) DEFAULT 'system',
    language VARCHAR(10) DEFAULT 'zh-CN',
    voice_enabled BOOLEAN DEFAULT FALSE,
    default_model VARCHAR(50) DEFAULT 'gemini-2.0-flash-lite',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- API Key è¡¨
CREATE TABLE api_keys (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    key_name VARCHAR(100) NOT NULL,
    key_type VARCHAR(50) NOT NULL,  -- 'google', 'e2b', 'openai', etc.
    encrypted_value TEXT NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE(user_id, key_type)
);

-- ä¼šè¯è¡¨
CREATE TABLE conversations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    title VARCHAR(255) DEFAULT 'New Chat',
    model VARCHAR(50),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- æ¶ˆæ¯è¡¨
CREATE TABLE messages (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    conversation_id UUID REFERENCES conversations(id) ON DELETE CASCADE,
    role VARCHAR(20) NOT NULL,  -- 'user', 'assistant', 'system'
    content TEXT NOT NULL,
    images JSONB,               -- å›¾ç‰‡ URL/Base64 æ•°ç»„
    tool_calls JSONB,           -- å·¥å…·è°ƒç”¨è®°å½•
    citations JSONB,            -- å¼•ç”¨æ¥æº
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- æ–‡æ¡£è¡¨ (RAG)
CREATE TABLE documents (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    filename VARCHAR(255) NOT NULL,
    file_type VARCHAR(50),
    file_size INTEGER,
    milvus_collection VARCHAR(100),
    chunk_count INTEGER DEFAULT 0,
    status VARCHAR(20) DEFAULT 'pending',  -- 'pending', 'processing', 'ready', 'error'
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Refresh Token è¡¨
CREATE TABLE refresh_tokens (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    token_hash VARCHAR(255) NOT NULL,
    expires_at TIMESTAMP WITH TIME ZONE NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ç´¢å¼•
CREATE INDEX idx_conversations_user_id ON conversations(user_id);
CREATE INDEX idx_messages_conversation_id ON messages(conversation_id);
CREATE INDEX idx_documents_user_id ON documents(user_id);
CREATE INDEX idx_refresh_tokens_user_id ON refresh_tokens(user_id);
```

### 5.2 Milvus Schema

```python
# Collection: document_chunks

from pymilvus import CollectionSchema, FieldSchema, DataType

fields = [
    FieldSchema(name="id", dtype=DataType.VARCHAR, is_primary=True, max_length=36),
    FieldSchema(name="document_id", dtype=DataType.VARCHAR, max_length=36),
    FieldSchema(name="user_id", dtype=DataType.VARCHAR, max_length=36),
    FieldSchema(name="chunk_index", dtype=DataType.INT64),
    FieldSchema(name="content", dtype=DataType.VARCHAR, max_length=65535),
    FieldSchema(name="page_number", dtype=DataType.INT64),
    FieldSchema(name="embedding", dtype=DataType.FLOAT_VECTOR, dim=384),  # all-MiniLM-L6-v2
    FieldSchema(name="metadata", dtype=DataType.JSON),
]

schema = CollectionSchema(
    fields=fields,
    description="Document chunks for RAG"
)

# Index
index_params = {
    "metric_type": "IP",  # Inner Product (cosine similarity)
    "index_type": "IVF_FLAT",
    "params": {"nlist": 1024}
}
```

### 5.3 Redis æ•°æ®ç»“æ„

```
# Session å­˜å‚¨
session:{user_id} -> Hash
  - access_token: string
  - refresh_token: string
  - created_at: timestamp
  - last_active: timestamp

# Rate Limiting
rate_limit:{user_id}:{endpoint} -> Counter
  - expire: 60s

# Token é»‘åå•
blacklist:{token_hash} -> Set
  - expire: token å‰©ä½™æœ‰æ•ˆæœŸ
```

---

## å…­ã€API æ¥å£è®¾è®¡

### 6.1 è®¤è¯æ¥å£

| æ–¹æ³• | è·¯å¾„ | æè¿° | è®¤è¯ |
|------|------|------|------|
| POST | /api/auth/register | ç”¨æˆ·æ³¨å†Œ | å¦ |
| POST | /api/auth/login | ç”¨æˆ·ç™»å½• | å¦ |
| POST | /api/auth/refresh | åˆ·æ–° Token | å¦ |
| POST | /api/auth/logout | ç”¨æˆ·ç™»å‡º | æ˜¯ |
| GET | /api/auth/me | è·å–å½“å‰ç”¨æˆ· | æ˜¯ |
| PUT | /api/auth/password | ä¿®æ”¹å¯†ç  | æ˜¯ |

**è¯·æ±‚/å“åº”ç¤ºä¾‹:**

```yaml
# POST /api/auth/register
Request:
  {
    "username": "john_doe",
    "email": "john@example.com",
    "password": "SecurePass123!"
  }

Response: 201
  {
    "id": "uuid",
    "username": "john_doe",
    "email": "john@example.com",
    "created_at": "2025-12-31T00:00:00Z"
  }

# POST /api/auth/login
Request:
  {
    "email": "john@example.com",
    "password": "SecurePass123!"
  }

Response: 200
  {
    "access_token": "eyJhbGciOiJIUzI1NiIs...",
    "refresh_token": "eyJhbGciOiJIUzI1NiIs...",
    "token_type": "bearer",
    "expires_in": 3600
  }
```

### 6.2 èŠå¤©æ¥å£

| æ–¹æ³• | è·¯å¾„ | æè¿° | è®¤è¯ |
|------|------|------|------|
| GET | /api/conversations | è·å–ä¼šè¯åˆ—è¡¨ | æ˜¯ |
| POST | /api/conversations | åˆ›å»ºä¼šè¯ | æ˜¯ |
| GET | /api/conversations/{id} | è·å–ä¼šè¯è¯¦æƒ… | æ˜¯ |
| PUT | /api/conversations/{id} | æ›´æ–°ä¼šè¯ | æ˜¯ |
| DELETE | /api/conversations/{id} | åˆ é™¤ä¼šè¯ | æ˜¯ |
| GET | /api/conversations/{id}/messages | è·å–æ¶ˆæ¯åˆ—è¡¨ | æ˜¯ |
| POST | /api/chat/stream | æµå¼èŠå¤© | æ˜¯ |
| POST | /api/chat/stop | åœæ­¢ç”Ÿæˆ | æ˜¯ |

**æµå¼èŠå¤©è¯·æ±‚:**

```yaml
# POST /api/chat/stream
Request:
  {
    "conversation_id": "uuid",
    "content": "åˆ†æè¿™å¼ å›¾ç‰‡",
    "images": ["base64..."],  # å¯é€‰
    "api_keys": {             # å¯é€‰ï¼Œè¦†ç›–ç”¨æˆ·é»˜è®¤é…ç½®
      "GOOGLE_API_KEY": "..."
    }
  }

Response: SSE Stream
  event: text
  data: {"content": "è¿™æ˜¯ä¸€å¼ ..."}

  event: tool_start
  data: {"tool_name": "search_engine", "tool_id": "xxx"}

  event: tool_end
  data: {"tool_id": "xxx", "output": "...", "duration": 1.5}

  event: citation
  data: {"source": "doc.pdf", "page": 5, "content": "..."}

  event: done
  data: {"message_id": "uuid", "total_tokens": 1500}
```

### 6.3 RAG æ¥å£

| æ–¹æ³• | è·¯å¾„ | æè¿° | è®¤è¯ |
|------|------|------|------|
| GET | /api/documents | è·å–æ–‡æ¡£åˆ—è¡¨ | æ˜¯ |
| POST | /api/documents/upload | ä¸Šä¼ æ–‡æ¡£ | æ˜¯ |
| DELETE | /api/documents/{id} | åˆ é™¤æ–‡æ¡£ | æ˜¯ |
| GET | /api/documents/{id}/status | è·å–å¤„ç†çŠ¶æ€ | æ˜¯ |
| POST | /api/search | æ£€ç´¢æ–‡æ¡£ | æ˜¯ |

**æ–‡æ¡£ä¸Šä¼ :**

```yaml
# POST /api/documents/upload
Request: multipart/form-data
  - file: binary
  - parse_method: "mineru" | "default"

Response: 202
  {
    "document_id": "uuid",
    "filename": "report.pdf",
    "status": "processing",
    "estimated_time": 30
  }
```

### 6.4 è¯­éŸ³æ¥å£

| æ–¹æ³• | è·¯å¾„ | æè¿° | è®¤è¯ |
|------|------|------|------|
| POST | /api/voice/transcribe | è¯­éŸ³è½¬æ–‡å­— | æ˜¯ |
| POST | /api/voice/synthesize | æ–‡å­—è½¬è¯­éŸ³ | æ˜¯ |

```yaml
# POST /api/voice/transcribe
Request: multipart/form-data
  - audio: binary (wav/mp3/webm)
  - language: "zh" | "en" | "auto"

Response: 200
  {
    "text": "è¯†åˆ«çš„æ–‡å­—å†…å®¹",
    "language": "zh",
    "confidence": 0.95
  }

# POST /api/voice/synthesize
Request:
  {
    "text": "è¦è½¬æ¢çš„æ–‡å­—",
    "voice": "zh-CN-XiaoxiaoNeural",
    "rate": 1.0,
    "pitch": 0
  }

Response: audio/mpeg (binary stream)
```

### 6.5 ç”¨æˆ·è®¾ç½®æ¥å£

| æ–¹æ³• | è·¯å¾„ | æè¿° | è®¤è¯ |
|------|------|------|------|
| GET | /api/settings | è·å–ç”¨æˆ·è®¾ç½® | æ˜¯ |
| PUT | /api/settings | æ›´æ–°ç”¨æˆ·è®¾ç½® | æ˜¯ |
| GET | /api/settings/api-keys | è·å– API Key åˆ—è¡¨ | æ˜¯ |
| POST | /api/settings/api-keys | æ·»åŠ  API Key | æ˜¯ |
| DELETE | /api/settings/api-keys/{type} | åˆ é™¤ API Key | æ˜¯ |

---

## ä¸ƒã€å‰ç«¯é¡µé¢è®¾è®¡

### 7.1 é¡µé¢ç»“æ„

```
/                           â†’ é‡å®šå‘åˆ° /chat
/login                      â†’ ç™»å½•é¡µ
/register                   â†’ æ³¨å†Œé¡µ
/chat                       â†’ æ–°ä¼šè¯ï¼ˆä¸»é¡µé¢ï¼‰
/chat/[id]                  â†’ æŒ‡å®šä¼šè¯
/settings                   â†’ ç”¨æˆ·è®¾ç½®
/settings/api-keys          â†’ API Key ç®¡ç†
/settings/profile           â†’ ä¸ªäººèµ„æ–™
```

### 7.2 ä¸»é¡µé¢å¸ƒå±€ (Desktop)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           Header                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ ğŸ¤– Stream-Agent  â”‚                         â”‚ ğŸ‘¤ User â–¼         â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚â”‚                  â”‚ â”‚                                              â”‚â”‚
â”‚â”‚   Sidebar        â”‚ â”‚              Chat Area                       â”‚â”‚
â”‚â”‚                  â”‚ â”‚                                              â”‚â”‚
â”‚â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚â”‚
â”‚â”‚  â”‚ + New Chat  â”‚ â”‚ â”‚  â”‚                                          â”‚â”‚â”‚
â”‚â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚  â”‚         Message List                     â”‚â”‚â”‚
â”‚â”‚                  â”‚ â”‚  â”‚                                          â”‚â”‚â”‚
â”‚â”‚  Search...       â”‚ â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚â”‚â”‚
â”‚â”‚                  â”‚ â”‚  â”‚  â”‚ ğŸ‘¤ User: ä½ å¥½                      â”‚  â”‚â”‚â”‚
â”‚â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚â”‚â”‚
â”‚â”‚  â”‚ Today       â”‚ â”‚ â”‚  â”‚                                          â”‚â”‚â”‚
â”‚â”‚  â”‚ - Chat 1    â”‚ â”‚ â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚â”‚â”‚
â”‚â”‚  â”‚ - Chat 2    â”‚ â”‚ â”‚  â”‚  â”‚ ğŸ¤– AI: ä½ å¥½ï¼æœ‰ä»€ä¹ˆ...            â”‚  â”‚â”‚â”‚
â”‚â”‚  â”‚             â”‚ â”‚ â”‚  â”‚  â”‚                                    â”‚  â”‚â”‚â”‚
â”‚â”‚  â”‚ Yesterday   â”‚ â”‚ â”‚  â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚  â”‚â”‚â”‚
â”‚â”‚  â”‚ - Chat 3    â”‚ â”‚ â”‚  â”‚  â”‚ â”‚ ğŸ”§ Tool: search_engine        â”‚â”‚  â”‚â”‚â”‚
â”‚â”‚  â”‚             â”‚ â”‚ â”‚  â”‚  â”‚ â”‚    Status: âœ…                 â”‚â”‚  â”‚â”‚â”‚
â”‚â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚  â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚  â”‚â”‚â”‚
â”‚â”‚                  â”‚ â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚â”‚â”‚
â”‚â”‚                  â”‚ â”‚  â”‚                                          â”‚â”‚â”‚
â”‚â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚â”‚
â”‚â”‚  â”‚ âš™ï¸ Settings â”‚ â”‚ â”‚                                              â”‚â”‚
â”‚â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚â”‚
â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚              Input Area                   â”‚â”‚â”‚
â”‚                     â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â” â”‚â”‚â”‚
â”‚                     â”‚  â”‚ â”‚ ğŸ“   â”‚ â”‚ Message...        â”‚ â”‚ ğŸ¤ â¤ â”‚ â”‚â”‚â”‚
â”‚                     â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚â”‚â”‚
â”‚                     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚â”‚
â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.3 ç§»åŠ¨ç«¯å¸ƒå±€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â˜°   Stream-Agent   ğŸ‘¤   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                         â”‚
â”‚    Message List         â”‚
â”‚                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ğŸ‘¤ ä½ å¥½           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ğŸ¤– ä½ å¥½ï¼æœ‰ä»€ä¹ˆ...â”‚  â”‚
â”‚  â”‚                   â”‚  â”‚
â”‚  â”‚ [ğŸ”§ Tool â–¼]      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ“ â”‚ Message...    â”‚ğŸ¤â¤â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.4 ç»„ä»¶æ ·å¼è§„èŒƒ

**é¢œè‰²ç³»ç»Ÿ (shadcn/ui + Tailwind):**

```css
/* globals.css */
@layer base {
  :root {
    --background: 0 0% 100%;
    --foreground: 222.2 84% 4.9%;
    --card: 0 0% 100%;
    --card-foreground: 222.2 84% 4.9%;
    --primary: 221.2 83.2% 53.3%;
    --primary-foreground: 210 40% 98%;
    --secondary: 210 40% 96.1%;
    --muted: 210 40% 96.1%;
    --accent: 210 40% 96.1%;
    --destructive: 0 84.2% 60.2%;
    --border: 214.3 31.8% 91.4%;
    --ring: 221.2 83.2% 53.3%;
  }

  .dark {
    --background: 222.2 84% 4.9%;
    --foreground: 210 40% 98%;
    --card: 222.2 84% 4.9%;
    --card-foreground: 210 40% 98%;
    --primary: 217.2 91.2% 59.8%;
    --secondary: 217.2 32.6% 17.5%;
    --muted: 217.2 32.6% 17.5%;
    --accent: 217.2 32.6% 17.5%;
    --destructive: 0 62.8% 30.6%;
    --border: 217.2 32.6% 17.5%;
  }
}
```

**æ¶ˆæ¯æ°”æ³¡æ ·å¼:**

```typescript
// ç”¨æˆ·æ¶ˆæ¯
<div className="flex justify-end">
  <div className="max-w-[80%] rounded-2xl bg-primary text-primary-foreground px-4 py-2">
    {content}
  </div>
</div>

// AI æ¶ˆæ¯
<div className="flex justify-start">
  <div className="max-w-[80%] rounded-2xl bg-muted px-4 py-2">
    {content}
  </div>
</div>
```

---

## å…«ã€éƒ¨ç½²æ¶æ„

### 8.1 Docker Compose é…ç½®

```yaml
# docker-compose.yml

version: '3.8'

services:
  # ========== Frontend ==========
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_API_URL=http://nginx/api
    depends_on:
      - nginx
    networks:
      - app-network

  # ========== API Gateway ==========
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      - auth-service
      - chat-service
      - rag-service
      - whisper-service
    networks:
      - app-network

  # ========== Auth Service ==========
  auth-service:
    build:
      context: ./backend/auth-service
      dockerfile: Dockerfile
    environment:
      - DATABASE_URL=postgresql://postgres:password@postgres:5432/streamagent
      - REDIS_URL=redis://redis:6379/0
      - JWT_SECRET=${JWT_SECRET}
      - JWT_ALGORITHM=HS256
      - ACCESS_TOKEN_EXPIRE_MINUTES=60
      - REFRESH_TOKEN_EXPIRE_DAYS=7
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - app-network

  # ========== Chat Service ==========
  chat-service:
    build:
      context: ./backend/chat-service
      dockerfile: Dockerfile
    environment:
      - DATABASE_URL=postgresql://postgres:password@postgres:5432/streamagent
      - REDIS_URL=redis://redis:6379/0
      - MILVUS_HOST=milvus
      - MILVUS_PORT=19530
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      - E2B_API_KEY=${E2B_API_KEY}
      - BRIGHT_DATA_API_KEY=${BRIGHT_DATA_API_KEY}
    depends_on:
      - postgres
      - redis
      - milvus
    networks:
      - app-network

  # ========== RAG Service ==========
  rag-service:
    build:
      context: ./backend/rag-service
      dockerfile: Dockerfile
    environment:
      - DATABASE_URL=postgresql://postgres:password@postgres:5432/streamagent
      - MILVUS_HOST=milvus
      - MILVUS_PORT=19530
      - MINIO_ENDPOINT=minio:9000
      - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY}
      - MINIO_SECRET_KEY=${MINIO_SECRET_KEY}
      - MINERU_API_KEY=${MINERU_API_KEY}
    depends_on:
      - postgres
      - milvus
      - minio
    networks:
      - app-network

  # ========== Whisper Service ==========
  whisper-service:
    build:
      context: ./backend/whisper-service
      dockerfile: Dockerfile
    environment:
      - WHISPER_MODEL=base
      - DEVICE=cpu
    networks:
      - app-network

  # ========== Databases ==========
  postgres:
    image: postgres:15-alpine
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=streamagent
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - app-network

  redis:
    image: redis:7-alpine
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - app-network

  milvus:
    image: milvusdb/milvus:v2.3.4
    environment:
      - ETCD_ENDPOINTS=etcd:2379
      - MINIO_ADDRESS=minio:9000
    depends_on:
      - etcd
      - minio
    ports:
      - "19530:19530"
    volumes:
      - milvus_data:/var/lib/milvus
    networks:
      - app-network

  etcd:
    image: quay.io/coreos/etcd:v3.5.5
    environment:
      - ETCD_AUTO_COMPACTION_MODE=revision
      - ETCD_AUTO_COMPACTION_RETENTION=1000
      - ETCD_QUOTA_BACKEND_BYTES=4294967296
    volumes:
      - etcd_data:/etcd
    command: etcd -advertise-client-urls=http://127.0.0.1:2379 -listen-client-urls http://0.0.0.0:2379 --data-dir /etcd
    networks:
      - app-network

  minio:
    image: minio/minio:latest
    environment:
      - MINIO_ROOT_USER=${MINIO_ACCESS_KEY}
      - MINIO_ROOT_PASSWORD=${MINIO_SECRET_KEY}
    volumes:
      - minio_data:/data
    command: server /data --console-address ":9001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3
    networks:
      - app-network

networks:
  app-network:
    driver: bridge

volumes:
  postgres_data:
  redis_data:
  milvus_data:
  etcd_data:
  minio_data:
```

### 8.2 Nginx é…ç½®

```nginx
# nginx/nginx.conf

upstream auth_service {
    server auth-service:8001;
}

upstream chat_service {
    server chat-service:8002;
}

upstream rag_service {
    server rag-service:8004;
}

upstream whisper_service {
    server whisper-service:8003;
}

server {
    listen 80;
    server_name localhost;

    # API è·¯ç”±
    location /api/auth {
        proxy_pass http://auth_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    location /api/chat {
        proxy_pass http://chat_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        # SSE æ”¯æŒ
        proxy_buffering off;
        proxy_cache off;
        proxy_set_header Connection '';
        proxy_http_version 1.1;
        chunked_transfer_encoding off;
    }

    location /api/conversations {
        proxy_pass http://chat_service;
        proxy_set_header Host $host;
    }

    location /api/documents {
        proxy_pass http://rag_service;
        proxy_set_header Host $host;
        client_max_body_size 100M;
    }

    location /api/search {
        proxy_pass http://rag_service;
        proxy_set_header Host $host;
    }

    location /api/voice {
        proxy_pass http://whisper_service;
        proxy_set_header Host $host;
        client_max_body_size 50M;
    }

    location /api/settings {
        proxy_pass http://auth_service;
        proxy_set_header Host $host;
    }

    # å¥åº·æ£€æŸ¥
    location /health {
        return 200 'OK';
        add_header Content-Type text/plain;
    }
}
```

### 8.3 ç¯å¢ƒå˜é‡é…ç½®

```bash
# .env

# ========== Database ==========
POSTGRES_PASSWORD=your_secure_password
DATABASE_URL=postgresql://postgres:your_secure_password@postgres:5432/streamagent

# ========== Redis ==========
REDIS_URL=redis://redis:6379/0

# ========== JWT ==========
JWT_SECRET=your_jwt_secret_key_at_least_32_chars
JWT_ALGORITHM=HS256

# ========== MinIO ==========
MINIO_ACCESS_KEY=minioadmin
MINIO_SECRET_KEY=minioadmin

# ========== External APIs ==========
GOOGLE_API_KEY=your_google_api_key
E2B_API_KEY=your_e2b_api_key
BRIGHT_DATA_API_KEY=your_bright_data_key
MINERU_API_KEY=your_mineru_api_key

# ========== TTS ==========
EDGE_TTS_VOICE=zh-CN-XiaoxiaoNeural
```

### 8.4 éƒ¨ç½²æµç¨‹

```bash
# 1. å…‹éš†é¡¹ç›®
git clone <repo_url>
cd My-Chat-LangChain

# 2. é…ç½®ç¯å¢ƒå˜é‡
cp .env.example .env
# ç¼–è¾‘ .env å¡«å…¥å¿…è¦çš„ API Key

# 3. æ„å»ºå¹¶å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker-compose up -d --build

# 4. æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker-compose ps

# 5. æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f

# 6. åœæ­¢æœåŠ¡
docker-compose down

# 7. æ¸…ç†æ•°æ® (è°¨æ…)
docker-compose down -v
```

### 8.5 Render + Supabase äº‘éƒ¨ç½²æ–¹æ¡ˆ (æ¨è)

> é€‚ç”¨äºå¿«é€Ÿéƒ¨ç½²ã€ä½è¿ç»´æˆæœ¬çš„åœºæ™¯ã€‚ä½¿ç”¨ Supabase çš„ pgvector æ‰©å±•æ›¿ä»£ Milvusã€‚

#### 8.5.1 æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Render + Supabase äº‘éƒ¨ç½²æ¶æ„                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  Render (è®¡ç®—å±‚)                         Supabase (æ•°æ®å±‚)              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ frontend-next       â”‚                â”‚ PostgreSQL + pgvector   â”‚    â”‚
â”‚  â”‚ (Web Service)       â”‚                â”‚                         â”‚    â”‚
â”‚  â”‚ - Next.js 14        â”‚                â”‚ Tables:                 â”‚    â”‚
â”‚  â”‚ - é™æ€èµ„æº          â”‚                â”‚ - users                 â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚ - conversations         â”‚    â”‚
â”‚             â”‚                           â”‚ - messages              â”‚    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚ - documents             â”‚    â”‚
â”‚  â”‚ auth-service        â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ - document_chunks       â”‚    â”‚
â”‚  â”‚ (Web Service)       â”‚                â”‚   (embedding vector)    â”‚    â”‚
â”‚  â”‚ - ç«¯å£ 8001         â”‚                â”‚                         â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚             â”‚                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ chat-service        â”‚                â”‚ Supabase Storage        â”‚    â”‚
â”‚  â”‚ (Web Service)       â”‚                â”‚ (å¯é€‰)                  â”‚    â”‚
â”‚  â”‚ - ç«¯å£ 8002         â”‚                â”‚ - PDF/æ–‡æ¡£å­˜å‚¨          â”‚    â”‚
â”‚  â”‚ - LangGraph Agent   â”‚                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                               â”‚
â”‚             â”‚                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                               â”‚
â”‚  â”‚ rag-service         â”‚                                               â”‚
â”‚  â”‚ (Web Service)       â”‚                                               â”‚
â”‚  â”‚ - ç«¯å£ 8004         â”‚                                               â”‚
â”‚  â”‚ - pgvector æ£€ç´¢     â”‚                                               â”‚
â”‚  â”‚ - BM25 æ··åˆæ£€ç´¢     â”‚                                               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                               â”‚
â”‚             â”‚                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                               â”‚
â”‚  â”‚ whisper-service     â”‚  (å¯é€‰: æˆ–ä½¿ç”¨ OpenAI Whisper API)            â”‚
â”‚  â”‚ (Web Service)       â”‚                                               â”‚
â”‚  â”‚ - ç«¯å£ 8003         â”‚                                               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                               â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 8.5.2 æœåŠ¡é…ç½®

| æœåŠ¡ | Render ç±»å‹ | é…ç½®å»ºè®® | ç¯å¢ƒå˜é‡ |
|------|------------|---------|---------|
| **frontend-next** | Web Service | Starter ($7/æœˆ) æˆ– Free | `NEXT_PUBLIC_API_URL` |
| **auth-service** | Web Service | Starter | `DATABASE_URL`, `JWT_SECRET` |
| **chat-service** | Web Service | Standard ($25/æœˆ) | `DATABASE_URL`, `GOOGLE_API_KEY`, `E2B_API_KEY` |
| **rag-service** | Web Service | Standard | `DATABASE_URL`, `EMBEDDING_MODEL` |
| **whisper-service** | Web Service | Standard (éœ€è¦å†…å­˜) | `WHISPER_MODEL` |

#### 8.5.3 Supabase é…ç½®

**1. å¯ç”¨ pgvector æ‰©å±•**

```sql
-- åœ¨ Supabase SQL Editor ä¸­æ‰§è¡Œ
CREATE EXTENSION IF NOT EXISTS vector;
```

**2. åˆ›å»ºå‘é‡è¡¨**

```sql
-- document_chunks è¡¨ (æ›¿ä»£ Milvus)
CREATE TABLE document_chunks (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    document_id UUID REFERENCES documents(id) ON DELETE CASCADE,
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    chunk_index INTEGER NOT NULL,
    content TEXT NOT NULL,
    page_number INTEGER,
    section VARCHAR(255),
    embedding vector(384),  -- all-MiniLM-L6-v2 ç»´åº¦
    metadata JSONB DEFAULT '{}',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- åˆ›å»ºå‘é‡ç´¢å¼• (IVFFlat)
CREATE INDEX ON document_chunks
USING ivfflat (embedding vector_cosine_ops)
WITH (lists = 100);

-- åˆ›å»ºç”¨æˆ·éš”ç¦»ç´¢å¼•
CREATE INDEX idx_chunks_user_id ON document_chunks(user_id);
CREATE INDEX idx_chunks_document_id ON document_chunks(document_id);
```

**3. å‘é‡æœç´¢å‡½æ•°**

```sql
-- ç›¸ä¼¼åº¦æœç´¢å‡½æ•°
CREATE OR REPLACE FUNCTION search_documents(
    query_embedding vector(384),
    match_user_id UUID,
    match_count INT DEFAULT 10
)
RETURNS TABLE (
    id UUID,
    document_id UUID,
    content TEXT,
    page_number INTEGER,
    section VARCHAR,
    similarity FLOAT
)
LANGUAGE plpgsql
AS $$
BEGIN
    RETURN QUERY
    SELECT
        dc.id,
        dc.document_id,
        dc.content,
        dc.page_number,
        dc.section,
        1 - (dc.embedding <=> query_embedding) AS similarity
    FROM document_chunks dc
    WHERE dc.user_id = match_user_id
    ORDER BY dc.embedding <=> query_embedding
    LIMIT match_count;
END;
$$;
```

#### 8.5.4 rag-service æ”¹é€ 

éœ€è¦æ–°å¢ `PgvectorService` æ›¿ä»£ `MilvusService`:

```python
# app/services/pgvector_service.py

from typing import List, Optional
import numpy as np
from sqlalchemy import text
from sqlalchemy.orm import Session

class PgvectorService:
    """
    ä½¿ç”¨ Supabase pgvector çš„å‘é‡æ£€ç´¢æœåŠ¡
    """

    def __init__(self, db: Session):
        self.db = db

    async def insert(self, chunks: List[ChunkData]) -> None:
        """æ’å…¥å‘é‡æ•°æ®"""
        for chunk in chunks:
            embedding_str = f"[{','.join(map(str, chunk.embedding))}]"
            self.db.execute(text("""
                INSERT INTO document_chunks
                (id, document_id, user_id, chunk_index, content, page_number, section, embedding, metadata)
                VALUES (:id, :doc_id, :user_id, :idx, :content, :page, :section, :embedding::vector, :meta)
            """), {
                "id": chunk.id,
                "doc_id": chunk.document_id,
                "user_id": chunk.user_id,
                "idx": chunk.chunk_index,
                "content": chunk.content,
                "page": chunk.page_number,
                "section": chunk.section,
                "embedding": embedding_str,
                "meta": chunk.metadata
            })
        self.db.commit()

    async def search(
        self,
        query_embedding: List[float],
        user_id: str,
        top_k: int = 10
    ) -> List[dict]:
        """å‘é‡ç›¸ä¼¼åº¦æœç´¢"""
        embedding_str = f"[{','.join(map(str, query_embedding))}]"
        result = self.db.execute(text("""
            SELECT id, document_id, content, page_number, section,
                   1 - (embedding <=> :embedding::vector) AS similarity
            FROM document_chunks
            WHERE user_id = :user_id
            ORDER BY embedding <=> :embedding::vector
            LIMIT :top_k
        """), {
            "embedding": embedding_str,
            "user_id": user_id,
            "top_k": top_k
        })
        return [dict(row) for row in result]

    async def delete_by_document(self, document_id: str) -> None:
        """åˆ é™¤æ–‡æ¡£çš„æ‰€æœ‰å‘é‡"""
        self.db.execute(text(
            "DELETE FROM document_chunks WHERE document_id = :doc_id"
        ), {"doc_id": document_id})
        self.db.commit()
```

#### 8.5.5 ç¯å¢ƒå˜é‡é…ç½®

```bash
# Render ç¯å¢ƒå˜é‡

# ========== Supabase ==========
DATABASE_URL=postgresql://postgres.[project-ref]:[password]@aws-0-[region].pooler.supabase.com:6543/postgres
SUPABASE_URL=https://[project-ref].supabase.co
SUPABASE_ANON_KEY=your_supabase_anon_key

# ========== JWT ==========
JWT_SECRET=your_jwt_secret_at_least_32_chars
JWT_ALGORITHM=HS256

# ========== External APIs ==========
GOOGLE_API_KEY=your_google_api_key
E2B_API_KEY=your_e2b_api_key
BRIGHT_DATA_API_KEY=your_bright_data_key

# ========== Embedding ==========
EMBEDDING_MODEL=all-MiniLM-L6-v2

# ========== TTS ==========
EDGE_TTS_VOICE=zh-CN-XiaoxiaoNeural
```

#### 8.5.6 éƒ¨ç½²æ­¥éª¤

```bash
# 1. åˆ›å»º Supabase é¡¹ç›®
#    - è®¿é—® https://supabase.com
#    - åˆ›å»ºæ–°é¡¹ç›®ï¼Œè®°å½•è¿æ¥å­—ç¬¦ä¸²

# 2. åˆå§‹åŒ–æ•°æ®åº“
#    - åœ¨ Supabase SQL Editor æ‰§è¡Œä¸Šè¿° SQL
#    - å¯ç”¨ pgvector æ‰©å±•
#    - åˆ›å»ºè¡¨å’Œç´¢å¼•

# 3. åœ¨ Render åˆ›å»ºæœåŠ¡
#    - è¿æ¥ GitHub ä»“åº“
#    - ä¸ºæ¯ä¸ªå¾®æœåŠ¡åˆ›å»º Web Service
#    - é…ç½®ç¯å¢ƒå˜é‡

# 4. é…ç½®æœåŠ¡é—´é€šä¿¡
#    - ä½¿ç”¨ Render Private Services æˆ–ç¯å¢ƒå˜é‡é…ç½®å†…éƒ¨ URL

# 5. é…ç½®å‰ç«¯
#    - NEXT_PUBLIC_API_URL æŒ‡å‘åç«¯æœåŠ¡ URL
```

#### 8.5.7 æˆæœ¬ä¼°ç®—

| æœåŠ¡ | å…è´¹é¢åº¦ | ä»˜è´¹ä»·æ ¼ |
|------|---------|---------|
| **Supabase** | 500MB æ•°æ®åº“, 1GB å­˜å‚¨ | $25/æœˆ (Pro) |
| **Render** (5ä¸ªæœåŠ¡) | 750å°æ—¶/æœˆ (ä¼šä¼‘çœ ) | ~$50-100/æœˆ |
| **æ€»è®¡** | å¯å…è´¹è¯•ç”¨ | ~$75-125/æœˆ |

#### 8.5.8 pgvector vs Milvus å¯¹æ¯”

| ç‰¹æ€§ | pgvector (Supabase) | Milvus |
|------|---------------------|--------|
| **éƒ¨ç½²å¤æ‚åº¦** | ä½ (å†…ç½®) | é«˜ (ç‹¬ç«‹æœåŠ¡) |
| **è¿ç»´æˆæœ¬** | ä½ | é«˜ |
| **å‘é‡ç»´åº¦** | â‰¤2000 | æ›´é«˜ |
| **æ•°æ®è§„æ¨¡** | ç™¾ä¸‡çº§ | äº¿çº§ |
| **æ··åˆæŸ¥è¯¢** | âœ… SQL + å‘é‡ | éœ€é¢å¤–å¤„ç† |
| **é€‚ç”¨åœºæ™¯** | ä¸­å°è§„æ¨¡ | å¤§è§„æ¨¡ |

> **ç»“è®º**: å¯¹äºä¸ªäºº/å°å›¢é˜ŸçŸ¥è¯†åº“é¡¹ç›®ï¼Œpgvector å®Œå…¨å¤Ÿç”¨ï¼Œä¸”å¤§å¹…ç®€åŒ–éƒ¨ç½²æ¶æ„ã€‚

---

## ä¹ã€å¼€å‘è®¡åˆ’

### 9.1 é˜¶æ®µåˆ’åˆ†

```
Phase 1: å‰ç«¯é‡æ„ + ç”¨æˆ·ç³»ç»Ÿ (2-3 å‘¨)
â”œâ”€â”€ Week 1: Next.js é¡¹ç›®æ­å»º + åŸºç¡€ UI
â”œâ”€â”€ Week 2: ç”¨æˆ·è®¤è¯ç³»ç»Ÿ + ä¼šè¯ç®¡ç†
â””â”€â”€ Week 3: æµå¼èŠå¤©é›†æˆ + å·¥å…·å¯è§†åŒ–

Phase 2: å¤šæ¨¡æ€èƒ½åŠ› (1-2 å‘¨)
â”œâ”€â”€ Week 4: å›¾ç‰‡ä¸Šä¼ ä¸ç†è§£
â””â”€â”€ Week 5: è¯­éŸ³è¾“å…¥/è¾“å‡º

Phase 3: RAG å¢å¼º (2 å‘¨)
â”œâ”€â”€ Week 6: Milvus è¿ç§» + æ··åˆæ£€ç´¢
â””â”€â”€ Week 7: MinerU é›†æˆ + å¼•ç”¨è¿½æº¯

Phase 4: éƒ¨ç½²ä¼˜åŒ– (1 å‘¨)
â””â”€â”€ Week 8: Docker Compose + æµ‹è¯• + æ–‡æ¡£

Phase 5: æ‰©å±•åŠŸèƒ½ (å¾…å®š)
â””â”€â”€ Week 9+: AI ç”Ÿæˆ PPT / æ–‡æ¡£ç”Ÿæˆ
```

### 9.2 é‡Œç¨‹ç¢‘

| é‡Œç¨‹ç¢‘ | å®Œæˆæ¡ä»¶ | é¢„è®¡æ—¥æœŸ |
|--------|---------|---------|
| **M1: å‰ç«¯å¯ç”¨** | Next.js å‰ç«¯èƒ½æ­£å¸¸èŠå¤© | Week 2 |
| **M2: ç”¨æˆ·ç³»ç»Ÿ** | æ³¨å†Œ/ç™»å½•/ä¼šè¯ç®¡ç†å®Œæˆ | Week 3 |
| **M3: å¤šæ¨¡æ€** | å›¾ç‰‡+è¯­éŸ³åŠŸèƒ½å¯ç”¨ | Week 5 |
| **M4: RAG å¢å¼º** | æ··åˆæ£€ç´¢+å¼•ç”¨è¿½æº¯å®Œæˆ | Week 7 |
| **M5: ç”Ÿäº§å°±ç»ª** | Docker Compose éƒ¨ç½²å®Œæˆ | Week 8 |
| **M6: æ‰©å±•åŠŸèƒ½** | AI ç”Ÿæˆ PPT åŠŸèƒ½å¯ç”¨ | Week 9+ |

### 9.3 è¯¦ç»†ä»»åŠ¡æ¸…å•

#### Phase 1: å‰ç«¯é‡æ„ + ç”¨æˆ·ç³»ç»Ÿ

**Week 1: åŸºç¡€æ­å»º** âœ… å·²å®Œæˆ (2025-12-31)

- [x] åˆ›å»º Next.js 14 é¡¹ç›® (å®é™…ä½¿ç”¨ Next.js 16.1.1)
- [x] é…ç½® Tailwind CSS + shadcn/ui (Tailwind 4.0)
- [x] å®ç°åŸºç¡€å¸ƒå±€ (Header + Sidebar + Main)
- [x] åˆ›å»ºç™»å½•/æ³¨å†Œé¡µé¢ UI
- [x] åˆ›å»ºèŠå¤©é¡µé¢ UI
- [x] å®ç°æ¶ˆæ¯åˆ—è¡¨ç»„ä»¶
- [x] å®ç°è¾“å…¥åŒºåŸŸç»„ä»¶ (æ”¯æŒå›¾ç‰‡ä¸Šä¼ /ç²˜è´´/æ‹–æ‹½)
- [x] é…ç½® Zustand çŠ¶æ€ç®¡ç† (authStore, chatStore, settingsStore)
- [x] å®ç° ThemeProvider (äº®è‰²/æš—è‰²/ç³»ç»Ÿä¸»é¢˜)
- [x] å®ç° AuthProvider (è·¯ç”±ä¿æŠ¤)
- [x] é…ç½® API å®¢æˆ·ç«¯ (Axios + Token æ‹¦æˆªå™¨)
- [x] åˆ›å»ºè®¾ç½®é¡µé¢ UI

**Week 2: ç”¨æˆ·è®¤è¯** âœ… å·²å®Œæˆ (2025-12-31)

- [x] åˆ›å»º auth-service é¡¹ç›®ç»“æ„
- [x] å®ç°ç”¨æˆ·æ³¨å†Œ API (POST /api/auth/register)
- [x] å®ç°ç”¨æˆ·ç™»å½• API (POST /api/auth/login)
- [x] å®ç° JWT Token ç”Ÿæˆ/éªŒè¯ (bcrypt + python-jose)
- [x] å®ç° Refresh Token æœºåˆ¶ (POST /api/auth/refresh)
- [x] å®ç°ç”¨æˆ·ç™»å‡º API (POST /api/auth/logout)
- [x] å®ç°è·å–å½“å‰ç”¨æˆ· API (GET /api/auth/me)
- [x] å‰ç«¯è®¤è¯çŠ¶æ€ç®¡ç† (å·²åœ¨ Week 1 å®Œæˆ)
- [x] å‰ç«¯è·¯ç”±ä¿æŠ¤ (å·²åœ¨ Week 1 å®Œæˆ)
- [x] API è¯·æ±‚æ‹¦æˆªå™¨ (Token è‡ªåŠ¨æºå¸¦/åˆ·æ–°) (å·²åœ¨ Week 1 å®Œæˆ)

**Week 3: èŠå¤©é›†æˆ** âœ… å·²å®Œæˆ (2025-12-31)

- [x] åˆ›å»º chat-service å¾®æœåŠ¡é¡¹ç›®ç»“æ„
- [x] å®ç°ä¼šè¯ (Conversation) æ•°æ®æ¨¡å‹
- [x] å®ç°æ¶ˆæ¯ (Message) æ•°æ®æ¨¡å‹
- [x] å®ç°ä¼šè¯ CRUD API (GET/POST/PUT/DELETE)
- [x] å®ç°æ¶ˆæ¯å­˜å‚¨å’ŒæŸ¥è¯¢ API
- [x] å®ç°æµå¼èŠå¤© API (POST /api/chat/stream)
- [x] é›†æˆ LangGraph Agent æœåŠ¡
- [x] ç”¨æˆ·éš”ç¦»æœºåˆ¶ (åŸºäº JWT user_id)
- [x] auth-service JWT Token å¢åŠ  username/email å­—æ®µ
- [x] å‰ç«¯è®¤è¯ API è”è°ƒ (ç™»å½•/æ³¨å†Œ/ç™»å‡º)
- [x] ä¿®å¤ .gitignore è§„åˆ™ (æ¢å¤ frontend-next/src/lib/ è¿½è¸ª)
- [x] å‰ç«¯ SSE æµå¼å¤„ç†å¯¹æ¥ (chat.ts, chatStore.ts)
- [x] å·¥å…·è°ƒç”¨å¯è§†åŒ–ç»„ä»¶ (ToolCallPanel.tsx)
- [x] ä»£ç å—é«˜äº®ç»„ä»¶ (CodeBlock.tsx)
- [x] å›¾è¡¨æ¸²æŸ“ç»„ä»¶ (ImageRenderer.tsx)
- [x] æ¶ˆæ¯å¤åˆ¶/é‡æ–°ç”ŸæˆåŠŸèƒ½ (MessageBubble.tsx)
- [x] ä¿®å¤å·¥å…·å¯¼å…¥è·¯å¾„ (agent_service.py)
- [x] ä¿®å¤å‰ç«¯ UTF-8 ä¸­æ–‡æ˜¾ç¤ºä¹±ç  (decodeBase64UTF8)
- [x] æ”¯æŒ OpenAI å…¼å®¹æ¨¡å¼ LLM é…ç½® (.env.example æ›´æ–°)

#### Phase 2: å¤šæ¨¡æ€èƒ½åŠ›

**Week 4: å›¾ç‰‡ç†è§£** âœ… å·²å®Œæˆ (2026-01-01)

- [x] å‰ç«¯å›¾ç‰‡ä¸Šä¼ ç»„ä»¶ (å·²åœ¨ Week 1 å®Œæˆ)
- [x] å›¾ç‰‡æ‹–æ‹½/ç²˜è´´æ”¯æŒ (å·²åœ¨ Week 1 å®Œæˆ)
- [x] å›¾ç‰‡é¢„è§ˆä¸åˆ é™¤ (å·²åœ¨ Week 1 å®Œæˆ)
- [x] åç«¯å¤šæ¨¡æ€æ¶ˆæ¯æ„å»º (build_multimodal_content å‡½æ•°)
- [x] Vision API é›†æˆ (æ”¯æŒ OpenAI å…¼å®¹æ¨¡å¼)
- [x] æ›´æ–° .env.example æ·»åŠ è§†è§‰æ¨¡å‹è¯´æ˜
- [x] ä¿®å¤ E2B å›¾è¡¨æ˜¾ç¤ºé—®é¢˜ (å˜é‡å `images` å†²çªæ”¹ä¸º `image_matches`)
- [x] ä¿®å¤ ToolCallPanel è‡ªåŠ¨å±•ç¤ºå›¾ç‰‡ (æ— éœ€æ‰‹åŠ¨å±•å¼€)
- [x] ä¿®å¤ Markdown å›¾ç‰‡æ¸²æŸ“ (MessageBubble æ·»åŠ  img ç»„ä»¶)
- [ ] OCR åŠŸèƒ½å®ç° (å»¶ååˆ° Week 5)

**Week 5: è¯­éŸ³äº¤äº’** âœ… å·²å®Œæˆ (2026-01-01)

- [x] åˆ›å»º whisper-service é¡¹ç›®ç»“æ„
- [x] é›†æˆ faster-whisper è¯­éŸ³è¯†åˆ«
- [x] é›†æˆ edge-tts è¯­éŸ³åˆæˆ
- [x] å‰ç«¯å½•éŸ³ç»„ä»¶ VoiceRecorder (MediaRecorder API)
- [x] å‰ç«¯éŸ³é¢‘æ’­æ”¾å™¨ç»„ä»¶ AudioPlayer
- [x] è¯­éŸ³è½¬æ–‡å­—å®Œæ•´æµç¨‹ (InputArea é›†æˆ)
- [x] æ–‡å­—è½¬è¯­éŸ³å®Œæ•´æµç¨‹ (MessageBubble é›†æˆ)
- [x] è¯­éŸ³è®¾ç½®é€‰é¡¹ (Settings é¡µé¢ TTS è¯­éŸ³é€‰æ‹©)
- [x] ä¿®å¤è·¯ç”±å‰ç¼€é—®é¢˜ (/api/v1/voice/*)
- [x] ä¿®å¤ MIME ç±»å‹éªŒè¯ (æ”¯æŒ codecs å‚æ•°)
- [x] ä¿®å¤ Whisper è½¬å½• (bytes â†’ BytesIO)
- [x] ä¿®å¤ Edge TTS åˆæˆ (ä½¿ç”¨ stream_sync())

**Week 5.5: å‰ç«¯ä¼˜åŒ–** âœ… å·²å®Œæˆ (2026-01-02)

- [x] æ–°å¢ ConversationItem ç»„ä»¶ (æ”¯æŒå¯¹è¯é‡å‘½åå’Œåˆ é™¤)
- [x] ä½¿ç”¨ CSS Grid å¸ƒå±€è§£å†³é•¿æ ‡é¢˜æŒ¤å‹æŒ‰é’®çš„é—®é¢˜
- [x] ä¿®å¤é»˜è®¤é¡µé¢é‡å®šå‘é€»è¾‘ (æœªç™»å½•è·³è½¬ loginï¼Œå·²ç™»å½•è·³è½¬ chat)
- [x] æ·»åŠ  authStore çš„ isInitialized çŠ¶æ€ç”¨äºåˆå§‹åŒ–æ£€æµ‹

#### Phase 3: RAG å¢å¼º

**Week 6: å‘é‡å­˜å‚¨è¿ç§»** âœ… å·²å®Œæˆ (2026-01-02)

- [x] åˆ›å»º rag-service é¡¹ç›®ç»“æ„
- [x] Milvus Collection è®¾è®¡ (milvus_service.py)
- [x] å‘é‡å­˜å‚¨æœåŠ¡å°è£… (MilvusService)
- [x] Embedding æœåŠ¡å°è£… (EmbeddingService - sentence-transformers)
- [x] BM25 ç´¢å¼•æ„å»º (BM25Service - jieba ä¸­æ–‡åˆ†è¯)
- [x] RRF èåˆç®—æ³•å®ç° (HybridSearchService)
- [x] æ··åˆæ£€ç´¢ API (å‘é‡+BM25+RRFèåˆ)
- [x] æ–‡æ¡£ç®¡ç† API (CRUD)
- [x] æ–‡æ¡£æ‘„å– API (ä¸Šä¼ /åˆ†å—/å‘é‡åŒ–)
- [x] PDF æ–‡æœ¬æå– (PyPDF2)
- [x] SQLite æµ‹è¯•æ¨¡å¼å…¼å®¹æ€§ä¿®å¤
- [x] æµ‹è¯•é€šè¿‡: å¥åº·æ£€æŸ¥ã€æ–‡æ¡£ä¸Šä¼ (71åˆ†å—)ã€BM25ä¸­æ–‡æœç´¢
- [ ] ChromaDB æ•°æ®è¿ç§»è„šæœ¬ (å¾…å®š)

**Week 7: é«˜çº§æ£€ç´¢**

- [x] Reranker æ¨¡å‹é›†æˆ (bge-reranker + ç®€å•å…³é”®è¯é‡æ’åº)
- [x] å¼•ç”¨è¿½æº¯å®ç° (CitationService + ä¸Šä¸‹æ–‡è·å–)
- [x] æ··åˆæœç´¢ Milvus ç©ºæŒ‡é’ˆä¿®å¤
- [x] æ™ºèƒ½åˆ†å—æœåŠ¡ (ChunkingService - è¯­ä¹‰/é¡µé¢æ„ŸçŸ¥/é€’å½’åˆ†å—)
- [x] å‰ç«¯å¼•ç”¨å±•ç¤ºç»„ä»¶ (CitationPanel + RAG API)
- [x] æ–‡æ¡£ç®¡ç†ç•Œé¢ (DocumentsPage - ä¸Šä¼ /åˆ—è¡¨/æœç´¢/åˆ é™¤)
- [x] RAG ä¸ Chat é›†æˆ (rag_search + list_knowledge_documents å·¥å…·)
- [x] RAG æ£€ç´¢ä¼˜åŒ– (chunk_size: 500â†’1500, overlap: 50â†’200, top_k: 5â†’10)
- [x] LLM RAG ç»“æœåˆ©ç”¨ä¼˜åŒ– (System Prompt å¢åŠ  RAG ä½¿ç”¨æŒ‡å— + å·¥å…·è¾“å‡ºæ ¼å¼ä¼˜åŒ–)
- [x] å¼•ç”¨å±•ç¤ºä¼˜åŒ– - ç»“æ„åŒ–å¼•ç”¨æ•°æ®ä¼ é€’ ([RAG_CITATIONS] æ ‡è®° + citation SSE äº‹ä»¶)
- [x] å¼•ç”¨å±•ç¤ºä¼˜åŒ– - å®Œæ•´å†…å®¹å¼¹çª— (CitationPanel å±•å¼€è¯¦æƒ… + å‰åæ–‡ä¸Šä¸‹æ–‡)
- [x] æ–‡æ¡£ç›®å½•æå–åŠŸèƒ½ (extract_toc + chunk_with_toc - æå‡é•¿ç¯‡ä¹¦ç±ç« èŠ‚é—®ç­”å‡†ç¡®æ€§)
- [x] å‰ç«¯æ–‡æ¡£åˆ—è¡¨ UI ä¿®å¤ (CSS Grid å¸ƒå±€è§£å†³é•¿æ–‡ä»¶åæŒ¤å‹é—®é¢˜)
- [ ] å¼•ç”¨å±•ç¤ºä¼˜åŒ– - å¼•ç”¨é«˜äº®æ ‡è®° (å¾…å®š)
- [ ] MinerU API é›†æˆ (å¯é€‰)
- [ ] å¤šè½®å¯¹è¯æ£€ç´¢ä¼˜åŒ–

#### Phase 4: éƒ¨ç½²ä¼˜åŒ–

**Week 8: éƒ¨ç½²ä¸æµ‹è¯•**

> éƒ¨ç½²æ–¹æ¡ˆ: Render (è®¡ç®—) + Supabase (æ•°æ®åº“ + pgvector å‘é‡å­˜å‚¨)

- [x] PgvectorService å®ç° (æ›¿ä»£ MilvusService) âœ… 2026-01-03
- [x] rag-service é€‚é… pgvector (API å±‚å…¼å®¹) âœ… 2026-01-03
- [x] PgvectorService è‡ªåŠ¨åŒ–æµ‹è¯• (11 é¡¹æµ‹è¯•å…¨é€šè¿‡) âœ… 2026-01-03
- [x] Supabase æ•°æ®åº“ Schema è®¾è®¡ä¸è¿ç§» âœ… 2026-01-03
- [x] Render éƒ¨ç½²é…ç½® (render.yaml) âœ… 2026-01-03
- [x] æœåŠ¡å¥åº·æ£€æŸ¥å®ç° (å·²å†…ç½® /health ç«¯ç‚¹) âœ… 2026-01-03
- [x] ç¯å¢ƒå˜é‡ç®¡ç† (.env.example æ›´æ–°) âœ… 2026-01-03
- [x] éƒ¨ç½²æ–‡æ¡£ç¼–å†™ (docs/deploy-render.md) âœ… 2026-01-03
- [x] å‰ç«¯æ„å»ºä¸éƒ¨ç½²é…ç½® (Dockerfile + next.config.ts + APIå®¢æˆ·ç«¯ä¼˜åŒ–) âœ… 2026-01-03
- [x] ç«¯åˆ°ç«¯æµ‹è¯•è„šæœ¬ (tests/test_e2e.py + health_check.py) âœ… 2026-01-03

**å¤‡é€‰: Docker Compose æœ¬åœ°éƒ¨ç½²**
- [ ] å®Œå–„ Docker Compose é…ç½®
- [ ] Nginx åå‘ä»£ç†é…ç½®
- [ ] æœ¬åœ° Milvus é…ç½®

#### Phase 5: AI ç”Ÿæˆ PPT å®Œæ•´æ–¹æ¡ˆ (ç‹¬ç«‹æœåŠ¡æ¶æ„)

> **æ¶æ„å†³ç­–**: é‡‡ç”¨æ–¹æ¡ˆ B - å®Œæ•´ç‹¬ç«‹çš„ presentation-service
>
> **è®¾è®¡ç›®æ ‡**: æ‰“é€ ç²¾ç¾å®ç”¨ã€å›¾æ–‡å¹¶èŒ‚ã€å¯è‡ªå®šä¹‰æ¨¡æ¿å’Œé£æ ¼ã€å…·å¤‡è¿­ä»£ä¼˜åŒ–åŠŸèƒ½çš„ AI æ¼”ç¤ºæ–‡ç¨¿ç”Ÿæˆç³»ç»Ÿ

---

### 5.1 æ•´ä½“æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Frontend (Next.js 14)                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  /presentations/                    # æ¼”ç¤ºæ–‡ç¨¿ç‹¬ç«‹é¡µé¢                       â”‚
â”‚  â”œâ”€â”€ page.tsx                       # åˆ—è¡¨é¡µ + å¿«é€Ÿåˆ›å»º                      â”‚
â”‚  â”œâ”€â”€ [id]/page.tsx                  # ç¼–è¾‘å™¨ + é¢„è§ˆé¡µ                        â”‚
â”‚  â”œâ”€â”€ new/page.tsx                   # åˆ›å»ºé…ç½®é¡µ                             â”‚
â”‚  â””â”€â”€ components/                                                           â”‚
â”‚      â”œâ”€â”€ PresentationCard.tsx      # æ–‡ç¨¿å¡ç‰‡                               â”‚
â”‚      â”œâ”€â”€ PresentationEditor.tsx     # ä¸»ç¼–è¾‘å™¨ç»„ä»¶                          â”‚
â”‚      â”œâ”€â”€ SlideThumbnail.tsx        # å¹»ç¯ç‰‡ç¼©ç•¥å›¾                           â”‚
â”‚      â”œâ”€â”€ PresentationConfigPanel.tsx # é…ç½®é¢æ¿                             â”‚
â”‚      â””â”€â”€ PresentationPreview.tsx   # é¢„è§ˆç»„ä»¶ (å¤ç”¨)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  /lib/stores/presentationStore.ts   # Zustand çŠ¶æ€ç®¡ç†                      â”‚
â”‚  /lib/api/presentation.ts           # API å®¢æˆ·ç«¯                            â”‚
â”‚  /lib/types/presentation.ts         # TypeScript ç±»å‹å®šä¹‰                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                            HTTP/REST + SSE
                                    â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   presentation-service (FastAPI)                             â”‚
â”‚  Port: 8005                                                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”œâ”€â”€ app/                                                                  â”‚
â”‚  â”‚   â”œâ”€â”€ main.py                        # FastAPI å…¥å£                     â”‚
â”‚  â”‚   â”œâ”€â”€ config.py                      # é…ç½®ç®¡ç†                          â”‚
â”‚  â”‚   â”œâ”€â”€ models/                        # SQLAlchemy æ¨¡å‹                   â”‚
â”‚  â”‚   â”‚   â”œâ”€â”€ presentation.py           # æ¼”ç¤ºæ–‡ç¨¿æ¨¡å‹                      â”‚
â”‚  â”‚   â”‚   â””â”€â”€ slide_version.py           # å¹»ç¯ç‰‡ç‰ˆæœ¬æ¨¡å‹ (å¯é€‰)             â”‚
â”‚  â”‚   â”œâ”€â”€ schemas/                       # Pydantic Schema                   â”‚
â”‚  â”‚   â”‚   â”œâ”€â”€ presentation.py            # è¯·æ±‚/å“åº” Schema                   â”‚
â”‚  â”‚   â”‚   â””â”€â”€ slide.py                   # å¹»ç¯ç‰‡ Schema                     â”‚
â”‚  â”‚   â”œâ”€â”€ api/v1/                        # API è·¯ç”±                          â”‚
â”‚  â”‚   â”‚   â”œâ”€â”€ presentations.py           # CRUD API                         â”‚
â”‚  â”‚   â”‚   â””â”€â”€ editor.py                  # ç¼–è¾‘å™¨ API (æ¢ä¸»é¢˜/é‡ç”Ÿæˆ)         â”‚
â”‚  â”‚   â””â”€â”€ services/                      # ä¸šåŠ¡é€»è¾‘                          â”‚
â”‚  â”‚       â”œâ”€â”€ presentation_service.py   # æ¼”ç¤ºæ–‡ç¨¿æœåŠ¡                      â”‚
â”‚  â”‚       â”œâ”€â”€ layout_engine.py          # å¸ƒå±€å¼•æ“                          â”‚
â”‚  â”‚       â”œâ”€â”€ image_service.py          # å›¾ç‰‡æœåŠ¡ (Unsplash)                â”‚
â”‚  â”‚       â””â”€â”€ theme_service.py          # ä¸»é¢˜æœåŠ¡                          â”‚
â”‚  â””â”€â”€ requirements.txt                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
                            â–¼               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PostgreSQL         â”‚  â”‚  External Services                             â”‚
â”‚  - presentations    â”‚  â”‚  - Unsplash API (å›¾ç‰‡)                         â”‚
â”‚  - slide_versions   â”‚  â”‚  - Pexels API (å¤‡é€‰)                           â”‚
â”‚  - user_settings    â”‚  â”‚  - E2B Sandbox (ä»£ç æ‰§è¡Œ/å›¾è¡¨)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 5.2 å¯¼èˆªç»“æ„è®¾è®¡

```
ç™»å½•å
    â”‚
    â”œâ”€â”€ ğŸ“ å¯¹è¯ chat/               â† AI å¯¹è¯ (å¯å¿«é€Ÿç”Ÿæˆ PPT)
    â”œâ”€â”€ ğŸŠ æ¼”ç¤ºæ–‡ç¨¿ presentations/  â† æ–°å¢ï¼šPPT ç‹¬ç«‹é¡µé¢
    â”œâ”€â”€ ğŸ“š æ–‡æ¡£ç®¡ç† documents/      â† RAG æ–‡æ¡£ç®¡ç†
    â””â”€â”€ âš™ï¸ è®¾ç½® settings/
```

### 5.3 æ•°æ®åº“è®¾è®¡

```sql
-- æ¼”ç¤ºæ–‡ç¨¿è¡¨
CREATE TABLE presentations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    title VARCHAR(255) NOT NULL,
    description TEXT,

    -- æ ¸å¿ƒå†…å®¹
    slides JSONB NOT NULL,              -- å¹»ç¯ç‰‡æ•°ç»„
    layout_config JSONB DEFAULT '{}',   -- å¸ƒå±€é…ç½®

    -- æ ·å¼é…ç½®
    theme VARCHAR(50) DEFAULT 'modern_business',
    custom_theme JSONB,                 -- è‡ªå®šä¹‰ä¸»é¢˜é…ç½®

    -- ç”Ÿæˆé…ç½®
    target_audience VARCHAR(100),
    presentation_type VARCHAR(50),      -- informative, persuasive, instructional
    include_images BOOLEAN DEFAULT true,
    image_style VARCHAR(50),

    -- å…ƒæ•°æ®
    slide_count INTEGER DEFAULT 0,
    thumbnail TEXT,                     -- é¢„è§ˆå›¾ URL (Base64)

    -- çŠ¶æ€
    status VARCHAR(20) DEFAULT 'draft', -- draft, completed, archived

    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- å¹»ç¯ç‰‡ç‰ˆæœ¬è¡¨ (å¯é€‰ï¼Œç”¨äºç‰ˆæœ¬ç®¡ç†å’Œå›æ»š)
CREATE TABLE slide_versions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    presentation_id UUID REFERENCES presentations(id) ON DELETE CASCADE,
    slide_index INTEGER NOT NULL,
    content JSONB NOT NULL,
    layout VARCHAR(50),
    version_number INTEGER DEFAULT 1,

    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ç´¢å¼•
CREATE INDEX idx_presentations_user_id ON presentations(user_id);
CREATE INDEX idx_presentations_status ON presentations(status);
CREATE INDEX idx_presentations_created_at ON presentations(created_at DESC);
CREATE INDEX idx_slide_versions_presentation ON slide_versions(presentation_id);
```

---

### 5.4 API æ¥å£è®¾è®¡

| æ–¹æ³• | è·¯å¾„ | æè¿° | è®¤è¯ |
|------|------|------|------|
| **åŸºç¡€ CRUD** |
| POST | /api/presentations | åˆ›å»ºæ–°æ¼”ç¤ºæ–‡ç¨¿ | æ˜¯ |
| GET | /api/presentations | è·å–ç”¨æˆ·æ–‡ç¨¿åˆ—è¡¨ | æ˜¯ |
| GET | /api/presentations/{id} | è·å–æ–‡ç¨¿è¯¦æƒ… | æ˜¯ |
| PUT | /api/presentations/{id} | æ›´æ–°æ–‡ç¨¿ | æ˜¯ |
| DELETE | /api/presentations/{id} | åˆ é™¤æ–‡ç¨¿ | æ˜¯ |
| **AI ç”Ÿæˆ** |
| POST | /api/presentations/generate | AI ç”Ÿæˆæ¼”ç¤ºæ–‡ç¨¿ | æ˜¯ |
| POST | /api/presentations/{id}/regenerate/{slide_index} | é‡æ–°ç”ŸæˆæŒ‡å®šå¹»ç¯ç‰‡ | æ˜¯ |
| **ç¼–è¾‘åŠŸèƒ½** |
| POST | /api/presentations/{id}/theme | æ›´æ¢ä¸»é¢˜ | æ˜¯ |
| POST | /api/presentations/{id}/layout/{slide_index} | æ›´æ”¹å¸ƒå±€ | æ˜¯ |
| POST | /api/presentations/{id}/slides | æ·»åŠ å¹»ç¯ç‰‡ | æ˜¯ |
| DELETE | /api/presentations/{id}/slides/{slide_index} | åˆ é™¤å¹»ç¯ç‰‡ | æ˜¯ |
| PUT | /api/presentations/{id}/slides/{slide_index} | æ›´æ–°å¹»ç¯ç‰‡å†…å®¹ | æ˜¯ |
| **å¯¼å…¥å¯¼å‡º** |
| GET | /api/presentations/{id}/export/html | å¯¼å‡º HTML | æ˜¯ |
| GET | /api/presentations/{id}/export/pdf | å¯¼å‡º PDF (å¯é€‰) | æ˜¯ |

---

### 5.5 å¼€å‘é˜¶æ®µè§„åˆ’

**Phase 5.1: Reveal.js ç½‘é¡µæ¼”ç¤º (åŸºç¡€ç‰ˆ)** âœ… å·²å®Œæˆ (2026-01-03)
- [x] æ–°å¢ `generate_presentation` å·¥å…· (åœ¨ chat-service)
- [x] æ”¯æŒåŸºç¡€å¹»ç¯ç‰‡ç»“æ„ (æ ‡é¢˜ã€å†…å®¹ã€å›¾ç‰‡)
- [x] å‰ç«¯ PPT é¢„è§ˆç»„ä»¶ (iframe åµŒå…¥)
- [x] ä¸»é¢˜é€‰æ‹© (black, white, league ç­‰ 9ç§ä¸»é¢˜)

**Phase 5.2: ç‹¬ç«‹æœåŠ¡åŸºç¡€è®¾æ–½** âœ… å·²å®Œæˆ (2026-01-03)
- [x] åˆ›å»º presentation-service é¡¹ç›®ç»“æ„
- [x] å®ç°æ•°æ®æ¨¡å‹ (Presentation, SlideVersion)
- [x] å®ç° CRUD API (presentations.py)
- [x] å®ç°ç¼–è¾‘å™¨ API (editor.py - æ¢ä¸»é¢˜/é‡ç”Ÿæˆ/å¢åˆ å¹»ç¯ç‰‡)
- [x] å®ç°æœåŠ¡å±‚ (PresentationService - AIç”Ÿæˆå¹»ç¯ç‰‡)
- [x] æ”¯æŒ OpenAI å…¼å®¹æ¨¡å¼ LLM (ChatOpenAI é›†æˆ)
- [x] å¥åº·æ£€æŸ¥ç«¯ç‚¹ (/health)
- [x] SQLite UUID å…¼å®¹æ€§ä¿®å¤
- [x] Token éªŒè¯è¶…æ—¶ä¼˜åŒ– (5s â†’ 10s)

**Phase 5.3: å‰ç«¯ç‹¬ç«‹é¡µé¢** âœ… å·²å®Œæˆ (2026-01-03)
- [x] åˆ›å»º `/presentations` è·¯ç”±å’Œé¡µé¢
- [x] åˆ›å»º `/presentations/[id]` ç¼–è¾‘å™¨é¡µé¢
- [x] å®ç° presentationStore çŠ¶æ€ç®¡ç†
- [x] å®ç° API å®¢æˆ·ç«¯ (presentations.ts)
- [x] åˆ›å»ºæ¼”ç¤ºæ–‡ç¨¿åˆ—è¡¨é¡µ (PresentationListPage)
- [x] åˆ›å»ºæ¼”ç¤ºæ–‡ç¨¿ç¼–è¾‘å™¨é¡µé¢ (PresentationEditorPage)
- [x] åˆ›å»ºå¹»ç¯ç‰‡ç¼©ç•¥å›¾ç»„ä»¶
- [x] åˆ›å»ºå¹»ç¯ç‰‡ç¼–è¾‘å™¨ç»„ä»¶ (SlideEditor - æ ‡é¢˜/å†…å®¹/å¸ƒå±€/å¤‡æ³¨)
- [x] åˆ›å»ºå¹»ç¯ç‰‡é¢„è§ˆç»„ä»¶ (SlidePreview)
- [x] åˆ›å»ºä¸»é¢˜é€‰æ‹©å™¨ (ThemeSelector)
- [x] åˆ›å»ºæ¼”ç¤ºæ–‡ç¨¿æ’­æ”¾å™¨ (PresentationPlayer)
- [x] åˆ›å»ºå¯¹è¯æ¡†ç»„ä»¶ (Dialog - ç”¨äºåˆ›å»º/æ¢ä¸»é¢˜/é‡æ–°ç”Ÿæˆ)
- [x] ç¼ºå¤±ç»„ä»¶è¡¥é½ (Select - Radix UI)

**Phase 5.4: åœ¨çº¿ç¼–è¾‘å™¨åŠŸèƒ½** âœ… å·²å®Œæˆå¹¶æµ‹è¯•é€šè¿‡ (2026-01-04)
- [x] å¹»ç¯ç‰‡æ–‡æœ¬å†…å®¹å®æ—¶ç¼–è¾‘ (æ ‡é¢˜/å†…å®¹/å¤‡æ³¨) âœ… æµ‹è¯•é€šè¿‡
- [x] æ’å…¥æ–°å¹»ç¯ç‰‡åŠŸèƒ½ (æ”¯æŒåœ¨ä»»æ„ä½ç½®æ’å…¥) âœ… æµ‹è¯•é€šè¿‡
- [x] åˆ é™¤å¹»ç¯ç‰‡åŠŸèƒ½ âœ… æµ‹è¯•é€šè¿‡
- [x] ç¼–è¾‘çŠ¶æ€è‡ªåŠ¨ä¿å­˜ (1ç§’é˜²æŠ–) âœ… æµ‹è¯•é€šè¿‡
- [x] å¸ƒå±€ç±»å‹åˆ‡æ¢ (7ç§å¸ƒå±€) âœ… æµ‹è¯•é€šè¿‡
- [x] æ•°æ®æŒä¹…åŒ– (åˆ·æ–°åä¿ç•™) âœ… æµ‹è¯•é€šè¿‡
- [ ] å¹»ç¯ç‰‡æ‹–æ‹½æ’åº (å¾…åç»­å®ç°)
- [ ] æ’¤é”€/é‡åšæ“ä½œ (å¾…åç»­å®ç°)

**Phase 5.5: AI å¯¹è¯å¼ä¿®æ”¹** âœ… åŸºç¡€åŠŸèƒ½å·²å®Œæˆ (2026-01-04)
- [x] AI åŠ©æ‰‹å¯¹è¯é¢æ¿ (å³ä¾§è¾¹æ  - AssistantPanel.tsx)
- [x] è‡ªç„¶è¯­è¨€æŒ‡ä»¤è§£æ (IntentParserService - æ”¯æŒ10ç§æ„å›¾ç±»å‹)
- [x] AI åŠ©æ‰‹åç«¯ API (assistant.py - POST /assistant/{id}/chat)
- [x] å‰ç«¯é›†æˆåˆ°ç¼–è¾‘å™¨é¡µé¢ (AI åŠ©æ‰‹æŒ‰é’® + å³ä¾§é¢æ¿)
- [x] è‡ªåŠ¨åŒ–æµ‹è¯• (14é¡¹æµ‹è¯•å…¨é€šè¿‡)
- [ ] å¤šè½®å¯¹è¯ä¸Šä¸‹æ–‡ä¼˜åŒ– (å¾…åç»­å®Œå–„)
- [ ] AI è‡ªåŠ¨è°ƒæ•´å¸ƒå±€å’Œé£æ ¼ (å¾…åç»­å®Œå–„)
- [ ] ä¿®æ”¹å†å²è®°å½•å’Œå›æ»š (å¾…åç»­å®Œå–„)

**Phase 5.7: é«˜çº§ç”ŸæˆåŠŸèƒ½**
- [ ] æ™ºèƒ½å¸ƒå±€å¼•æ“ (15+ å¸ƒå±€ç±»å‹)
- [ ] å›¾ç‰‡é›†æˆ (Unsplash API)
- [ ] é«˜çº§ä¸»é¢˜ç³»ç»Ÿ (5+ ç²¾å“ä¸»é¢˜)
- [ ] Markdown é«˜çº§è¯­æ³•æ”¯æŒ

**Phase 5.8: å¯¼å‡ºä¸åä½œ**
- [ ] å¯¼å‡º HTML
- [ ] å¯¼å‡º PDF (å¯é€‰)
- [ ] ä»èŠå¤©å¿«é€Ÿè·³è½¬
- [ ] åˆ†äº«é“¾æ¥ (å¯é€‰)

---

### 5.6 åœ¨çº¿ç¼–è¾‘å™¨è®¾è®¡

#### 5.6.1 å®æ—¶ç¼–è¾‘åŠŸèƒ½

**å‰ç«¯ç»„ä»¶æ¶æ„:**
```typescript
// components/presentation/SlideEditor.tsx

interface SlideEditorProps {
  slideIndex: number;
  slide: Slide;
  onUpdate: (index: number, updates: Partial<Slide>) => void;
  readOnly?: boolean;
}

// åŠŸèƒ½:
// 1. æ ‡é¢˜ç¼–è¾‘ (ContentEditable + è‡ªåŠ¨ä¿å­˜)
// 2. å†…å®¹ç¼–è¾‘ (æ”¯æŒ Markdown é¢„è§ˆ)
// 3. å¤‡æ³¨ç¼–è¾‘ (æ¼”è®²è€…å¤‡æ³¨)
// 4. å¸ƒå±€é€‰æ‹©
// 5. èƒŒæ™¯é¢œè‰²/å›¾ç‰‡è®¾ç½®
```

**è‡ªåŠ¨ä¿å­˜æœºåˆ¶:**
```typescript
// ä½¿ç”¨ debounce é˜²æŠ–
const autoSave = useDebouncedCallback(
  async (updates: Partial<Slide>) => {
    await updateSlide(presentationId, slideIndex, updates);
  },
  1000 // 1ç§’åè‡ªåŠ¨ä¿å­˜
);
```

#### 5.6.2 æ’å…¥/åˆ é™¤å¹»ç¯ç‰‡

**æ’å…¥æ“ä½œ:**
- ç‚¹å‡»"æ·»åŠ å¹»ç¯ç‰‡"æŒ‰é’®
- é€‰æ‹©æ’å…¥ä½ç½®ï¼ˆå½“å‰é¡µä¹‹å/æœ«å°¾ï¼‰
- é€‰æ‹©å¹»ç¯ç‰‡å¸ƒå±€æ¨¡æ¿
- åˆ›å»ºæ–°å¹»ç¯ç‰‡å¹¶åˆ·æ–°åˆ—è¡¨

**åˆ é™¤æ“ä½œ:**
- è‡³å°‘ä¿ç•™ä¸€å¼ å¹»ç¯ç‰‡
- åˆ é™¤å‰ç¡®è®¤å¯¹è¯æ¡†
- åˆ é™¤åè‡ªåŠ¨é€‰ä¸­ä¸‹ä¸€å¼ 

---

### 5.7 AI å¯¹è¯å¼ä¿®æ”¹è®¾è®¡

#### 5.7.1 æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        PPT ç¼–è¾‘å™¨ç•Œé¢                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   å¹»ç¯ç‰‡ç¼©ç•¥å›¾åˆ—è¡¨   â”‚  â”‚    ä¸»ç¼–è¾‘åŒºåŸŸ       â”‚  â”‚  AI åŠ©æ‰‹    â”‚ â”‚
â”‚  â”‚   (å·¦ä¾§)            â”‚  â”‚    (ä¸­é—´)           â”‚  â”‚  (å³ä¾§)     â”‚ â”‚
â”‚  â”‚                     â”‚  â”‚                     â”‚  â”‚             â”‚ â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â”  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚ â”‚ 1 â”‚ â”‚ 2 â”‚ â”‚ 3 â”‚  â”‚  â”‚  â”‚  æ ‡é¢˜ç¼–è¾‘æ¡†    â”‚ â”‚  â”‚ â”‚ å¯¹è¯å†å²â”‚ â”‚ â”‚
â”‚  â”‚ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜  â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚  â”‚ â”‚         â”‚ â”‚ â”‚
â”‚  â”‚                     â”‚  â”‚  â”‚  å†…å®¹ç¼–è¾‘æ¡†    â”‚ â”‚  â”‚ â”‚ ç”¨æˆ·:   â”‚ â”‚ â”‚
â”‚  â”‚ [+ æ·»åŠ å¹»ç¯ç‰‡]      â”‚  â”‚  â”‚               â”‚ â”‚  â”‚ â”‚ "å¸®æˆ‘æŠŠ  â”‚ â”‚ â”‚
â”‚  â”‚                     â”‚  â”‚  â”‚               â”‚ â”‚  â”‚ â”‚  ç¬¬3é¡µ   â”‚ â”‚ â”‚
â”‚  â”‚                     â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚ â”‚  æ ‡é¢˜æ”¹  â”‚ â”‚ â”‚
â”‚  â”‚                     â”‚  â”‚                     â”‚  â”‚ â”‚  æˆ..." â”‚ â”‚ â”‚
â”‚  â”‚                     â”‚  â”‚  [é¢„è§ˆ] [æ’­æ”¾]      â”‚  â”‚ â”‚         â”‚ â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚ AI:      â”‚ â”‚ â”‚
â”‚                                                  â”‚ â”‚ â”‚ å¥½çš„,æˆ‘  â”‚ â”‚ â”‚
â”‚                                                  â”‚ â”‚ â”‚ å·²å°†ç¬¬3  â”‚ â”‚ â”‚
â”‚                                                  â”‚ â”‚ â”‚ é¡µçš„æ ‡é¢˜ â”‚ â”‚ â”‚
â”‚                                                  â”‚ â”‚ â”‚ ä¿®æ”¹å®Œæˆ â”‚ â”‚ â”‚
â”‚                                                  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚                                                  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚                                                  â”‚ â”‚ è¾“å…¥æ¡†  â”‚ â”‚ â”‚
â”‚                                                  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚                                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 5.7.2 è‡ªç„¶è¯­è¨€æŒ‡ä»¤è§£æ

**æ”¯æŒçš„æŒ‡ä»¤ç±»å‹:**

| æŒ‡ä»¤ç±»å‹ | ç¤ºä¾‹ | API è°ƒç”¨ |
|---------|------|---------|
| ä¿®æ”¹æ ‡é¢˜ | "æŠŠç¬¬3é¡µçš„æ ‡é¢˜æ”¹æˆxxx" | `PUT /slides/{2}` |
| ä¿®æ”¹å†…å®¹ | "åœ¨ç¬¬5é¡µæ·»åŠ ä¸€æ®µå…³äºxxxçš„å†…å®¹" | `PUT /slides/{4}` |
| æ’å…¥å¹»ç¯ç‰‡ | "åœ¨ç¬¬2é¡µåæ’å…¥ä¸€å¼ å…³äºxxxçš„å¹»ç¯ç‰‡" | `POST /slides` |
| åˆ é™¤å¹»ç¯ç‰‡ | "åˆ é™¤ç¬¬4é¡µ" | `DELETE /slides/{3}` |
| è°ƒæ•´å¸ƒå±€ | "æŠŠç¬¬1é¡µæ”¹æˆåŒæ å¸ƒå±€" | `PUT /slides/{0}` + layout |
| æ›´æ¢ä¸»é¢˜ | "æŠŠæ•´ä¸ªPPTæ¢æˆæ·±è‰²ä¸»é¢˜" | `POST /theme` |
| é‡æ–°ç”Ÿæˆ | "é‡æ–°ç”Ÿæˆç¬¬3é¡µ" | `POST /regenerate/{2}` |

#### 5.7.3 AI åŠ©æ‰‹å®ç°

**åç«¯ API è®¾è®¡:**
```python
# app/api/v1/assistant.py

@router.post("/chat")
async def assistant_chat(
    presentation_id: str,
    message: str,
    user_id: str = Depends(get_current_user_id),
    db: AsyncSession = Depends(get_db),
):
    """
    AI åŠ©æ‰‹å¯¹è¯æ¥å£
    è§£æè‡ªç„¶è¯­è¨€æŒ‡ä»¤å¹¶æ‰§è¡Œç›¸åº”æ“ä½œ
    """
    # 1. è·å–æ¼”ç¤ºæ–‡ç¨¿
    presentation = await get_presentation(db, presentation_id, user_id)

    # 2. è§£æç”¨æˆ·æ„å›¾
    intent = await parse_user_intent(message, presentation)

    # 3. æ‰§è¡Œæ“ä½œ
    result = await execute_intent(db, presentation, intent)

    # 4. è¿”å›ç»“æœ
    return {
        "response": intent.response_message,
        "presentation": result,
        "actions": intent.actions_performed
    }
```

**æ„å›¾è§£æ Prompt:**
```python
INTENT_ANALYSIS_SYSTEM_PROMPT = """
ä½ æ˜¯ä¸€ä¸ª PPT ç¼–è¾‘åŠ©æ‰‹ï¼Œè´Ÿè´£è§£æç”¨æˆ·çš„è‡ªç„¶è¯­è¨€æŒ‡ä»¤å¹¶è½¬æ¢ä¸ºç»“æ„åŒ–æ“ä½œã€‚

å½“å‰æ¼”ç¤ºæ–‡ç¨¿ä¿¡æ¯:
- å¹»ç¯ç‰‡æ•°é‡: {slide_count}
- å½“å‰é€‰ä¸­: {current_slide}

è¯·åˆ†æç”¨æˆ·æŒ‡ä»¤ï¼Œè¿”å›ä»¥ä¸‹ JSON æ ¼å¼:
{
  "intent_type": "edit_title|edit_content|insert_slide|delete_slide|change_layout|change_theme|regenerate|chat",
  "target_slide": 2,  // ç›®æ ‡å¹»ç¯ç‰‡ç´¢å¼• (ä»0å¼€å§‹)
  "new_value": "...", // æ–°å€¼
  "response_message": "ç¡®è®¤æ¶ˆæ¯",
  "confidence": 0.95  // ç½®ä¿¡åº¦
}

ç¤ºä¾‹:
ç”¨æˆ·: "æŠŠç¬¬3é¡µçš„æ ‡é¢˜æ”¹æˆäººå·¥æ™ºèƒ½å‘å±•å²"
è¾“å‡º: {"intent_type": "edit_title", "target_slide": 2, "new_value": "äººå·¥æ™ºèƒ½å‘å±•å²", ...}

ç”¨æˆ·: "åœ¨å½“å‰é¡µåæ’å…¥ä¸€å¼ æ–°å¹»ç¯ç‰‡"
è¾“å‡º: {"intent_type": "insert_slide", "target_slide": {current}, ...}
"""
```

#### 5.7.4 å¤šè½®å¯¹è¯ä¸Šä¸‹æ–‡

```python
class ConversationContext:
    """å¯¹è¯ä¸Šä¸‹æ–‡ç®¡ç†"""

    def __init__(self):
        self.history: List[dict] = []
        self.current_presentation_id: str = None
        self.last_action: str = None

    def add_message(self, role: str, content: str):
        self.history.append({"role": role, "content": content})

    def get_context_summary(self) -> str:
        """è·å–ä¸Šä¸‹æ–‡æ‘˜è¦"""
        return f"""
        å¯¹è¯å†å²æ‘˜è¦:
        - æœ€åæ“ä½œ: {self.last_action}
        - å¯¹è¯è½®æ•°: {len(self.history) // 2}
        """
```

---

### 5.8 æ™ºèƒ½å¸ƒå±€ç³»ç»Ÿ

**å¸ƒå±€ç±»å‹æ¸…å•:**
```python
LAYOUT_TYPES = {
    # === åŸºç¡€å¸ƒå±€ ===
    "title_cover": "å°é¢é¡µ - å¤§æ ‡é¢˜ + å‰¯æ ‡é¢˜ + ä½œè€…",
    "title_section": "ç« èŠ‚é¡µ - å±…ä¸­å¤§æ ‡é¢˜",
    "bullet_points": "åˆ—è¡¨é¡µ - æ ‡é¢˜ + 3-6 ä¸ªè¦ç‚¹",
    "two_column": "åŒæ å¸ƒå±€ - å·¦æ–‡å³å›¾/åŒåˆ—è¡¨",
    "image_text": "å›¾æ–‡æ··æ’ - å¤§å›¾é…æ–‡å­—è¯´æ˜",

    # === æ•°æ®å±•ç¤º ===
    "chart_single": "å•å›¾è¡¨ - æ ‡é¢˜ + å›¾è¡¨åŒºåŸŸ",
    "chart_dual": "åŒå›¾è¡¨å¯¹æ¯” - å¹¶æ’ä¸¤ä¸ªå›¾è¡¨",
    "data_table": "æ•°æ®è¡¨æ ¼ - æ ‡é¢˜ + è¡¨æ ¼ + è¯´æ˜",
    "metric_card": "æŒ‡æ ‡å¡ç‰‡ - 3-4 ä¸ªå…³é”®æŒ‡æ ‡",

    # === ç‰¹æ®Šæ•ˆæœ ===
    "quote_center": "å¼•ç”¨é¡µ - å±…ä¸­å¼•ç”¨æ–‡å­—",
    "timeline": "æ—¶é—´çº¿ - å‚ç›´/æ°´å¹³æ—¶é—´è½´",
    "process_flow": "æµç¨‹å›¾ - æ­¥éª¤æµç¨‹å±•ç¤º",
    "comparison": "å¯¹æ¯”å¸ƒå±€ - å·¦å³å¯¹æ¯”ä¸¤æ ",
    "gallery": "å›¾ç‰‡ç”»å»Š - ç½‘æ ¼å›¾ç‰‡å±•ç¤º",

    # === ç»“å°¾ ===
    "thank_you": "ç»“å°¾é¡µ - æ„Ÿè°¢ + Q&A",
    "contact": "è”ç³»æ–¹å¼ - ç¤¾äº¤åª’ä½“/é‚®ç®±/äºŒç»´ç ",
}
```

---

### 5.9 å›¾ç‰‡æ™ºèƒ½é›†æˆ

**å›¾ç‰‡æ¥æºç­–ç•¥:**
```python
IMAGE_SOURCES = {
    "unsplash": "https://source.unsplash.com/featured/{keyword}",  # å…è´¹
    "pexels": "Pexels API",  # éœ€è¦ API Keyï¼Œå…è´¹é¢åº¦å¤§
    "user_upload": "ç”¨æˆ·ä¸Šä¼ çš„å›¾ç‰‡",
    "ai_generated": "AI ç”Ÿæˆçš„å›¾è¡¨/å›¾ç‰‡",
}

# å…³é”®è¯æ˜ å°„
KEYWORD_MAPPING = {
    "ç§‘æŠ€": ["technology", "innovation", "digital", "futuristic"],
    "å•†ä¸š": ["business", "meeting", "office", "corporate"],
    "è‡ªç„¶": ["nature", "landscape", "environment", "outdoor"],
    "äººç‰©": ["people", "team", "person", "professional"],
}
```

---

### 5.10 é«˜çº§ä¸»é¢˜ç³»ç»Ÿ

**ä¸»é¢˜é¢„è®¾:**
```python
THEME_PRESETS = {
    "modern_business": {
        "colors": {"primary": "#1e3a8a", "accent": "#3b82f6", "background": "#ffffff"},
        "fonts": {"title": "Montserrat", "body": "Open Sans"},
        "style": "clean, professional, gradient accents",
    },
    "dark_tech": {
        "colors": {"primary": "#00ff88", "accent": "#00d4ff", "background": "#0a0a0a"},
        "fonts": {"title": "Rajdhani", "body": "Roboto Mono"},
        "style": "cyberpunk, neon, grid background",
    },
    "creative_colorful": {
        "colors": {"primary": "#ff6b6b", "accent": "#feca57", "background": "#f8f9fa"},
        "fonts": {"title": "Poppins", "body": "Lato"},
        "style": "vibrant, playful, illustrations",
    },
    "minimal_academic": {
        "colors": {"primary": "#2c3e50", "accent": "#3498db", "background": "#ffffff"},
        "fonts": {"title": "Georgia", "body": "Helvetica"},
        "style": "minimal, serif headers, clean",
    },
    "elegant_dark": {
        "colors": {"primary": "#d4af37", "accent": "#f4e4bc", "background": "#1a1a1a"},
        "fonts": {"title": "Playfair Display", "body": "Lora"},
        "style": "luxury, gold accents, dark",
    },
}
```

---

### 5.11 å®Œæ•´æ•°æ®ç»“æ„

```python
class Slide(BaseModel):
    title: str
    content: str  # æ”¯æŒ Markdown
    layout: str = "bullet_points"  # å¸ƒå±€ç±»å‹
    background: Optional[str] = None  # é¢œè‰²æˆ–å›¾ç‰‡ URL
    notes: Optional[str] = None  # æ¼”è®²è€…å¤‡æ³¨
    images: List[SlideImage] = []
    charts: List[ChartConfig] = []
    fragments: List[str] = []  # é€æ­¥æ˜¾ç¤ºçš„ç‰‡æ®µ
    transition: str = "slide"  # åˆ‡æ¢åŠ¨ç”»

class SlideImage(BaseModel):
    url: str
    position: str  # left, right, top, bottom, background
    size: str = "medium"  # small, medium, large, full
    caption: Optional[str] = None

class PresentationConfig(BaseModel):
    topic: str
    theme: str = "modern_business"
    slide_count: int = 10
    target_audience: str = "general"
    presentation_type: str = "informative"  # persuasive, informative, instructional
    include_images: bool = True
    image_style: str = "professional"
```

---

### 5.12 å¼€å‘ä¼˜å…ˆçº§

| ä¼˜å…ˆçº§ | åŠŸèƒ½ | è¯´æ˜ |
|--------|------|------|
| **P0** | presentation-service åŸºç¡€è®¾æ–½ | é¡¹ç›®ç»“æ„ã€æ•°æ®æ¨¡å‹ã€CRUD API |
| **P0** | æ•°æ®åº“è¿ç§» | PostgreSQL è¡¨åˆ›å»º |
| **P1** | å‰ç«¯ç‹¬ç«‹é¡µé¢ | `/presentations` è·¯ç”±å’Œåˆ—è¡¨é¡µ |
| **P1** | ç¼–è¾‘å™¨é¡µé¢ | `/presentations/[id]` ç¼–è¾‘å’Œé¢„è§ˆ |
| **P1** | ä»èŠå¤©è·³è½¬ | èŠå¤©ç”Ÿæˆ PPT åå¯è·³è½¬åˆ°ç‹¬ç«‹é¡µé¢ |
| **P2** | é«˜çº§å¸ƒå±€ç³»ç»Ÿ | 15+ å¸ƒå±€ç±»å‹å®ç° |
| **P2** | å›¾ç‰‡é›†æˆ | Unsplash API é›†æˆ |
| **P2** | é«˜çº§ä¸»é¢˜ç³»ç»Ÿ | 5+ ç²¾å“ä¸»é¢˜ |
| **P3** | è¿­ä»£ä¼˜åŒ–åŠŸèƒ½ | å•é¡µé‡ç”Ÿæˆã€ä¸»é¢˜åˆ‡æ¢ |
| **P3** | å¯¼å‡ºåŠŸèƒ½ | HTML/PDF å¯¼å‡º |

---

## åã€é£é™©è¯„ä¼°ä¸åº”å¯¹

### 10.1 æŠ€æœ¯é£é™©

| é£é™© | å¯èƒ½æ€§ | å½±å“ | åº”å¯¹æªæ–½ |
|------|--------|------|---------|
| Milvus å­¦ä¹ æ›²çº¿ | ä¸­ | ä¸­ | æå‰å­¦ä¹ æ–‡æ¡£ï¼Œå‡†å¤‡ ChromaDB å›é€€æ–¹æ¡ˆ |
| Whisper æ€§èƒ½é—®é¢˜ | ä¸­ | ä½ | ä½¿ç”¨ base æ¨¡å‹ï¼Œè€ƒè™‘ API æœåŠ¡å›é€€ |
| MinerU API ä¸ç¨³å®š | ä¸­ | ä¸­ | å®ç°é»˜è®¤è§£ææ–¹æ¡ˆä½œä¸º fallback |
| å‰åç«¯é›†æˆé—®é¢˜ | ä¸­ | ä¸­ | å®šä¹‰æ¸…æ™° API æ¥å£ï¼Œæ¸è¿›å¼å¼€å‘ |
| SSE æµå¼ä¼ è¾“å…¼å®¹æ€§ | ä½ | é«˜ | æµ‹è¯•å¤šæµè§ˆå™¨ï¼Œå‡†å¤‡ WebSocket å¤‡é€‰ |

### 10.2 èµ„æºé£é™©

| é£é™© | å¯èƒ½æ€§ | å½±å“ | åº”å¯¹æªæ–½ |
|------|--------|------|---------|
| å¼€å‘æ—¶é—´ä¸è¶³ | ä¸­ | é«˜ | æŒ‰ä¼˜å…ˆçº§ç éœ€æ±‚ï¼ŒPhase 3 å¯å»¶å |
| æœåŠ¡å™¨èµ„æºä¸è¶³ | ä½ | ä¸­ | ä¼˜åŒ–é…ç½®ï¼Œè€ƒè™‘äº‘æœåŠ¡ |
| API é¢åº¦é™åˆ¶ | ä¸­ | ä¸­ | å®ç°è¯·æ±‚ç¼“å­˜ï¼Œæ·»åŠ é™æµ |

### 10.3 å›é€€æ–¹æ¡ˆ

| åŠŸèƒ½ | ä¸»æ–¹æ¡ˆ | å›é€€æ–¹æ¡ˆ |
|------|--------|---------|
| å‘é‡å­˜å‚¨ | Milvus | ChromaDB (ç°æœ‰) |
| è¯­éŸ³è¯†åˆ« | faster-whisper (æœ¬åœ°) | Web Speech API (æµè§ˆå™¨) |
| è¯­éŸ³åˆæˆ | Edge TTS | pyttsx3 (æœ¬åœ°) |
| æ–‡æ¡£è§£æ | MinerU API | PyPDF2 + åŸºç¡€åˆ†å— |
| é‡æ’åº | bge-reranker | æ— é‡æ’åº |

---

## åä¸€ã€éªŒæ”¶æ ‡å‡†

### 11.1 åŠŸèƒ½éªŒæ”¶

| åŠŸèƒ½ | éªŒæ”¶æ¡ä»¶ |
|------|---------|
| **ç”¨æˆ·æ³¨å†Œ** | èƒ½æˆåŠŸæ³¨å†Œæ–°ç”¨æˆ·ï¼Œå¯†ç åŠ å¯†å­˜å‚¨ |
| **ç”¨æˆ·ç™»å½•** | èƒ½ç™»å½•å¹¶è·å– JWT Token |
| **ä¼šè¯ç®¡ç†** | èƒ½åˆ›å»ºã€åˆ‡æ¢ã€åˆ é™¤ä¼šè¯ |
| **æµå¼èŠå¤©** | æ¶ˆæ¯å®æ—¶æµå¼æ˜¾ç¤ºï¼Œæ”¯æŒä¸­æ–­ |
| **å·¥å…·è°ƒç”¨** | å·¥å…·æ‰§è¡Œè¿‡ç¨‹å¯è§†åŒ–ï¼ŒçŠ¶æ€æ­£ç¡® |
| **å›¾ç‰‡ç†è§£** | èƒ½ä¸Šä¼ å›¾ç‰‡å¹¶è·å¾—åˆ†æç»“æœ |
| **è¯­éŸ³è¾“å…¥** | èƒ½å½•éŸ³å¹¶è½¬æ¢ä¸ºæ–‡å­— |
| **è¯­éŸ³è¾“å‡º** | AI å›å¤èƒ½è½¬æ¢ä¸ºè¯­éŸ³æ’­æ”¾ |
| **æ–‡æ¡£ä¸Šä¼ ** | èƒ½ä¸Šä¼  PDF å¹¶è§£æå…¥åº“ |
| **æ··åˆæ£€ç´¢** | èƒ½æ£€ç´¢åˆ°ç›¸å…³å†…å®¹å¹¶æ˜¾ç¤ºå¼•ç”¨ |
| **Docker éƒ¨ç½²** | docker-compose up ä¸€é”®å¯åŠ¨ |
| **AI ç”Ÿæˆ PPT** | èƒ½æ ¹æ®ä¸»é¢˜ç”Ÿæˆæ¼”ç¤ºæ–‡ç¨¿å¹¶é¢„è§ˆ/ä¸‹è½½ |

### 11.2 æ€§èƒ½éªŒæ”¶

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | æµ‹è¯•æ–¹æ³• |
|------|--------|---------|
| é¦–å±åŠ è½½ | < 2s | Lighthouse |
| ç™»å½•å“åº” | < 500ms | API æµ‹è¯• |
| æµå¼é¦– Token | < 1s | æ‰‹åŠ¨æµ‹è¯• |
| æ£€ç´¢å»¶è¿Ÿ | < 500ms | API æµ‹è¯• |
| å¹¶å‘ç”¨æˆ· | 100+ | å‹åŠ›æµ‹è¯• |

### 11.3 è´¨é‡éªŒæ”¶

- [ ] æ‰€æœ‰ API æœ‰ OpenAPI æ–‡æ¡£
- [ ] å…³é”®è·¯å¾„æœ‰å•å…ƒæµ‹è¯•
- [ ] æ— ä¸¥é‡å®‰å…¨æ¼æ´
- [ ] é”™è¯¯æç¤ºç”¨æˆ·å‹å¥½
- [ ] ç§»åŠ¨ç«¯å¯æ­£å¸¸ä½¿ç”¨

---

## åäºŒã€é™„å½•

### 12.1 å‚è€ƒèµ„æ–™

| èµ„æº | é“¾æ¥ |
|------|------|
| Next.js æ–‡æ¡£ | https://nextjs.org/docs |
| shadcn/ui | https://ui.shadcn.com |
| Tailwind CSS | https://tailwindcss.com |
| FastAPI | https://fastapi.tiangolo.com |
| Milvus | https://milvus.io/docs |
| faster-whisper | https://github.com/guillaumekln/faster-whisper |
| Edge TTS | https://github.com/rany2/edge-tts |
| MinerU | https://github.com/opendatalab/MinerU |

### 12.2 æœ¯è¯­è¡¨

| æœ¯è¯­ | è¯´æ˜ |
|------|------|
| SSE | Server-Sent Eventsï¼ŒæœåŠ¡å™¨æ¨é€äº‹ä»¶ |
| JWT | JSON Web Tokenï¼Œè®¤è¯ä»¤ç‰Œ |
| RAG | Retrieval-Augmented Generationï¼Œæ£€ç´¢å¢å¼ºç”Ÿæˆ |
| RRF | Reciprocal Rank Fusionï¼Œæ’åèåˆç®—æ³• |
| BM25 | Best Matching 25ï¼Œç»å…¸æ£€ç´¢ç®—æ³• |
| OCR | Optical Character Recognitionï¼Œå…‰å­¦å­—ç¬¦è¯†åˆ« |
| TTS | Text-to-Speechï¼Œæ–‡å­—è½¬è¯­éŸ³ |
| STT | Speech-to-Textï¼Œè¯­éŸ³è½¬æ–‡å­— |

### 12.3 å˜æ›´å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | å˜æ›´å†…å®¹ | ä½œè€… |
|------|------|---------|------|
| 1.0 | 2025-12-31 | åˆå§‹ç‰ˆæœ¬ | Claude Code |
| 1.1 | 2025-12-31 | Week 1 å®Œæˆï¼šNext.js å‰ç«¯åŸºç¡€æ¶æ„ | Claude Code |
| 1.2 | 2025-12-31 | Week 2 å®Œæˆï¼šauth-service ç”¨æˆ·è®¤è¯æœåŠ¡ | Claude Code |
| 1.3 | 2025-12-31 | Week 3 è¿›è¡Œä¸­ï¼šchat-service åç«¯å®Œæˆ | Claude Code |
| 1.4 | 2025-12-31 | Week 3 å®Œæˆï¼šå‰ç«¯ SSE æµå¼å¯¹æ¥ã€å·¥å…·å¯è§†åŒ–ã€ä»£ç é«˜äº®ã€å›¾è¡¨æ¸²æŸ“ç»„ä»¶ | Claude Code |
| 1.5 | 2025-12-31 | Week 3 å®Œæˆï¼šä¿®å¤å·¥å…·å¯¼å…¥è·¯å¾„ã€UTF-8 ä¸­æ–‡ä¹±ç ã€OpenAI å…¼å®¹æ¨¡å¼æ”¯æŒ | Claude Code |
| 1.6 | 2026-01-01 | Week 4 å®Œæˆï¼šå›¾ç‰‡ç†è§£å¤šæ¨¡æ€åŠŸèƒ½ | Claude Code |
| 1.7 | 2026-01-01 | Week 4 Bugä¿®å¤ï¼šE2Bå›¾è¡¨æ˜¾ç¤º(å˜é‡åå†²çª)ã€Markdownå›¾ç‰‡æ¸²æŸ“ | Claude Code |
| 1.8 | 2026-01-01 | ä¼˜åŒ– System Promptï¼šE2Bæ²™ç®±æŒ‡å—ã€ä»£ç æ ¼å¼è§„åˆ™ï¼›æ–°å¢ Phase 5 AIç”ŸæˆPPTè§„åˆ’ | Claude Code |
| 1.9 | 2026-01-01 | Week 5 å®Œæˆï¼šè¯­éŸ³äº¤äº’åŠŸèƒ½ (whisper-service + faster-whisper + edge-tts + å‰ç«¯ç»„ä»¶) | Claude Code |
| 2.0 | 2026-01-02 | Week 5.5 å®Œæˆï¼šå‰ç«¯ä¾§è¾¹æ ä¼˜åŒ– (ConversationItemç»„ä»¶ã€Gridå¸ƒå±€ã€é»˜è®¤é¡µé¢é‡å®šå‘) | Claude Code |
| 2.1 | 2026-01-02 | Week 6 è¿›è¡Œä¸­ï¼šåˆ›å»º rag-service å¾®æœåŠ¡ (Milvus+BM25+RRFæ··åˆæ£€ç´¢) | Claude Code |
| 2.2 | 2026-01-02 | Week 6 å®Œæˆï¼šPDFè§£æ(PyPDF2)ã€SQLiteæµ‹è¯•æ¨¡å¼ä¿®å¤ã€BM25ä¸­æ–‡æœç´¢æµ‹è¯•é€šè¿‡ | Claude Code |
| 2.3 | 2026-01-02 | Week 7 è¿›è¡Œä¸­ï¼šRerankeré‡æ’åºã€å¼•ç”¨è¿½æº¯(CitationService)ã€Milvusç©ºæŒ‡é’ˆä¿®å¤ | Claude Code |
| 2.4 | 2026-01-02 | Week 7 è¿›è¡Œä¸­ï¼šæ™ºèƒ½åˆ†å—æœåŠ¡(ChunkingService - è¯­ä¹‰/é¡µé¢æ„ŸçŸ¥/é€’å½’ç­–ç•¥) | Claude Code |
| 2.5 | 2026-01-02 | Week 7 è¿›è¡Œä¸­ï¼šå‰ç«¯å¼•ç”¨å±•ç¤ºç»„ä»¶(CitationPanel + RAG API + chatStoreé›†æˆ) | Claude Code |
| 2.6 | 2026-01-03 | Week 7 è¿›è¡Œä¸­ï¼šæ–‡æ¡£ç®¡ç†ç•Œé¢(DocumentsPage - Tabsç»„ä»¶/ä¸Šä¼ /åˆ—è¡¨/åˆ é™¤) | Claude Code |
| 2.7 | 2026-01-03 | Week 7 å®Œæˆï¼šRAGä¸Chaté›†æˆ(rag_search + list_knowledge_documentså·¥å…·ï¼Œä»£ç†ç»•è¿‡ä¿®å¤) | Claude Code |
| 2.8 | 2026-01-03 | Week 7 å®Œæˆï¼šRAGæ£€ç´¢ä¼˜åŒ–(chunk_size 500â†’1500, overlap 50â†’200, top_k 5â†’10) | Claude Code |
| 2.9 | 2026-01-03 | Week 7 å®Œæˆï¼šLLM RAGç»“æœåˆ©ç”¨ä¼˜åŒ–(System Prompt + å¼•ç”¨æ•°æ®ä¼ é€’ + citation SSEäº‹ä»¶) | Claude Code |
| 3.0 | 2026-01-03 | Week 7 å®Œæˆï¼šæ–‡æ¡£ç›®å½•æå–åŠŸèƒ½(extract_toc + chunk_with_toc) + å‰ç«¯æ–‡æ¡£åˆ—è¡¨UIä¿®å¤ | Claude Code |
| 3.1 | 2026-01-03 | Week 8 è§„åˆ’ï¼šæ–°å¢ Render + Supabase äº‘éƒ¨ç½²æ–¹æ¡ˆ (pgvector æ›¿ä»£ Milvus) | Claude Code |
| 3.2 | 2026-01-03 | Week 8 å®ç°ï¼šPgvectorService å®Œæˆ (SQLiteæš´åŠ›æœç´¢ + PostgreSQL pgvectoråŒæ¨¡å¼æ”¯æŒ) | Claude Code |
| 3.3 | 2026-01-03 | Week 8 å®Œæˆï¼šSupabase Schema (database/supabase_schema.sql) + Render éƒ¨ç½²é…ç½® (render.yaml) | Claude Code |
| 3.4 | 2026-01-03 | Week 8 å®Œæˆï¼šå‰ç«¯æ„å»ºé…ç½® (Dockerfile + next.config.ts + APIå®¢æˆ·ç«¯ä¼˜åŒ– + ç±»å‹ä¿®å¤) | Claude Code |
| 3.5 | 2026-01-03 | Week 8 å®Œæˆï¼šç«¯åˆ°ç«¯æµ‹è¯•è„šæœ¬ (test_e2e.py + health_check.py + pytest.ini) | Claude Code |
| 3.6 | 2026-01-03 | Week 8 ä¿®å¤ï¼šå‰ç«¯ API è·¯ç”±é…ç½® (.env.local + auth.ts ä½¿ç”¨ authApiClient) | Claude Code |
| 3.7 | 2026-01-03 | Week 8 ä¿®å¤ï¼šToken Refresh 500 é”™è¯¯ (æ·»åŠ  jti ç¡®ä¿ token å”¯ä¸€æ€§) | Claude Code |
| 3.8 | 2026-01-03 | Week 8 ä¿®å¤ï¼šå·¥å…·è°ƒç”¨/å¼•ç”¨æŒä¹…åŒ– (åç«¯ citation æ”¶é›† + å‰ç«¯å­—æ®µåé©¼å³°åŒ¹é…) | Claude Code |
| 3.9 | 2026-01-03 | Phase 5.1 å®Œæˆï¼šAIç”ŸæˆPPTåŠŸèƒ½ (generate_presentationå·¥å…· + Reveal.js + å‰ç«¯PresentationPreviewç»„ä»¶) | Claude Code |
| 4.0 | 2026-01-03 | Phase 5.1 ä¿®å¤ï¼šPPTé¢„è§ˆä¸æ˜¾ç¤º (agent_service.py ä¿æŠ¤ [PRESENTATION_HTML:] æ ‡è®°ä¸è¢«æˆªæ–­) | Claude Code |
| 4.1 | 2026-01-03 | Phase 5.1 ä¿®å¤ï¼šPPTä¸­æ–‡ä¹±ç  (å‰ç«¯ä½¿ç”¨ TextDecoder æ­£ç¡®è§£ç  UTF-8 base64) | Claude Code |
| 4.2 | 2026-01-03 | Phase 5 è§„åˆ’ï¼šAIç”ŸæˆPPTå®Œæ•´æ–¹æ¡ˆ (15+å¸ƒå±€ç±»å‹ã€å›¾ç‰‡é›†æˆã€ä¸»é¢˜ç³»ç»Ÿã€è¿­ä»£ä¼˜åŒ–) | Claude Code |
| 4.3 | 2026-01-03 | Phase 5 é‡æ„ï¼šé‡‡ç”¨æ–¹æ¡ˆ B - ç‹¬ç«‹ presentation-service æ¶æ„ (å®Œæ•´è®¾è®¡æ–‡æ¡£) | Claude Code |
| 4.4 | 2026-01-03 | Phase 5.2 å®Œæˆï¼šç‹¬ç«‹æœåŠ¡åŸºç¡€è®¾æ–½ (æ•°æ®æ¨¡å‹/CRUD/ç¼–è¾‘å™¨API/AIç”Ÿæˆ/SQLiteå…¼å®¹) | Claude Code |
| 4.5 | 2026-01-03 | Phase 5.3 å®Œæˆï¼šå‰ç«¯ç‹¬ç«‹é¡µé¢ (åˆ—è¡¨/ç¼–è¾‘å™¨/é¢„è§ˆ/çŠ¶æ€ç®¡ç†/ç»„ä»¶è¡¥é½) | Claude Code |
| 4.6 | 2026-01-03 | Phase 5.4 è§„åˆ’ï¼šåœ¨çº¿ç¼–è¾‘å™¨åŠŸèƒ½ (å®æ—¶ç¼–è¾‘/æ’å…¥åˆ é™¤å¹»ç¯ç‰‡/è‡ªåŠ¨ä¿å­˜) | Claude Code |
| 4.7 | 2026-01-03 | Phase 5.5 è§„åˆ’ï¼šAI å¯¹è¯å¼ä¿®æ”¹ (è‡ªç„¶è¯­è¨€æŒ‡ä»¤è§£æ/å¤šè½®å¯¹è¯/AIè‡ªåŠ¨ä¿®æ”¹PPT) | Claude Code |
| 4.8 | 2026-01-04 | Phase 5.4 å®Œæˆï¼šåœ¨çº¿ç¼–è¾‘å™¨åŠŸèƒ½ (å®æ—¶ç¼–è¾‘/æ’å…¥åˆ é™¤/è‡ªåŠ¨ä¿å­˜é˜²æŠ–/SQLAlchemy JSONæ›´æ–°ä¿®å¤) | Claude Code |
| 4.9 | 2026-01-04 | Phase 5.4 ä¿®å¤ï¼šSQLite æ•°æ®åº“æŸ¥è¯¢ç±»å‹ä¸åŒ¹é… (String vs UUID å¯¹è±¡æ¯”è¾ƒé—®é¢˜) | Claude Code |
| 5.0 | 2026-01-04 | Phase 5.5 å®Œæˆï¼šAI å¯¹è¯å¼ä¿®æ”¹åŸºç¡€åŠŸèƒ½ (IntentParserService + AssistantPanel + 14é¡¹æµ‹è¯•å…¨é€šè¿‡) | Claude Code |
| 5.1 | 2026-01-04 | Phase 5.5 ä¿®å¤ï¼šAI åŠ©æ‰‹å¯¹è¯è®°å½•æ¶ˆå¤±é—®é¢˜ (db.commit + é™é»˜æ›´æ–° + ScrollArea ä¿®å¤) | Claude Code |

---
> **æ–‡æ¡£çŠ¶æ€**: âœ… Phase 5.5 AI å¯¹è¯å¼ä¿®æ”¹åŠŸèƒ½å·²å®Œæˆå¹¶æµ‹è¯•é€šè¿‡
> **æœ€åæ›´æ–°**: 2026-01-04
> **ä¸‹ä¸€æ­¥**: Phase 5.7 é«˜çº§ç”ŸæˆåŠŸèƒ½ (æ™ºèƒ½å¸ƒå±€å¼•æ“/å›¾ç‰‡é›†æˆ/é«˜çº§ä¸»é¢˜ç³»ç»Ÿ)