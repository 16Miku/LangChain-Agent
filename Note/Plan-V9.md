# Plan-V9: ç°ä»£åŒ–å‰ç«¯é‡æ„ä¸å¤šæ¨¡æ€å¢å¼º

> **ç‰ˆæœ¬**: V9.0
> **æ—¥æœŸ**: 2025-12-31
> **ç›®æ ‡**: ä½¿ç”¨ Next.js é‡æ„å‰ç«¯ï¼Œé›†æˆå¤šæ¨¡æ€èƒ½åŠ›ï¼Œå¢å¼º RAG æ£€ç´¢ï¼Œå¼•å…¥ç”¨æˆ·è®¤è¯ç³»ç»Ÿ
> **çŠ¶æ€**: ğŸ“‹ è§„åˆ’é˜¶æ®µ

---

## ğŸ“‘ ç›®å½•

1. [ç‰ˆæœ¬æ¦‚è¿°](#ä¸€ç‰ˆæœ¬æ¦‚è¿°)
2. [éœ€æ±‚è§„æ ¼è¯´æ˜](#äºŒéœ€æ±‚è§„æ ¼è¯´æ˜)
3. [ç³»ç»Ÿæ¶æ„è®¾è®¡](#ä¸‰ç³»ç»Ÿæ¶æ„è®¾è®¡)
4. [æ¨¡å—è¯¦ç»†è®¾è®¡](#å››æ¨¡å—è¯¦ç»†è®¾è®¡)
5. [æ•°æ®åº“è®¾è®¡](#äº”æ•°æ®åº“è®¾è®¡)
6. [API æ¥å£è®¾è®¡](#å…­api-æ¥å£è®¾è®¡)
7. [å‰ç«¯é¡µé¢è®¾è®¡](#ä¸ƒå‰ç«¯é¡µé¢è®¾è®¡)
8. [éƒ¨ç½²æ¶æ„](#å…«éƒ¨ç½²æ¶æ„)
9. [å¼€å‘è®¡åˆ’](#ä¹å¼€å‘è®¡åˆ’)
10. [é£é™©è¯„ä¼°ä¸åº”å¯¹](#åé£é™©è¯„ä¼°ä¸åº”å¯¹)
11. [éªŒæ”¶æ ‡å‡†](#åä¸€éªŒæ”¶æ ‡å‡†)
12. [é™„å½•](#åäºŒé™„å½•)

---

## ä¸€ã€ç‰ˆæœ¬æ¦‚è¿°

### 1.1 ç‰ˆæœ¬ç›®æ ‡

V9.0 æ˜¯ My-Chat-LangChain é¡¹ç›®çš„é‡å¤§å‡çº§ç‰ˆæœ¬ï¼Œæ ¸å¿ƒç›®æ ‡æ˜¯ï¼š

1. **å‰ç«¯ç°ä»£åŒ–**: ä½¿ç”¨ Next.js + shadcn/ui å®Œå…¨é‡æ„å‰ç«¯ï¼Œæ›¿ä»£ Streamlit
2. **å¤šæ¨¡æ€äº¤äº’**: æ”¯æŒå›¾ç‰‡ç†è§£/OCR å’Œè¯­éŸ³äº¤äº’
3. **RAG èƒ½åŠ›å¢å¼º**: æ··åˆæ£€ç´¢ã€å¼•ç”¨è¿½æº¯ã€é‡æ’åºã€MinerU æ–‡æ¡£è§£æ
4. **ç”¨æˆ·ç³»ç»Ÿ**: ä¼ ç»Ÿè´¦å·è®¤è¯ + JWT
5. **ç”Ÿäº§çº§éƒ¨ç½²**: Docker Compose ä¸€é”®éƒ¨ç½²

### 1.2 ç‰ˆæœ¬å¯¹æ¯”

```
V8.0 (å½“å‰)                              V9.0 (ç›®æ ‡)
â”œâ”€â”€ Streamlit å‰ç«¯                        â”œâ”€â”€ Next.js 14 + shadcn/ui å‰ç«¯
â”œâ”€â”€ æ— ç”¨æˆ·ç³»ç»Ÿ                            â”œâ”€â”€ å®Œæ•´ç”¨æˆ·è®¤è¯ç³»ç»Ÿ (JWT)
â”œâ”€â”€ ChromaDB å‘é‡å­˜å‚¨                     â”œâ”€â”€ Milvus å‘é‡æ•°æ®åº“
â”œâ”€â”€ SQLite æŒä¹…åŒ–                         â”œâ”€â”€ PostgreSQL ç”¨æˆ·æ•°æ®åº“
â”œâ”€â”€ æ–‡æœ¬èŠå¤©                              â”œâ”€â”€ æ–‡æœ¬ + å›¾ç‰‡ + è¯­éŸ³ å¤šæ¨¡æ€
â”œâ”€â”€ åŸºç¡€ RAG æ£€ç´¢                         â”œâ”€â”€ æ··åˆæ£€ç´¢ + é‡æ’åº + å¼•ç”¨è¿½æº¯
â”œâ”€â”€ æ‰‹åŠ¨æ–‡ä»¶ä¸Šä¼ è§£æ                       â”œâ”€â”€ MinerU æ™ºèƒ½æ–‡æ¡£è§£æ
â”œâ”€â”€ å•å®¹å™¨éƒ¨ç½²                            â”œâ”€â”€ Docker Compose å¾®æœåŠ¡éƒ¨ç½²
â””â”€â”€ 96+ å·¥å…·                              â””â”€â”€ 96+ å·¥å…· (ä¿æŒ)
```

### 1.3 æ ¸å¿ƒåŠŸèƒ½æ¸…å•

| åŠŸèƒ½æ¨¡å— | å­åŠŸèƒ½ | ä¼˜å…ˆçº§ | é˜¶æ®µ |
|---------|--------|--------|------|
| **Next.js å‰ç«¯** | èŠå¤©ç•Œé¢ | P0 | Phase 1 |
| | æ¶ˆæ¯æµå¼æ¸²æŸ“ | P0 | Phase 1 |
| | å·¥å…·è°ƒç”¨å¯è§†åŒ– | P0 | Phase 1 |
| | å›¾è¡¨/å›¾ç‰‡æ¸²æŸ“ | P0 | Phase 1 |
| | å“åº”å¼è®¾è®¡ | P1 | Phase 1 |
| | æš—è‰²æ¨¡å¼ | P2 | Phase 1 |
| **ç”¨æˆ·ç³»ç»Ÿ** | æ³¨å†Œ/ç™»å½• | P0 | Phase 1 |
| | JWT è®¤è¯ | P0 | Phase 1 |
| | ä¼šè¯ç®¡ç† | P0 | Phase 1 |
| | ç”¨æˆ·è®¾ç½® | P1 | Phase 1 |
| | API Key ç®¡ç† | P1 | Phase 1 |
| **å¤šæ¨¡æ€** | å›¾ç‰‡ä¸Šä¼ ä¸ç†è§£ | P0 | Phase 2 |
| | OCR æ–‡å­—è¯†åˆ« | P1 | Phase 2 |
| | è¯­éŸ³è¾“å…¥ (Whisper) | P1 | Phase 2 |
| | è¯­éŸ³è¾“å‡º (Edge TTS) | P2 | Phase 2 |
| **RAG å¢å¼º** | Milvus å‘é‡å­˜å‚¨è¿ç§» | P0 | Phase 3 |
| | æ··åˆæ£€ç´¢ (å‘é‡+BM25) | P0 | Phase 3 |
| | å¼•ç”¨è¿½æº¯ | P0 | Phase 3 |
| | Reranker é‡æ’åº | P1 | Phase 3 |
| | MinerU æ–‡æ¡£è§£æ | P1 | Phase 3 |
| | å¤šè½®å¯¹è¯æ£€ç´¢ | P2 | Phase 3 |
| **éƒ¨ç½²** | Docker Compose | P0 | Phase 1 |
| | ç¯å¢ƒé…ç½®ç®¡ç† | P0 | Phase 1 |
| | å¥åº·æ£€æŸ¥ | P1 | Phase 1 |

---

## äºŒã€éœ€æ±‚è§„æ ¼è¯´æ˜

### 2.1 åŠŸèƒ½éœ€æ±‚

#### 2.1.1 Next.js å‰ç«¯ (FR-01)

**FR-01-01: å¯¹è¯å¼èŠå¤©ç•Œé¢**
- ç±»ä¼¼ ChatGPT çš„å¯¹è¯ UI é£æ ¼
- æ”¯æŒ Markdown æ¸²æŸ“ï¼ˆä»£ç é«˜äº®ã€è¡¨æ ¼ã€åˆ—è¡¨ç­‰ï¼‰
- æ”¯æŒ LaTeX æ•°å­¦å…¬å¼æ¸²æŸ“
- æ¶ˆæ¯æ°”æ³¡åŒºåˆ†ç”¨æˆ·/AI
- æ”¯æŒæ¶ˆæ¯å¤åˆ¶ã€é‡æ–°ç”Ÿæˆ
- è¾“å…¥æ¡†æ”¯æŒå¤šè¡Œã€å¿«æ·é”®å‘é€

**FR-01-02: æµå¼å“åº”æ¸²æŸ“**
- å®æ—¶æ˜¾ç¤º AI å›å¤ï¼ˆSSE/WebSocketï¼‰
- æ‰“å­—æœºæ•ˆæœé€å­—æ˜¾ç¤º
- æ”¯æŒä¸­æ–­ç”Ÿæˆ
- åŠ è½½çŠ¶æ€æŒ‡ç¤º

**FR-01-03: å·¥å…·è°ƒç”¨å¯è§†åŒ–**
- æŠ˜å å¼å·¥å…·è°ƒç”¨é¢æ¿
- æ˜¾ç¤ºå·¥å…·åç§°ã€å‚æ•°ã€è€—æ—¶
- å·¥å…·æ‰§è¡ŒçŠ¶æ€æŒ‡ç¤ºï¼ˆè¿›è¡Œä¸­/æˆåŠŸ/å¤±è´¥ï¼‰
- å·¥å…·è¾“å‡ºæ™ºèƒ½æ‘˜è¦ï¼ˆéåŸå§‹ JSONï¼‰

**FR-01-04: å¤šåª’ä½“æ¸²æŸ“**
- å›¾è¡¨æ¸²æŸ“ï¼ˆBase64 å›¾ç‰‡ï¼‰
- ä»£ç å—è¯­æ³•é«˜äº®
- è¡¨æ ¼å“åº”å¼æ˜¾ç¤º
- å¤–éƒ¨å›¾ç‰‡æ‡’åŠ è½½

**FR-01-05: ä¾§è¾¹æ åŠŸèƒ½**
- ä¼šè¯å†å²åˆ—è¡¨
- æ–°å»º/åˆ é™¤/é‡å‘½åä¼šè¯
- ä¼šè¯æœç´¢
- ç”¨æˆ·è®¾ç½®å…¥å£
- API Key é…ç½®

**FR-01-06: å“åº”å¼è®¾è®¡**
- æ¡Œé¢ç«¯å®Œæ•´åŠŸèƒ½
- ç§»åŠ¨ç«¯è‡ªé€‚åº”å¸ƒå±€
- ä¾§è¾¹æ å¯æŠ˜å 

#### 2.1.2 ç”¨æˆ·è®¤è¯ç³»ç»Ÿ (FR-02)

**FR-02-01: ç”¨æˆ·æ³¨å†Œ**
- ç”¨æˆ·å + é‚®ç®± + å¯†ç æ³¨å†Œ
- å¯†ç å¼ºåº¦éªŒè¯
- ç”¨æˆ·å/é‚®ç®±å”¯ä¸€æ€§æ£€æŸ¥
- æ³¨å†ŒæˆåŠŸè‡ªåŠ¨ç™»å½•

**FR-02-02: ç”¨æˆ·ç™»å½•**
- ç”¨æˆ·å/é‚®ç®± + å¯†ç ç™»å½•
- JWT Token ç”Ÿæˆä¸éªŒè¯
- è®°ä½ç™»å½•çŠ¶æ€ï¼ˆRefresh Tokenï¼‰
- ç™»å½•å¤±è´¥æ¬¡æ•°é™åˆ¶

**FR-02-03: ä¼šè¯ç®¡ç†**
- Token è‡ªåŠ¨åˆ·æ–°
- å¤šè®¾å¤‡ç™»å½•æ”¯æŒ
- å¼ºåˆ¶ç™»å‡ºåŠŸèƒ½
- ä¼šè¯è¿‡æœŸæç¤º

**FR-02-04: ç”¨æˆ·è®¾ç½®**
- ä¿®æ”¹å¯†ç 
- ä¿®æ”¹ç”¨æˆ·å/é‚®ç®±
- ä¸ªäºº API Key ç®¡ç†
- åå¥½è®¾ç½®ï¼ˆä¸»é¢˜ã€è¯­è¨€ç­‰ï¼‰

**FR-02-05: æƒé™æ§åˆ¶**
- æœªç™»å½•ï¼šä»…å¯è®¿é—®ç™»å½•/æ³¨å†Œé¡µ
- å·²ç™»å½•ï¼šå®Œæ•´åŠŸèƒ½è®¿é—®
- API è¯·æ±‚ Token éªŒè¯

#### 2.1.3 å¤šæ¨¡æ€èƒ½åŠ› (FR-03)

**FR-03-01: å›¾ç‰‡ç†è§£**
- æ”¯æŒä¸Šä¼ å›¾ç‰‡ï¼ˆJPG/PNG/GIF/WebPï¼‰
- æ”¯æŒç²˜è´´å‰ªè´´æ¿å›¾ç‰‡
- æ”¯æŒæ‹–æ‹½ä¸Šä¼ 
- å›¾ç‰‡é¢„è§ˆä¸åˆ é™¤
- è°ƒç”¨ Gemini Vision API åˆ†æå›¾ç‰‡
- æ”¯æŒå¤šå›¾åŒæ—¶ä¸Šä¼ 

**FR-03-02: OCR æ–‡å­—è¯†åˆ«**
- è¯†åˆ«å›¾ç‰‡ä¸­çš„æ–‡å­—
- æ”¯æŒä¸­è‹±æ–‡æ··åˆè¯†åˆ«
- è¿”å›ç»“æ„åŒ–æ–‡æœ¬

**FR-03-03: è¯­éŸ³è¾“å…¥**
- å½•éŸ³æŒ‰é’®ï¼ˆæŒ‰ä½å½•éŸ³/ç‚¹å‡»åˆ‡æ¢ï¼‰
- æœ¬åœ° Whisper è¯­éŸ³è¯†åˆ«
- è¯†åˆ«ç»“æœå¡«å…¥è¾“å…¥æ¡†
- æ”¯æŒä¸­æ–‡/è‹±æ–‡/æ··åˆè¯­éŸ³

**FR-03-04: è¯­éŸ³è¾“å‡º**
- AI å›å¤æ–‡å­—è½¬è¯­éŸ³
- Edge TTS è¯­éŸ³åˆæˆ
- æ’­æ”¾/æš‚åœæ§åˆ¶
- è¯­éŸ³é€‰æ‹©ï¼ˆå£°éŸ³ç±»å‹ï¼‰

#### 2.1.4 RAG å¢å¼º (FR-04)

**FR-04-01: Milvus å‘é‡å­˜å‚¨**
- è¿ç§» ChromaDB è‡³ Milvus
- æ”¯æŒå¤§è§„æ¨¡å‘é‡å­˜å‚¨
- é«˜æ€§èƒ½ç›¸ä¼¼åº¦æœç´¢
- Collection ç®¡ç†

**FR-04-02: æ··åˆæ£€ç´¢**
- å‘é‡ç›¸ä¼¼åº¦æ£€ç´¢
- BM25 å…³é”®è¯æ£€ç´¢
- RRF (Reciprocal Rank Fusion) èåˆ
- å¯é…ç½®æ£€ç´¢æƒé‡

**FR-04-03: å¼•ç”¨è¿½æº¯**
- æ¯æ®µå›å¤æ ‡æ³¨æ¥æºæ–‡æ¡£
- æ˜¾ç¤ºå…·ä½“é¡µç /ç« èŠ‚
- ç‚¹å‡»å¼•ç”¨è·³è½¬åŸæ–‡
- å¼•ç”¨ç½®ä¿¡åº¦è¯„åˆ†

**FR-04-04: ç»“æœé‡æ’åº**
- ä½¿ç”¨ Reranker æ¨¡å‹ï¼ˆå¦‚ bge-rerankerï¼‰
- å¯¹æ£€ç´¢ç»“æœäºŒæ¬¡æ’åº
- æå‡ç›¸å…³æ€§å‡†ç¡®åº¦

**FR-04-05: MinerU æ–‡æ¡£è§£æ**
- è°ƒç”¨ MinerU äº‘æœåŠ¡ API
- æ”¯æŒ PDF/Word/PPT ç­‰æ ¼å¼
- æ™ºèƒ½åˆ†å—ï¼ˆè¯­ä¹‰åˆ‡åˆ†ï¼‰
- è¡¨æ ¼/å›¾è¡¨æå–
- å…¬å¼è¯†åˆ«

**FR-04-06: å¤šè½®å¯¹è¯æ£€ç´¢**
- å¯¹è¯å†å²ä¸Šä¸‹æ–‡ç†è§£
- æŸ¥è¯¢æ”¹å†™ï¼ˆQuery Rewritingï¼‰
- è¿½é—®åœºæ™¯ä¼˜åŒ–

#### 2.1.5 éƒ¨ç½²ä¸è¿ç»´ (FR-05)

**FR-05-01: Docker Compose éƒ¨ç½²**
- ä¸€é”®å¯åŠ¨æ‰€æœ‰æœåŠ¡
- æœåŠ¡ä¾èµ–ç®¡ç†
- ç½‘ç»œéš”ç¦»é…ç½®
- æ•°æ®å·æŒä¹…åŒ–

**FR-05-02: ç¯å¢ƒé…ç½®**
- ç¯å¢ƒå˜é‡ç»Ÿä¸€ç®¡ç†
- å¼€å‘/ç”Ÿäº§ç¯å¢ƒåˆ†ç¦»
- æ•æ„Ÿä¿¡æ¯åŠ å¯†

**FR-05-03: å¥åº·æ£€æŸ¥**
- æœåŠ¡å­˜æ´»æ£€æŸ¥
- ä¾èµ–æœåŠ¡æ£€æŸ¥
- è‡ªåŠ¨é‡å¯ç­–ç•¥

### 2.2 éåŠŸèƒ½éœ€æ±‚

#### 2.2.1 æ€§èƒ½éœ€æ±‚ (NFR-01)

| æŒ‡æ ‡ | ç›®æ ‡å€¼ |
|------|--------|
| é¦–å±åŠ è½½æ—¶é—´ | < 2s |
| æ¶ˆæ¯å‘é€å“åº” | < 500ms |
| æµå¼é¦– Token | < 1s |
| RAG æ£€ç´¢å»¶è¿Ÿ | < 500ms |
| å¹¶å‘ç”¨æˆ·æ•° | 100+ |

#### 2.2.2 å®‰å…¨éœ€æ±‚ (NFR-02)

- å¯†ç  bcrypt åŠ å¯†å­˜å‚¨
- JWT Token ç­¾åéªŒè¯
- HTTPS ä¼ è¾“åŠ å¯†
- SQL æ³¨å…¥é˜²æŠ¤
- XSS é˜²æŠ¤
- CORS é…ç½®

#### 2.2.3 å¯ç”¨æ€§éœ€æ±‚ (NFR-03)

- æœåŠ¡å¯ç”¨æ€§ > 99%
- ä¼˜é›…é™çº§ï¼ˆå¤–éƒ¨æœåŠ¡æ•…éšœæ—¶ï¼‰
- é”™è¯¯æç¤ºç”¨æˆ·å‹å¥½

#### 2.2.4 å¯ç»´æŠ¤æ€§éœ€æ±‚ (NFR-04)

- ä»£ç è§„èŒƒä¸€è‡´
- å®Œæ•´çš„é”™è¯¯æ—¥å¿—
- API æ–‡æ¡£è‡ªåŠ¨ç”Ÿæˆ
- å•å…ƒæµ‹è¯•è¦†ç›–ç‡ > 60%

---

## ä¸‰ã€ç³»ç»Ÿæ¶æ„è®¾è®¡

### 3.1 æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           My-Chat-LangChain V9.0                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                        Frontend (Next.js 14)                         â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚ Chat Page â”‚ â”‚Login/Reg  â”‚ â”‚ Settings  â”‚ â”‚ Conversation List â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚                    shadcn/ui + Tailwind                      â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â”‚                                        â”‚
â”‚                          HTTP/REST + SSE                                    â”‚
â”‚                                    â”‚                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                        API Gateway (Nginx)                           â”‚   â”‚
â”‚  â”‚                    - åå‘ä»£ç† - SSL ç»ˆæ­¢ - è´Ÿè½½å‡è¡¡                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â”‚                                        â”‚
â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚          â”‚                         â”‚                         â”‚              â”‚
â”‚          â–¼                         â–¼                         â–¼              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  Auth Service â”‚        â”‚  Chat Service â”‚        â”‚  RAG Service  â”‚       â”‚
â”‚  â”‚  (FastAPI)    â”‚        â”‚  (FastAPI)    â”‚        â”‚  (FastAPI)    â”‚       â”‚
â”‚  â”‚               â”‚        â”‚               â”‚        â”‚               â”‚       â”‚
â”‚  â”‚ - ç”¨æˆ·æ³¨å†Œ    â”‚        â”‚ - èŠå¤©æµå¼    â”‚        â”‚ - æ–‡æ¡£è§£æ    â”‚       â”‚
â”‚  â”‚ - ç”¨æˆ·ç™»å½•    â”‚        â”‚ - Agent è°ƒç”¨  â”‚        â”‚ - å‘é‡æ£€ç´¢    â”‚       â”‚
â”‚  â”‚ - Token ç®¡ç†  â”‚        â”‚ - å·¥å…·æ‰§è¡Œ    â”‚        â”‚ - æ··åˆæ£€ç´¢    â”‚       â”‚
â”‚  â”‚ - æƒé™éªŒè¯    â”‚        â”‚ - ä¼šè¯ç®¡ç†    â”‚        â”‚ - é‡æ’åº      â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚          â”‚                         â”‚                         â”‚              â”‚
â”‚          â”‚                         â”‚                         â”‚              â”‚
â”‚          â–¼                         â–¼                         â–¼              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚                         Data Layer                                 â”‚     â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚     â”‚
â”‚  â”‚  â”‚ PostgreSQL  â”‚  â”‚   Milvus    â”‚  â”‚    Redis    â”‚  â”‚ MinIO/S3 â”‚ â”‚     â”‚
â”‚  â”‚  â”‚ - ç”¨æˆ·æ•°æ®  â”‚  â”‚ - å‘é‡å­˜å‚¨  â”‚  â”‚ - ä¼šè¯ç¼“å­˜  â”‚  â”‚ - æ–‡ä»¶   â”‚ â”‚     â”‚
â”‚  â”‚  â”‚ - ä¼šè¯è®°å½•  â”‚  â”‚ - ç›¸ä¼¼æœç´¢  â”‚  â”‚ - Token     â”‚  â”‚   å­˜å‚¨   â”‚ â”‚     â”‚
â”‚  â”‚  â”‚ - è®¾ç½®é…ç½®  â”‚  â”‚             â”‚  â”‚             â”‚  â”‚          â”‚ â”‚     â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚                       External Services                            â”‚     â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚     â”‚
â”‚  â”‚  â”‚ Gemini  â”‚ â”‚  E2B    â”‚ â”‚  MCP    â”‚ â”‚ MinerU  â”‚ â”‚ Whisper     â”‚ â”‚     â”‚
â”‚  â”‚  â”‚ Vision  â”‚ â”‚ Sandbox â”‚ â”‚ Tools   â”‚ â”‚  API    â”‚ â”‚ (Local)     â”‚ â”‚     â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 æœåŠ¡æ‹†åˆ†

| æœåŠ¡ | èŒè´£ | æŠ€æœ¯æ ˆ | ç«¯å£ |
|------|------|--------|------|
| **frontend** | Next.js å‰ç«¯åº”ç”¨ | Next.js 14, React 18, shadcn/ui | 3000 |
| **auth-service** | ç”¨æˆ·è®¤è¯æœåŠ¡ | FastAPI, SQLAlchemy | 8001 |
| **chat-service** | èŠå¤©æ ¸å¿ƒæœåŠ¡ | FastAPI, LangGraph | 8000 |
| **rag-service** | RAG æ£€ç´¢æœåŠ¡ | FastAPI, LangChain | 8002 |
| **whisper-service** | è¯­éŸ³è¯†åˆ«æœåŠ¡ | FastAPI, faster-whisper | 8003 |
| **nginx** | API ç½‘å…³ | Nginx | 80/443 |
| **postgres** | å…³ç³»æ•°æ®åº“ | PostgreSQL 15 | 5432 |
| **milvus** | å‘é‡æ•°æ®åº“ | Milvus 2.x | 19530 |
| **redis** | ç¼“å­˜/ä¼šè¯ | Redis 7 | 6379 |
| **minio** | æ–‡ä»¶å­˜å‚¨ | MinIO | 9000 |

### 3.3 æœåŠ¡é—´é€šä¿¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     HTTP/REST      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Frontend  â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚   Nginx     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                                           â”‚
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚                  â”‚                  â”‚
                        â–¼                  â–¼                  â–¼
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ Auth Service  â”‚  â”‚ Chat Service  â”‚  â”‚  RAG Service  â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚                  â”‚                  â”‚
                        â”‚    Internal gRPC/HTTP              â”‚
                        â”‚                  â”‚                  â”‚
                        â–¼                  â–¼                  â–¼
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                    Data Layer                        â”‚
                â”‚  PostgreSQL â”‚ Milvus â”‚ Redis â”‚ MinIO                â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.4 æŠ€æœ¯é€‰å‹è¯¦è§£

| ç±»åˆ« | æŠ€æœ¯ | ç‰ˆæœ¬ | é€‰å‹ç†ç”± |
|------|------|------|---------|
| **å‰ç«¯æ¡†æ¶** | Next.js | 14.x | App Routerã€SSRã€API Routes |
| **UI ç»„ä»¶åº“** | shadcn/ui | latest | å¯å®šåˆ¶ã€ç°ä»£ã€ä¸ Tailwind é›†æˆ |
| **CSS æ¡†æ¶** | Tailwind CSS | 3.x | åŸå­åŒ– CSSã€å“åº”å¼ |
| **çŠ¶æ€ç®¡ç†** | Zustand | 4.x | è½»é‡ã€ç®€æ´ã€TypeScript å‹å¥½ |
| **HTTP å®¢æˆ·ç«¯** | Axios | 1.x | æ‹¦æˆªå™¨ã€è¯·æ±‚å–æ¶ˆ |
| **åç«¯æ¡†æ¶** | FastAPI | 0.115+ | å¼‚æ­¥ã€è‡ªåŠ¨æ–‡æ¡£ã€ç±»å‹å®‰å…¨ |
| **ORM** | SQLAlchemy | 2.x | æˆç†Ÿã€åŠŸèƒ½å…¨é¢ |
| **è®¤è¯** | python-jose | 3.x | JWT å¤„ç† |
| **å¯†ç åŠ å¯†** | passlib[bcrypt] | 1.7+ | è¡Œä¸šæ ‡å‡† |
| **å‘é‡æ•°æ®åº“** | Milvus | 2.x | é«˜æ€§èƒ½ã€åˆ†å¸ƒå¼ã€åŠŸèƒ½ä¸°å¯Œ |
| **å…³ç³»æ•°æ®åº“** | PostgreSQL | 15.x | ç¨³å®šã€åŠŸèƒ½å¼ºå¤§ |
| **ç¼“å­˜** | Redis | 7.x | é«˜æ€§èƒ½ã€ä¼šè¯å­˜å‚¨ |
| **æ–‡ä»¶å­˜å‚¨** | MinIO | latest | S3 å…¼å®¹ã€è‡ªæ‰˜ç®¡ |
| **è¯­éŸ³è¯†åˆ«** | faster-whisper | 1.x | æœ¬åœ°è¿è¡Œã€é«˜ç²¾åº¦ |
| **è¯­éŸ³åˆæˆ** | edge-tts | 6.x | å…è´¹ã€é«˜è´¨é‡ |
| **æ–‡æ¡£è§£æ** | MinerU API | - | æ™ºèƒ½åˆ†å—ã€OCR |
| **å®¹å™¨ç¼–æ’** | Docker Compose | 2.x | ç®€å•éƒ¨ç½² |

---

## å››ã€æ¨¡å—è¯¦ç»†è®¾è®¡

### 4.1 å‰ç«¯æ¨¡å—è®¾è®¡

#### 4.1.1 é¡¹ç›®ç»“æ„

```
frontend/
â”œâ”€â”€ app/                          # Next.js App Router
â”‚   â”œâ”€â”€ (auth)/                   # è®¤è¯ç›¸å…³è·¯ç”±ç»„
â”‚   â”‚   â”œâ”€â”€ login/
â”‚   â”‚   â”‚   â””â”€â”€ page.tsx
â”‚   â”‚   â”œâ”€â”€ register/
â”‚   â”‚   â”‚   â””â”€â”€ page.tsx
â”‚   â”‚   â””â”€â”€ layout.tsx
â”‚   â”œâ”€â”€ (main)/                   # ä¸»åº”ç”¨è·¯ç”±ç»„
â”‚   â”‚   â”œâ”€â”€ chat/
â”‚   â”‚   â”‚   â”œâ”€â”€ [id]/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ page.tsx      # å•ä¸ªä¼šè¯é¡µé¢
â”‚   â”‚   â”‚   â””â”€â”€ page.tsx          # æ–°ä¼šè¯é¡µé¢
â”‚   â”‚   â”œâ”€â”€ settings/
â”‚   â”‚   â”‚   â””â”€â”€ page.tsx
â”‚   â”‚   â””â”€â”€ layout.tsx            # å¸¦ä¾§è¾¹æ çš„å¸ƒå±€
â”‚   â”œâ”€â”€ api/                      # API Routes (å¯é€‰)
â”‚   â”‚   â””â”€â”€ auth/
â”‚   â”‚       â””â”€â”€ [...nextauth]/
â”‚   â”‚           â””â”€â”€ route.ts
â”‚   â”œâ”€â”€ layout.tsx                # æ ¹å¸ƒå±€
â”‚   â”œâ”€â”€ page.tsx                  # é¦–é¡µï¼ˆé‡å®šå‘åˆ° /chatï¼‰
â”‚   â””â”€â”€ globals.css
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ chat/
â”‚   â”‚   â”œâ”€â”€ ChatContainer.tsx     # èŠå¤©å®¹å™¨
â”‚   â”‚   â”œâ”€â”€ MessageList.tsx       # æ¶ˆæ¯åˆ—è¡¨
â”‚   â”‚   â”œâ”€â”€ MessageBubble.tsx     # å•æ¡æ¶ˆæ¯æ°”æ³¡
â”‚   â”‚   â”œâ”€â”€ InputArea.tsx         # è¾“å…¥åŒºåŸŸ
â”‚   â”‚   â”œâ”€â”€ ToolCallPanel.tsx     # å·¥å…·è°ƒç”¨é¢æ¿
â”‚   â”‚   â”œâ”€â”€ CodeBlock.tsx         # ä»£ç å—ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ ImageUploader.tsx     # å›¾ç‰‡ä¸Šä¼ 
â”‚   â”‚   â””â”€â”€ VoiceRecorder.tsx     # è¯­éŸ³å½•åˆ¶
â”‚   â”œâ”€â”€ sidebar/
â”‚   â”‚   â”œâ”€â”€ Sidebar.tsx           # ä¾§è¾¹æ ä¸»ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ ConversationList.tsx  # ä¼šè¯åˆ—è¡¨
â”‚   â”‚   â”œâ”€â”€ ConversationItem.tsx  # å•ä¸ªä¼šè¯é¡¹
â”‚   â”‚   â””â”€â”€ UserMenu.tsx          # ç”¨æˆ·èœå•
â”‚   â”œâ”€â”€ settings/
â”‚   â”‚   â”œâ”€â”€ SettingsPanel.tsx
â”‚   â”‚   â”œâ”€â”€ APIKeyForm.tsx
â”‚   â”‚   â””â”€â”€ ThemeSelector.tsx
â”‚   â”œâ”€â”€ ui/                       # shadcn/ui ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ button.tsx
â”‚   â”‚   â”œâ”€â”€ input.tsx
â”‚   â”‚   â”œâ”€â”€ dialog.tsx
â”‚   â”‚   â””â”€â”€ ...
â”‚   â””â”€â”€ providers/
â”‚       â”œâ”€â”€ AuthProvider.tsx
â”‚       â””â”€â”€ ThemeProvider.tsx
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ client.ts             # Axios å®¢æˆ·ç«¯
â”‚   â”‚   â”œâ”€â”€ auth.ts               # è®¤è¯ API
â”‚   â”‚   â”œâ”€â”€ chat.ts               # èŠå¤© API
â”‚   â”‚   â””â”€â”€ rag.ts                # RAG API
â”‚   â”œâ”€â”€ hooks/
â”‚   â”‚   â”œâ”€â”€ useAuth.ts
â”‚   â”‚   â”œâ”€â”€ useChat.ts
â”‚   â”‚   â”œâ”€â”€ useSSE.ts             # SSE æµå¼å¤„ç†
â”‚   â”‚   â””â”€â”€ useVoice.ts
â”‚   â”œâ”€â”€ stores/
â”‚   â”‚   â”œâ”€â”€ authStore.ts          # Zustand è®¤è¯çŠ¶æ€
â”‚   â”‚   â”œâ”€â”€ chatStore.ts          # èŠå¤©çŠ¶æ€
â”‚   â”‚   â””â”€â”€ settingsStore.ts      # è®¾ç½®çŠ¶æ€
â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â”œâ”€â”€ markdown.ts           # Markdown å¤„ç†
â”‚   â”‚   â”œâ”€â”€ format.ts             # æ ¼å¼åŒ–å·¥å…·
â”‚   â”‚   â””â”€â”€ storage.ts            # æœ¬åœ°å­˜å‚¨
â”‚   â””â”€â”€ types/
â”‚       â”œâ”€â”€ auth.ts
â”‚       â”œâ”€â”€ chat.ts
â”‚       â””â”€â”€ api.ts
â”œâ”€â”€ public/
â”‚   â””â”€â”€ ...
â”œâ”€â”€ tailwind.config.ts
â”œâ”€â”€ next.config.js
â”œâ”€â”€ package.json
â””â”€â”€ tsconfig.json
```

#### 4.1.2 æ ¸å¿ƒç»„ä»¶è®¾è®¡

**MessageBubble ç»„ä»¶**

```typescript
// components/chat/MessageBubble.tsx

interface MessageBubbleProps {
  message: Message;
  isStreaming?: boolean;
  onRegenerate?: () => void;
  onCopy?: () => void;
}

interface Message {
  id: string;
  role: 'user' | 'assistant';
  content: string;
  timestamp: Date;
  toolCalls?: ToolCall[];
  images?: string[];      // Base64 å›¾ç‰‡
  citations?: Citation[]; // å¼•ç”¨æ¥æº
}

interface ToolCall {
  id: string;
  name: string;
  args: Record<string, any>;
  status: 'running' | 'success' | 'error';
  output?: string;
  duration?: number;
}

interface Citation {
  sourceId: string;
  sourceName: string;
  pageNumber?: number;
  content: string;
  confidence: number;
}
```

**InputArea ç»„ä»¶**

```typescript
// components/chat/InputArea.tsx

interface InputAreaProps {
  onSend: (message: string, images?: File[]) => void;
  onVoiceInput: (transcript: string) => void;
  disabled?: boolean;
  placeholder?: string;
}

// åŠŸèƒ½:
// - å¤šè¡Œæ–‡æœ¬è¾“å…¥ (Shift+Enter æ¢è¡Œ, Enter å‘é€)
// - å›¾ç‰‡ä¸Šä¼ æŒ‰é’® (æ”¯æŒå¤šé€‰)
// - å›¾ç‰‡æ‹–æ‹½ä¸Šä¼ 
// - å›¾ç‰‡ç²˜è´´ (Ctrl+V)
// - è¯­éŸ³å½•åˆ¶æŒ‰é’®
// - å‘é€æŒ‰é’®
// - å·²é€‰å›¾ç‰‡é¢„è§ˆæ¡
```

#### 4.1.3 çŠ¶æ€ç®¡ç†

**è®¤è¯çŠ¶æ€ (authStore.ts)**

```typescript
import { create } from 'zustand';
import { persist } from 'zustand/middleware';

interface AuthState {
  user: User | null;
  accessToken: string | null;
  refreshToken: string | null;
  isAuthenticated: boolean;
  isLoading: boolean;

  login: (email: string, password: string) => Promise<void>;
  register: (data: RegisterData) => Promise<void>;
  logout: () => void;
  refreshAccessToken: () => Promise<void>;
}

export const useAuthStore = create<AuthState>()(
  persist(
    (set, get) => ({
      user: null,
      accessToken: null,
      refreshToken: null,
      isAuthenticated: false,
      isLoading: false,

      login: async (email, password) => { /* ... */ },
      register: async (data) => { /* ... */ },
      logout: () => { /* ... */ },
      refreshAccessToken: async () => { /* ... */ },
    }),
    {
      name: 'auth-storage',
      partialize: (state) => ({
        accessToken: state.accessToken,
        refreshToken: state.refreshToken,
      }),
    }
  )
);
```

**èŠå¤©çŠ¶æ€ (chatStore.ts)**

```typescript
interface ChatState {
  conversations: Conversation[];
  currentConversationId: string | null;
  messages: Message[];
  isStreaming: boolean;

  // Actions
  createConversation: () => Promise<string>;
  loadConversation: (id: string) => Promise<void>;
  deleteConversation: (id: string) => Promise<void>;
  sendMessage: (content: string, images?: File[]) => Promise<void>;
  stopStreaming: () => void;
  regenerateMessage: (messageId: string) => Promise<void>;
}
```

### 4.2 åç«¯æ¨¡å—è®¾è®¡

#### 4.2.1 Auth Service

```
backend/auth-service/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ main.py                 # FastAPI åº”ç”¨å…¥å£
â”‚   â”œâ”€â”€ config.py               # é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ database.py             # æ•°æ®åº“è¿æ¥
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ user.py             # ç”¨æˆ·æ¨¡å‹
â”‚   â”œâ”€â”€ schemas/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ user.py             # ç”¨æˆ· Schema
â”‚   â”‚   â””â”€â”€ token.py            # Token Schema
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ v1/
â”‚   â”‚       â”œâ”€â”€ __init__.py
â”‚   â”‚       â”œâ”€â”€ auth.py         # è®¤è¯è·¯ç”±
â”‚   â”‚       â””â”€â”€ users.py        # ç”¨æˆ·è·¯ç”±
â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ security.py         # å¯†ç åŠ å¯†ã€Token ç”Ÿæˆ
â”‚   â”‚   â””â”€â”€ deps.py             # ä¾èµ–æ³¨å…¥
â”‚   â””â”€â”€ services/
â”‚       â”œâ”€â”€ __init__.py
â”‚       â””â”€â”€ user_service.py     # ç”¨æˆ·ä¸šåŠ¡é€»è¾‘
â”œâ”€â”€ requirements.txt
â””â”€â”€ Dockerfile
```

**æ ¸å¿ƒæ¥å£:**

```python
# app/api/v1/auth.py

@router.post("/register", response_model=UserResponse)
async def register(user_data: UserCreate, db: Session = Depends(get_db)):
    """ç”¨æˆ·æ³¨å†Œ"""
    pass

@router.post("/login", response_model=TokenResponse)
async def login(form_data: OAuth2PasswordRequestForm = Depends()):
    """ç”¨æˆ·ç™»å½•"""
    pass

@router.post("/refresh", response_model=TokenResponse)
async def refresh_token(refresh_token: str):
    """åˆ·æ–° Access Token"""
    pass

@router.post("/logout")
async def logout(current_user: User = Depends(get_current_user)):
    """ç”¨æˆ·ç™»å‡º"""
    pass
```

#### 4.2.2 Chat Service (ç°æœ‰æ”¹é€ )

```
backend/chat-service/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ main.py                 # FastAPI å…¥å£ (åŸ backend/main.py)
â”‚   â”œâ”€â”€ config.py
â”‚   â”œâ”€â”€ agent_service.py        # Agent æ ¸å¿ƒ (ä¿æŒ)
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”œâ”€â”€ conversation.py     # ä¼šè¯æ¨¡å‹
â”‚   â”‚   â””â”€â”€ message.py          # æ¶ˆæ¯æ¨¡å‹
â”‚   â”œâ”€â”€ schemas/
â”‚   â”‚   â”œâ”€â”€ chat.py
â”‚   â”‚   â””â”€â”€ tool.py
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â””â”€â”€ v1/
â”‚   â”‚       â”œâ”€â”€ chat.py         # èŠå¤©è·¯ç”±
â”‚   â”‚       â”œâ”€â”€ conversation.py # ä¼šè¯ç®¡ç†
â”‚   â”‚       â””â”€â”€ upload.py       # æ–‡ä»¶ä¸Šä¼ 
â”‚   â””â”€â”€ tools/                  # å·¥å…·é›† (ä¿æŒ)
â”‚       â”œâ”€â”€ e2b_tools.py
â”‚       â”œâ”€â”€ rag_tools.py
â”‚       â””â”€â”€ search_tools.py
â”œâ”€â”€ requirements.txt
â””â”€â”€ Dockerfile
```

**èŠå¤© API æ”¹é€ :**

```python
# app/api/v1/chat.py

@router.post("/stream")
async def chat_stream(
    request: ChatRequest,
    current_user: User = Depends(get_current_user)
):
    """æµå¼èŠå¤© (éœ€è¦è®¤è¯)"""
    return StreamingResponse(
        generate_stream(request, current_user),
        media_type="text/event-stream"
    )

@router.get("/conversations")
async def list_conversations(
    current_user: User = Depends(get_current_user),
    skip: int = 0,
    limit: int = 20
):
    """è·å–ç”¨æˆ·ä¼šè¯åˆ—è¡¨"""
    pass

@router.post("/conversations")
async def create_conversation(
    current_user: User = Depends(get_current_user)
):
    """åˆ›å»ºæ–°ä¼šè¯"""
    pass

@router.delete("/conversations/{conversation_id}")
async def delete_conversation(
    conversation_id: str,
    current_user: User = Depends(get_current_user)
):
    """åˆ é™¤ä¼šè¯"""
    pass
```

#### 4.2.3 RAG Service

```
backend/rag-service/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ main.py
â”‚   â”œâ”€â”€ config.py
â”‚   â”œâ”€â”€ milvus_client.py        # Milvus å®¢æˆ·ç«¯
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”œâ”€â”€ document.py
â”‚   â”‚   â””â”€â”€ chunk.py
â”‚   â”œâ”€â”€ schemas/
â”‚   â”‚   â”œâ”€â”€ document.py
â”‚   â”‚   â””â”€â”€ search.py
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â””â”€â”€ v1/
â”‚   â”‚       â”œâ”€â”€ documents.py    # æ–‡æ¡£ç®¡ç†
â”‚   â”‚       â”œâ”€â”€ search.py       # æ£€ç´¢æ¥å£
â”‚   â”‚       â””â”€â”€ ingest.py       # æ–‡æ¡£æ‘„å–
â”‚   â””â”€â”€ services/
â”‚       â”œâ”€â”€ embedding_service.py
â”‚       â”œâ”€â”€ search_service.py   # æ··åˆæ£€ç´¢
â”‚       â”œâ”€â”€ rerank_service.py   # é‡æ’åº
â”‚       â””â”€â”€ mineru_service.py   # MinerU é›†æˆ
â”œâ”€â”€ requirements.txt
â””â”€â”€ Dockerfile
```

**æ··åˆæ£€ç´¢å®ç°:**

```python
# app/services/search_service.py

class HybridSearchService:
    def __init__(self, milvus_client, bm25_index, reranker):
        self.milvus = milvus_client
        self.bm25 = bm25_index
        self.reranker = reranker

    async def search(
        self,
        query: str,
        top_k: int = 10,
        alpha: float = 0.5,  # å‘é‡æƒé‡
        rerank: bool = True
    ) -> List[SearchResult]:
        """æ··åˆæ£€ç´¢"""
        # 1. å‘é‡æ£€ç´¢
        vector_results = await self.milvus.search(
            query_embedding=self.embed(query),
            top_k=top_k * 2
        )

        # 2. BM25 å…³é”®è¯æ£€ç´¢
        bm25_results = self.bm25.search(query, top_k=top_k * 2)

        # 3. RRF èåˆ
        fused_results = self.rrf_fusion(
            vector_results, bm25_results, alpha=alpha
        )

        # 4. Reranker é‡æ’åº (å¯é€‰)
        if rerank:
            fused_results = await self.reranker.rerank(
                query, fused_results, top_k=top_k
            )

        return fused_results[:top_k]

    def rrf_fusion(self, vec_results, bm25_results, alpha=0.5):
        """Reciprocal Rank Fusion"""
        scores = {}
        k = 60  # RRF å¸¸æ•°

        for rank, doc in enumerate(vec_results):
            scores[doc.id] = scores.get(doc.id, 0) + alpha / (k + rank)

        for rank, doc in enumerate(bm25_results):
            scores[doc.id] = scores.get(doc.id, 0) + (1-alpha) / (k + rank)

        return sorted(scores.items(), key=lambda x: x[1], reverse=True)
```

#### 4.2.4 Whisper Service

```
backend/whisper-service/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ main.py
â”‚   â”œâ”€â”€ config.py
â”‚   â””â”€â”€ api/
â”‚       â””â”€â”€ v1/
â”‚           â””â”€â”€ transcribe.py
â”œâ”€â”€ requirements.txt
â””â”€â”€ Dockerfile
```

```python
# app/api/v1/transcribe.py

from faster_whisper import WhisperModel

model = WhisperModel("base", device="cpu", compute_type="int8")

@router.post("/transcribe")
async def transcribe_audio(
    file: UploadFile = File(...),
    language: str = "zh"
):
    """è¯­éŸ³è½¬æ–‡å­—"""
    audio_bytes = await file.read()
    segments, info = model.transcribe(
        audio_bytes,
        language=language,
        beam_size=5
    )

    text = "".join([segment.text for segment in segments])
    return {"text": text, "language": info.language}
```

### 4.3 å¤šæ¨¡æ€å¤„ç†æµç¨‹

#### 4.3.1 å›¾ç‰‡ç†è§£æµç¨‹

```
ç”¨æˆ·ä¸Šä¼ å›¾ç‰‡
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‰ç«¯é¢„å¤„ç†      â”‚
â”‚ - å‹ç¼©å›¾ç‰‡      â”‚
â”‚ - è½¬ Base64     â”‚
â”‚ - é¢„è§ˆæ˜¾ç¤º      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‘é€åˆ°åç«¯      â”‚
â”‚ POST /chat/streamâ”‚
â”‚ {               â”‚
â”‚   content: "...",â”‚
â”‚   images: [...]  â”‚
â”‚ }               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Agent Service                        â”‚
â”‚ 1. æ„å»ºå¤šæ¨¡æ€æ¶ˆæ¯                    â”‚
â”‚ 2. è°ƒç”¨ Gemini Vision API            â”‚
â”‚    - å›¾ç‰‡åˆ†æ                        â”‚
â”‚    - ç»“åˆæ–‡æœ¬ prompt                 â”‚
â”‚ 3. æµå¼è¿”å›ç»“æœ                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å¤šæ¨¡æ€æ¶ˆæ¯æ„å»º:**

```python
# agent_service.py

def build_multimodal_message(content: str, images: List[str]) -> dict:
    """æ„å»ºå¤šæ¨¡æ€æ¶ˆæ¯"""
    parts = []

    # æ·»åŠ å›¾ç‰‡
    for img_base64 in images:
        parts.append({
            "type": "image_url",
            "image_url": {
                "url": f"data:image/jpeg;base64,{img_base64}"
            }
        })

    # æ·»åŠ æ–‡æœ¬
    parts.append({
        "type": "text",
        "text": content
    })

    return {"role": "user", "content": parts}
```

#### 4.3.2 è¯­éŸ³äº¤äº’æµç¨‹

```
                        è¯­éŸ³è¾“å…¥æµç¨‹
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·ç‚¹å‡»å½•éŸ³                                                   â”‚
â”‚      â”‚                                                        â”‚
â”‚      â–¼                                                        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                          â”‚
â”‚ â”‚ æµè§ˆå™¨å½•éŸ³ API   â”‚                                          â”‚
â”‚ â”‚ MediaRecorder   â”‚                                          â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                          â”‚
â”‚          â”‚ å½•éŸ³ç»“æŸ                                            â”‚
â”‚          â–¼                                                    â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     POST /api/whisper/transcribe         â”‚
â”‚ â”‚ ä¸Šä¼ éŸ³é¢‘æ–‡ä»¶     â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º    â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                          â”‚
â”‚          â”‚                                                    â”‚
â”‚          â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚          â”‚   â”‚ Whisper Service                            â”‚  â”‚
â”‚          â”‚   â”‚ - faster-whisper è¯†åˆ«                      â”‚  â”‚
â”‚          â”‚   â”‚ - è¿”å›æ–‡å­—                                  â”‚  â”‚
â”‚          â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚          â”‚                                                    â”‚
â”‚          â–¼                                                    â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                          â”‚
â”‚ â”‚ å¡«å…¥è¾“å…¥æ¡†       â”‚                                          â”‚
â”‚ â”‚ (å¯ç¼–è¾‘ç¡®è®¤)     â”‚                                          â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                        è¯­éŸ³è¾“å‡ºæµç¨‹
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AI å›å¤å®Œæˆ                                                    â”‚
â”‚      â”‚                                                        â”‚
â”‚      â–¼                                                        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     POST /api/tts/synthesize              â”‚
â”‚ â”‚ è¯·æ±‚è¯­éŸ³åˆæˆ     â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º    â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                          â”‚
â”‚          â”‚                                                    â”‚
â”‚          â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚          â”‚   â”‚ TTS Service (Edge TTS)                     â”‚  â”‚
â”‚          â”‚   â”‚ - æ–‡å­—è½¬è¯­éŸ³                                â”‚  â”‚
â”‚          â”‚   â”‚ - è¿”å›éŸ³é¢‘æµ                                â”‚  â”‚
â”‚          â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚          â”‚                                                    â”‚
â”‚          â–¼                                                    â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                          â”‚
â”‚ â”‚ Audio æ’­æ”¾å™¨     â”‚                                          â”‚
â”‚ â”‚ - æ’­æ”¾/æš‚åœ     â”‚                                          â”‚
â”‚ â”‚ - è¿›åº¦æ¡        â”‚                                          â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## äº”ã€æ•°æ®åº“è®¾è®¡

### 5.1 PostgreSQL Schema

```sql
-- ç”¨æˆ·è¡¨
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    is_active BOOLEAN DEFAULT TRUE,
    is_verified BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ç”¨æˆ·è®¾ç½®è¡¨
CREATE TABLE user_settings (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    theme VARCHAR(20) DEFAULT 'system',
    language VARCHAR(10) DEFAULT 'zh-CN',
    voice_enabled BOOLEAN DEFAULT FALSE,
    default_model VARCHAR(50) DEFAULT 'gemini-2.0-flash-lite',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- API Key è¡¨
CREATE TABLE api_keys (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    key_name VARCHAR(100) NOT NULL,
    key_type VARCHAR(50) NOT NULL,  -- 'google', 'e2b', 'openai', etc.
    encrypted_value TEXT NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE(user_id, key_type)
);

-- ä¼šè¯è¡¨
CREATE TABLE conversations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    title VARCHAR(255) DEFAULT 'New Chat',
    model VARCHAR(50),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- æ¶ˆæ¯è¡¨
CREATE TABLE messages (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    conversation_id UUID REFERENCES conversations(id) ON DELETE CASCADE,
    role VARCHAR(20) NOT NULL,  -- 'user', 'assistant', 'system'
    content TEXT NOT NULL,
    images JSONB,               -- å›¾ç‰‡ URL/Base64 æ•°ç»„
    tool_calls JSONB,           -- å·¥å…·è°ƒç”¨è®°å½•
    citations JSONB,            -- å¼•ç”¨æ¥æº
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- æ–‡æ¡£è¡¨ (RAG)
CREATE TABLE documents (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    filename VARCHAR(255) NOT NULL,
    file_type VARCHAR(50),
    file_size INTEGER,
    milvus_collection VARCHAR(100),
    chunk_count INTEGER DEFAULT 0,
    status VARCHAR(20) DEFAULT 'pending',  -- 'pending', 'processing', 'ready', 'error'
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Refresh Token è¡¨
CREATE TABLE refresh_tokens (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    token_hash VARCHAR(255) NOT NULL,
    expires_at TIMESTAMP WITH TIME ZONE NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ç´¢å¼•
CREATE INDEX idx_conversations_user_id ON conversations(user_id);
CREATE INDEX idx_messages_conversation_id ON messages(conversation_id);
CREATE INDEX idx_documents_user_id ON documents(user_id);
CREATE INDEX idx_refresh_tokens_user_id ON refresh_tokens(user_id);
```

### 5.2 Milvus Schema

```python
# Collection: document_chunks

from pymilvus import CollectionSchema, FieldSchema, DataType

fields = [
    FieldSchema(name="id", dtype=DataType.VARCHAR, is_primary=True, max_length=36),
    FieldSchema(name="document_id", dtype=DataType.VARCHAR, max_length=36),
    FieldSchema(name="user_id", dtype=DataType.VARCHAR, max_length=36),
    FieldSchema(name="chunk_index", dtype=DataType.INT64),
    FieldSchema(name="content", dtype=DataType.VARCHAR, max_length=65535),
    FieldSchema(name="page_number", dtype=DataType.INT64),
    FieldSchema(name="embedding", dtype=DataType.FLOAT_VECTOR, dim=384),  # all-MiniLM-L6-v2
    FieldSchema(name="metadata", dtype=DataType.JSON),
]

schema = CollectionSchema(
    fields=fields,
    description="Document chunks for RAG"
)

# Index
index_params = {
    "metric_type": "IP",  # Inner Product (cosine similarity)
    "index_type": "IVF_FLAT",
    "params": {"nlist": 1024}
}
```

### 5.3 Redis æ•°æ®ç»“æ„

```
# Session å­˜å‚¨
session:{user_id} -> Hash
  - access_token: string
  - refresh_token: string
  - created_at: timestamp
  - last_active: timestamp

# Rate Limiting
rate_limit:{user_id}:{endpoint} -> Counter
  - expire: 60s

# Token é»‘åå•
blacklist:{token_hash} -> Set
  - expire: token å‰©ä½™æœ‰æ•ˆæœŸ
```

---

## å…­ã€API æ¥å£è®¾è®¡

### 6.1 è®¤è¯æ¥å£

| æ–¹æ³• | è·¯å¾„ | æè¿° | è®¤è¯ |
|------|------|------|------|
| POST | /api/auth/register | ç”¨æˆ·æ³¨å†Œ | å¦ |
| POST | /api/auth/login | ç”¨æˆ·ç™»å½• | å¦ |
| POST | /api/auth/refresh | åˆ·æ–° Token | å¦ |
| POST | /api/auth/logout | ç”¨æˆ·ç™»å‡º | æ˜¯ |
| GET | /api/auth/me | è·å–å½“å‰ç”¨æˆ· | æ˜¯ |
| PUT | /api/auth/password | ä¿®æ”¹å¯†ç  | æ˜¯ |

**è¯·æ±‚/å“åº”ç¤ºä¾‹:**

```yaml
# POST /api/auth/register
Request:
  {
    "username": "john_doe",
    "email": "john@example.com",
    "password": "SecurePass123!"
  }

Response: 201
  {
    "id": "uuid",
    "username": "john_doe",
    "email": "john@example.com",
    "created_at": "2025-12-31T00:00:00Z"
  }

# POST /api/auth/login
Request:
  {
    "email": "john@example.com",
    "password": "SecurePass123!"
  }

Response: 200
  {
    "access_token": "eyJhbGciOiJIUzI1NiIs...",
    "refresh_token": "eyJhbGciOiJIUzI1NiIs...",
    "token_type": "bearer",
    "expires_in": 3600
  }
```

### 6.2 èŠå¤©æ¥å£

| æ–¹æ³• | è·¯å¾„ | æè¿° | è®¤è¯ |
|------|------|------|------|
| GET | /api/conversations | è·å–ä¼šè¯åˆ—è¡¨ | æ˜¯ |
| POST | /api/conversations | åˆ›å»ºä¼šè¯ | æ˜¯ |
| GET | /api/conversations/{id} | è·å–ä¼šè¯è¯¦æƒ… | æ˜¯ |
| PUT | /api/conversations/{id} | æ›´æ–°ä¼šè¯ | æ˜¯ |
| DELETE | /api/conversations/{id} | åˆ é™¤ä¼šè¯ | æ˜¯ |
| GET | /api/conversations/{id}/messages | è·å–æ¶ˆæ¯åˆ—è¡¨ | æ˜¯ |
| POST | /api/chat/stream | æµå¼èŠå¤© | æ˜¯ |
| POST | /api/chat/stop | åœæ­¢ç”Ÿæˆ | æ˜¯ |

**æµå¼èŠå¤©è¯·æ±‚:**

```yaml
# POST /api/chat/stream
Request:
  {
    "conversation_id": "uuid",
    "content": "åˆ†æè¿™å¼ å›¾ç‰‡",
    "images": ["base64..."],  # å¯é€‰
    "api_keys": {             # å¯é€‰ï¼Œè¦†ç›–ç”¨æˆ·é»˜è®¤é…ç½®
      "GOOGLE_API_KEY": "..."
    }
  }

Response: SSE Stream
  event: text
  data: {"content": "è¿™æ˜¯ä¸€å¼ ..."}

  event: tool_start
  data: {"tool_name": "search_engine", "tool_id": "xxx"}

  event: tool_end
  data: {"tool_id": "xxx", "output": "...", "duration": 1.5}

  event: citation
  data: {"source": "doc.pdf", "page": 5, "content": "..."}

  event: done
  data: {"message_id": "uuid", "total_tokens": 1500}
```

### 6.3 RAG æ¥å£

| æ–¹æ³• | è·¯å¾„ | æè¿° | è®¤è¯ |
|------|------|------|------|
| GET | /api/documents | è·å–æ–‡æ¡£åˆ—è¡¨ | æ˜¯ |
| POST | /api/documents/upload | ä¸Šä¼ æ–‡æ¡£ | æ˜¯ |
| DELETE | /api/documents/{id} | åˆ é™¤æ–‡æ¡£ | æ˜¯ |
| GET | /api/documents/{id}/status | è·å–å¤„ç†çŠ¶æ€ | æ˜¯ |
| POST | /api/search | æ£€ç´¢æ–‡æ¡£ | æ˜¯ |

**æ–‡æ¡£ä¸Šä¼ :**

```yaml
# POST /api/documents/upload
Request: multipart/form-data
  - file: binary
  - parse_method: "mineru" | "default"

Response: 202
  {
    "document_id": "uuid",
    "filename": "report.pdf",
    "status": "processing",
    "estimated_time": 30
  }
```

### 6.4 è¯­éŸ³æ¥å£

| æ–¹æ³• | è·¯å¾„ | æè¿° | è®¤è¯ |
|------|------|------|------|
| POST | /api/voice/transcribe | è¯­éŸ³è½¬æ–‡å­— | æ˜¯ |
| POST | /api/voice/synthesize | æ–‡å­—è½¬è¯­éŸ³ | æ˜¯ |

```yaml
# POST /api/voice/transcribe
Request: multipart/form-data
  - audio: binary (wav/mp3/webm)
  - language: "zh" | "en" | "auto"

Response: 200
  {
    "text": "è¯†åˆ«çš„æ–‡å­—å†…å®¹",
    "language": "zh",
    "confidence": 0.95
  }

# POST /api/voice/synthesize
Request:
  {
    "text": "è¦è½¬æ¢çš„æ–‡å­—",
    "voice": "zh-CN-XiaoxiaoNeural",
    "rate": 1.0,
    "pitch": 0
  }

Response: audio/mpeg (binary stream)
```

### 6.5 ç”¨æˆ·è®¾ç½®æ¥å£

| æ–¹æ³• | è·¯å¾„ | æè¿° | è®¤è¯ |
|------|------|------|------|
| GET | /api/settings | è·å–ç”¨æˆ·è®¾ç½® | æ˜¯ |
| PUT | /api/settings | æ›´æ–°ç”¨æˆ·è®¾ç½® | æ˜¯ |
| GET | /api/settings/api-keys | è·å– API Key åˆ—è¡¨ | æ˜¯ |
| POST | /api/settings/api-keys | æ·»åŠ  API Key | æ˜¯ |
| DELETE | /api/settings/api-keys/{type} | åˆ é™¤ API Key | æ˜¯ |

---

## ä¸ƒã€å‰ç«¯é¡µé¢è®¾è®¡

### 7.1 é¡µé¢ç»“æ„

```
/                           â†’ é‡å®šå‘åˆ° /chat
/login                      â†’ ç™»å½•é¡µ
/register                   â†’ æ³¨å†Œé¡µ
/chat                       â†’ æ–°ä¼šè¯ï¼ˆä¸»é¡µé¢ï¼‰
/chat/[id]                  â†’ æŒ‡å®šä¼šè¯
/settings                   â†’ ç”¨æˆ·è®¾ç½®
/settings/api-keys          â†’ API Key ç®¡ç†
/settings/profile           â†’ ä¸ªäººèµ„æ–™
```

### 7.2 ä¸»é¡µé¢å¸ƒå±€ (Desktop)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           Header                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ ğŸ¤– Stream-Agent  â”‚                         â”‚ ğŸ‘¤ User â–¼         â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚â”‚                  â”‚ â”‚                                              â”‚â”‚
â”‚â”‚   Sidebar        â”‚ â”‚              Chat Area                       â”‚â”‚
â”‚â”‚                  â”‚ â”‚                                              â”‚â”‚
â”‚â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚â”‚
â”‚â”‚  â”‚ + New Chat  â”‚ â”‚ â”‚  â”‚                                          â”‚â”‚â”‚
â”‚â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚  â”‚         Message List                     â”‚â”‚â”‚
â”‚â”‚                  â”‚ â”‚  â”‚                                          â”‚â”‚â”‚
â”‚â”‚  Search...       â”‚ â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚â”‚â”‚
â”‚â”‚                  â”‚ â”‚  â”‚  â”‚ ğŸ‘¤ User: ä½ å¥½                      â”‚  â”‚â”‚â”‚
â”‚â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚â”‚â”‚
â”‚â”‚  â”‚ Today       â”‚ â”‚ â”‚  â”‚                                          â”‚â”‚â”‚
â”‚â”‚  â”‚ - Chat 1    â”‚ â”‚ â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚â”‚â”‚
â”‚â”‚  â”‚ - Chat 2    â”‚ â”‚ â”‚  â”‚  â”‚ ğŸ¤– AI: ä½ å¥½ï¼æœ‰ä»€ä¹ˆ...            â”‚  â”‚â”‚â”‚
â”‚â”‚  â”‚             â”‚ â”‚ â”‚  â”‚  â”‚                                    â”‚  â”‚â”‚â”‚
â”‚â”‚  â”‚ Yesterday   â”‚ â”‚ â”‚  â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚  â”‚â”‚â”‚
â”‚â”‚  â”‚ - Chat 3    â”‚ â”‚ â”‚  â”‚  â”‚ â”‚ ğŸ”§ Tool: search_engine        â”‚â”‚  â”‚â”‚â”‚
â”‚â”‚  â”‚             â”‚ â”‚ â”‚  â”‚  â”‚ â”‚    Status: âœ…                 â”‚â”‚  â”‚â”‚â”‚
â”‚â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚  â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚  â”‚â”‚â”‚
â”‚â”‚                  â”‚ â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚â”‚â”‚
â”‚â”‚                  â”‚ â”‚  â”‚                                          â”‚â”‚â”‚
â”‚â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚â”‚
â”‚â”‚  â”‚ âš™ï¸ Settings â”‚ â”‚ â”‚                                              â”‚â”‚
â”‚â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚â”‚
â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚              Input Area                   â”‚â”‚â”‚
â”‚                     â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â” â”‚â”‚â”‚
â”‚                     â”‚  â”‚ â”‚ ğŸ“   â”‚ â”‚ Message...        â”‚ â”‚ ğŸ¤ â¤ â”‚ â”‚â”‚â”‚
â”‚                     â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚â”‚â”‚
â”‚                     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚â”‚
â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.3 ç§»åŠ¨ç«¯å¸ƒå±€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â˜°   Stream-Agent   ğŸ‘¤   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                         â”‚
â”‚    Message List         â”‚
â”‚                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ğŸ‘¤ ä½ å¥½           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ğŸ¤– ä½ å¥½ï¼æœ‰ä»€ä¹ˆ...â”‚  â”‚
â”‚  â”‚                   â”‚  â”‚
â”‚  â”‚ [ğŸ”§ Tool â–¼]      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ“ â”‚ Message...    â”‚ğŸ¤â¤â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.4 ç»„ä»¶æ ·å¼è§„èŒƒ

**é¢œè‰²ç³»ç»Ÿ (shadcn/ui + Tailwind):**

```css
/* globals.css */
@layer base {
  :root {
    --background: 0 0% 100%;
    --foreground: 222.2 84% 4.9%;
    --card: 0 0% 100%;
    --card-foreground: 222.2 84% 4.9%;
    --primary: 221.2 83.2% 53.3%;
    --primary-foreground: 210 40% 98%;
    --secondary: 210 40% 96.1%;
    --muted: 210 40% 96.1%;
    --accent: 210 40% 96.1%;
    --destructive: 0 84.2% 60.2%;
    --border: 214.3 31.8% 91.4%;
    --ring: 221.2 83.2% 53.3%;
  }

  .dark {
    --background: 222.2 84% 4.9%;
    --foreground: 210 40% 98%;
    --card: 222.2 84% 4.9%;
    --card-foreground: 210 40% 98%;
    --primary: 217.2 91.2% 59.8%;
    --secondary: 217.2 32.6% 17.5%;
    --muted: 217.2 32.6% 17.5%;
    --accent: 217.2 32.6% 17.5%;
    --destructive: 0 62.8% 30.6%;
    --border: 217.2 32.6% 17.5%;
  }
}
```

**æ¶ˆæ¯æ°”æ³¡æ ·å¼:**

```typescript
// ç”¨æˆ·æ¶ˆæ¯
<div className="flex justify-end">
  <div className="max-w-[80%] rounded-2xl bg-primary text-primary-foreground px-4 py-2">
    {content}
  </div>
</div>

// AI æ¶ˆæ¯
<div className="flex justify-start">
  <div className="max-w-[80%] rounded-2xl bg-muted px-4 py-2">
    {content}
  </div>
</div>
```

---

## å…«ã€éƒ¨ç½²æ¶æ„

### 8.1 Docker Compose é…ç½®

```yaml
# docker-compose.yml

version: '3.8'

services:
  # ========== Frontend ==========
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_API_URL=http://nginx/api
    depends_on:
      - nginx
    networks:
      - app-network

  # ========== API Gateway ==========
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      - auth-service
      - chat-service
      - rag-service
      - whisper-service
    networks:
      - app-network

  # ========== Auth Service ==========
  auth-service:
    build:
      context: ./backend/auth-service
      dockerfile: Dockerfile
    environment:
      - DATABASE_URL=postgresql://postgres:password@postgres:5432/streamagent
      - REDIS_URL=redis://redis:6379/0
      - JWT_SECRET=${JWT_SECRET}
      - JWT_ALGORITHM=HS256
      - ACCESS_TOKEN_EXPIRE_MINUTES=60
      - REFRESH_TOKEN_EXPIRE_DAYS=7
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - app-network

  # ========== Chat Service ==========
  chat-service:
    build:
      context: ./backend/chat-service
      dockerfile: Dockerfile
    environment:
      - DATABASE_URL=postgresql://postgres:password@postgres:5432/streamagent
      - REDIS_URL=redis://redis:6379/0
      - MILVUS_HOST=milvus
      - MILVUS_PORT=19530
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      - E2B_API_KEY=${E2B_API_KEY}
      - BRIGHT_DATA_API_KEY=${BRIGHT_DATA_API_KEY}
    depends_on:
      - postgres
      - redis
      - milvus
    networks:
      - app-network

  # ========== RAG Service ==========
  rag-service:
    build:
      context: ./backend/rag-service
      dockerfile: Dockerfile
    environment:
      - DATABASE_URL=postgresql://postgres:password@postgres:5432/streamagent
      - MILVUS_HOST=milvus
      - MILVUS_PORT=19530
      - MINIO_ENDPOINT=minio:9000
      - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY}
      - MINIO_SECRET_KEY=${MINIO_SECRET_KEY}
      - MINERU_API_KEY=${MINERU_API_KEY}
    depends_on:
      - postgres
      - milvus
      - minio
    networks:
      - app-network

  # ========== Whisper Service ==========
  whisper-service:
    build:
      context: ./backend/whisper-service
      dockerfile: Dockerfile
    environment:
      - WHISPER_MODEL=base
      - DEVICE=cpu
    networks:
      - app-network

  # ========== Databases ==========
  postgres:
    image: postgres:15-alpine
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=streamagent
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - app-network

  redis:
    image: redis:7-alpine
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - app-network

  milvus:
    image: milvusdb/milvus:v2.3.4
    environment:
      - ETCD_ENDPOINTS=etcd:2379
      - MINIO_ADDRESS=minio:9000
    depends_on:
      - etcd
      - minio
    ports:
      - "19530:19530"
    volumes:
      - milvus_data:/var/lib/milvus
    networks:
      - app-network

  etcd:
    image: quay.io/coreos/etcd:v3.5.5
    environment:
      - ETCD_AUTO_COMPACTION_MODE=revision
      - ETCD_AUTO_COMPACTION_RETENTION=1000
      - ETCD_QUOTA_BACKEND_BYTES=4294967296
    volumes:
      - etcd_data:/etcd
    command: etcd -advertise-client-urls=http://127.0.0.1:2379 -listen-client-urls http://0.0.0.0:2379 --data-dir /etcd
    networks:
      - app-network

  minio:
    image: minio/minio:latest
    environment:
      - MINIO_ROOT_USER=${MINIO_ACCESS_KEY}
      - MINIO_ROOT_PASSWORD=${MINIO_SECRET_KEY}
    volumes:
      - minio_data:/data
    command: server /data --console-address ":9001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3
    networks:
      - app-network

networks:
  app-network:
    driver: bridge

volumes:
  postgres_data:
  redis_data:
  milvus_data:
  etcd_data:
  minio_data:
```

### 8.2 Nginx é…ç½®

```nginx
# nginx/nginx.conf

upstream auth_service {
    server auth-service:8001;
}

upstream chat_service {
    server chat-service:8000;
}

upstream rag_service {
    server rag-service:8002;
}

upstream whisper_service {
    server whisper-service:8003;
}

server {
    listen 80;
    server_name localhost;

    # API è·¯ç”±
    location /api/auth {
        proxy_pass http://auth_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    location /api/chat {
        proxy_pass http://chat_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        # SSE æ”¯æŒ
        proxy_buffering off;
        proxy_cache off;
        proxy_set_header Connection '';
        proxy_http_version 1.1;
        chunked_transfer_encoding off;
    }

    location /api/conversations {
        proxy_pass http://chat_service;
        proxy_set_header Host $host;
    }

    location /api/documents {
        proxy_pass http://rag_service;
        proxy_set_header Host $host;
        client_max_body_size 100M;
    }

    location /api/search {
        proxy_pass http://rag_service;
        proxy_set_header Host $host;
    }

    location /api/voice {
        proxy_pass http://whisper_service;
        proxy_set_header Host $host;
        client_max_body_size 50M;
    }

    location /api/settings {
        proxy_pass http://auth_service;
        proxy_set_header Host $host;
    }

    # å¥åº·æ£€æŸ¥
    location /health {
        return 200 'OK';
        add_header Content-Type text/plain;
    }
}
```

### 8.3 ç¯å¢ƒå˜é‡é…ç½®

```bash
# .env

# ========== Database ==========
POSTGRES_PASSWORD=your_secure_password
DATABASE_URL=postgresql://postgres:your_secure_password@postgres:5432/streamagent

# ========== Redis ==========
REDIS_URL=redis://redis:6379/0

# ========== JWT ==========
JWT_SECRET=your_jwt_secret_key_at_least_32_chars
JWT_ALGORITHM=HS256

# ========== MinIO ==========
MINIO_ACCESS_KEY=minioadmin
MINIO_SECRET_KEY=minioadmin

# ========== External APIs ==========
GOOGLE_API_KEY=your_google_api_key
E2B_API_KEY=your_e2b_api_key
BRIGHT_DATA_API_KEY=your_bright_data_key
MINERU_API_KEY=your_mineru_api_key

# ========== TTS ==========
EDGE_TTS_VOICE=zh-CN-XiaoxiaoNeural
```

### 8.4 éƒ¨ç½²æµç¨‹

```bash
# 1. å…‹éš†é¡¹ç›®
git clone <repo_url>
cd My-Chat-LangChain

# 2. é…ç½®ç¯å¢ƒå˜é‡
cp .env.example .env
# ç¼–è¾‘ .env å¡«å…¥å¿…è¦çš„ API Key

# 3. æ„å»ºå¹¶å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker-compose up -d --build

# 4. æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker-compose ps

# 5. æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f

# 6. åœæ­¢æœåŠ¡
docker-compose down

# 7. æ¸…ç†æ•°æ® (è°¨æ…)
docker-compose down -v
```

---

## ä¹ã€å¼€å‘è®¡åˆ’

### 9.1 é˜¶æ®µåˆ’åˆ†

```
Phase 1: å‰ç«¯é‡æ„ + ç”¨æˆ·ç³»ç»Ÿ (2-3 å‘¨)
â”œâ”€â”€ Week 1: Next.js é¡¹ç›®æ­å»º + åŸºç¡€ UI
â”œâ”€â”€ Week 2: ç”¨æˆ·è®¤è¯ç³»ç»Ÿ + ä¼šè¯ç®¡ç†
â””â”€â”€ Week 3: æµå¼èŠå¤©é›†æˆ + å·¥å…·å¯è§†åŒ–

Phase 2: å¤šæ¨¡æ€èƒ½åŠ› (1-2 å‘¨)
â”œâ”€â”€ Week 4: å›¾ç‰‡ä¸Šä¼ ä¸ç†è§£
â””â”€â”€ Week 5: è¯­éŸ³è¾“å…¥/è¾“å‡º

Phase 3: RAG å¢å¼º (2 å‘¨)
â”œâ”€â”€ Week 6: Milvus è¿ç§» + æ··åˆæ£€ç´¢
â””â”€â”€ Week 7: MinerU é›†æˆ + å¼•ç”¨è¿½æº¯

Phase 4: éƒ¨ç½²ä¼˜åŒ– (1 å‘¨)
â””â”€â”€ Week 8: Docker Compose + æµ‹è¯• + æ–‡æ¡£
```

### 9.2 é‡Œç¨‹ç¢‘

| é‡Œç¨‹ç¢‘ | å®Œæˆæ¡ä»¶ | é¢„è®¡æ—¥æœŸ |
|--------|---------|---------|
| **M1: å‰ç«¯å¯ç”¨** | Next.js å‰ç«¯èƒ½æ­£å¸¸èŠå¤© | Week 2 |
| **M2: ç”¨æˆ·ç³»ç»Ÿ** | æ³¨å†Œ/ç™»å½•/ä¼šè¯ç®¡ç†å®Œæˆ | Week 3 |
| **M3: å¤šæ¨¡æ€** | å›¾ç‰‡+è¯­éŸ³åŠŸèƒ½å¯ç”¨ | Week 5 |
| **M4: RAG å¢å¼º** | æ··åˆæ£€ç´¢+å¼•ç”¨è¿½æº¯å®Œæˆ | Week 7 |
| **M5: ç”Ÿäº§å°±ç»ª** | Docker Compose éƒ¨ç½²å®Œæˆ | Week 8 |

### 9.3 è¯¦ç»†ä»»åŠ¡æ¸…å•

#### Phase 1: å‰ç«¯é‡æ„ + ç”¨æˆ·ç³»ç»Ÿ

**Week 1: åŸºç¡€æ­å»º** âœ… å·²å®Œæˆ (2025-12-31)

- [x] åˆ›å»º Next.js 14 é¡¹ç›® (å®é™…ä½¿ç”¨ Next.js 16.1.1)
- [x] é…ç½® Tailwind CSS + shadcn/ui (Tailwind 4.0)
- [x] å®ç°åŸºç¡€å¸ƒå±€ (Header + Sidebar + Main)
- [x] åˆ›å»ºç™»å½•/æ³¨å†Œé¡µé¢ UI
- [x] åˆ›å»ºèŠå¤©é¡µé¢ UI
- [x] å®ç°æ¶ˆæ¯åˆ—è¡¨ç»„ä»¶
- [x] å®ç°è¾“å…¥åŒºåŸŸç»„ä»¶ (æ”¯æŒå›¾ç‰‡ä¸Šä¼ /ç²˜è´´/æ‹–æ‹½)
- [x] é…ç½® Zustand çŠ¶æ€ç®¡ç† (authStore, chatStore, settingsStore)
- [x] å®ç° ThemeProvider (äº®è‰²/æš—è‰²/ç³»ç»Ÿä¸»é¢˜)
- [x] å®ç° AuthProvider (è·¯ç”±ä¿æŠ¤)
- [x] é…ç½® API å®¢æˆ·ç«¯ (Axios + Token æ‹¦æˆªå™¨)
- [x] åˆ›å»ºè®¾ç½®é¡µé¢ UI

**Week 2: ç”¨æˆ·è®¤è¯** ğŸ”„ è¿›è¡Œä¸­

- [ ] åˆ›å»º auth-service é¡¹ç›®ç»“æ„
- [ ] å®ç°ç”¨æˆ·æ³¨å†Œ API
- [ ] å®ç°ç”¨æˆ·ç™»å½• API
- [ ] å®ç° JWT Token ç”Ÿæˆ/éªŒè¯
- [ ] å®ç° Refresh Token æœºåˆ¶
- [x] å‰ç«¯è®¤è¯çŠ¶æ€ç®¡ç† (å·²åœ¨ Week 1 å®Œæˆ)
- [x] å‰ç«¯è·¯ç”±ä¿æŠ¤ (å·²åœ¨ Week 1 å®Œæˆ)
- [x] API è¯·æ±‚æ‹¦æˆªå™¨ (Token è‡ªåŠ¨æºå¸¦/åˆ·æ–°) (å·²åœ¨ Week 1 å®Œæˆ)

**Week 3: èŠå¤©é›†æˆ**

- [ ] æ”¹é€  chat-service æ”¯æŒç”¨æˆ·éš”ç¦»
- [ ] å®ç°ä¼šè¯ CRUD API
- [ ] å®ç°æ¶ˆæ¯å­˜å‚¨ (PostgreSQL)
- [ ] å‰ç«¯ SSE æµå¼å¤„ç†
- [ ] å·¥å…·è°ƒç”¨å¯è§†åŒ–ç»„ä»¶
- [ ] ä»£ç å—é«˜äº®ç»„ä»¶
- [ ] å›¾è¡¨æ¸²æŸ“ç»„ä»¶
- [ ] æ¶ˆæ¯å¤åˆ¶/é‡æ–°ç”ŸæˆåŠŸèƒ½

#### Phase 2: å¤šæ¨¡æ€èƒ½åŠ›

**Week 4: å›¾ç‰‡ç†è§£**

- [ ] å‰ç«¯å›¾ç‰‡ä¸Šä¼ ç»„ä»¶
- [ ] å›¾ç‰‡æ‹–æ‹½/ç²˜è´´æ”¯æŒ
- [ ] å›¾ç‰‡é¢„è§ˆä¸åˆ é™¤
- [ ] åç«¯å¤šæ¨¡æ€æ¶ˆæ¯æ„å»º
- [ ] Gemini Vision API é›†æˆ
- [ ] OCR åŠŸèƒ½å®ç°

**Week 5: è¯­éŸ³äº¤äº’**

- [ ] åˆ›å»º whisper-service
- [ ] é›†æˆ faster-whisper
- [ ] å‰ç«¯å½•éŸ³ç»„ä»¶
- [ ] è¯­éŸ³è½¬æ–‡å­—æµç¨‹
- [ ] Edge TTS é›†æˆ
- [ ] å‰ç«¯éŸ³é¢‘æ’­æ”¾å™¨
- [ ] è¯­éŸ³è®¾ç½®é€‰é¡¹

#### Phase 3: RAG å¢å¼º

**Week 6: å‘é‡å­˜å‚¨è¿ç§»**

- [ ] åˆ›å»º rag-service é¡¹ç›®ç»“æ„
- [ ] Milvus Collection è®¾è®¡
- [ ] å‘é‡å­˜å‚¨æœåŠ¡å°è£…
- [ ] ChromaDB æ•°æ®è¿ç§»è„šæœ¬
- [ ] BM25 ç´¢å¼•æ„å»º
- [ ] RRF èåˆç®—æ³•å®ç°
- [ ] æ··åˆæ£€ç´¢ API

**Week 7: é«˜çº§æ£€ç´¢**

- [ ] MinerU API é›†æˆ
- [ ] æ™ºèƒ½åˆ†å—é€»è¾‘
- [ ] å¼•ç”¨è¿½æº¯å®ç°
- [ ] å‰ç«¯å¼•ç”¨å±•ç¤ºç»„ä»¶
- [ ] Reranker æ¨¡å‹é›†æˆ
- [ ] å¤šè½®å¯¹è¯æ£€ç´¢ä¼˜åŒ–
- [ ] æ–‡æ¡£ç®¡ç†ç•Œé¢

#### Phase 4: éƒ¨ç½²ä¼˜åŒ–

**Week 8: éƒ¨ç½²ä¸æµ‹è¯•**

- [ ] å®Œå–„ Docker Compose é…ç½®
- [ ] Nginx åå‘ä»£ç†é…ç½®
- [ ] å¥åº·æ£€æŸ¥å®ç°
- [ ] ç¯å¢ƒå˜é‡ç®¡ç†
- [ ] ç¼–å†™éƒ¨ç½²æ–‡æ¡£
- [ ] ç«¯åˆ°ç«¯æµ‹è¯•
- [ ] æ€§èƒ½æµ‹è¯•ä¸ä¼˜åŒ–
- [ ] Bug ä¿®å¤

---

## åã€é£é™©è¯„ä¼°ä¸åº”å¯¹

### 10.1 æŠ€æœ¯é£é™©

| é£é™© | å¯èƒ½æ€§ | å½±å“ | åº”å¯¹æªæ–½ |
|------|--------|------|---------|
| Milvus å­¦ä¹ æ›²çº¿ | ä¸­ | ä¸­ | æå‰å­¦ä¹ æ–‡æ¡£ï¼Œå‡†å¤‡ ChromaDB å›é€€æ–¹æ¡ˆ |
| Whisper æ€§èƒ½é—®é¢˜ | ä¸­ | ä½ | ä½¿ç”¨ base æ¨¡å‹ï¼Œè€ƒè™‘ API æœåŠ¡å›é€€ |
| MinerU API ä¸ç¨³å®š | ä¸­ | ä¸­ | å®ç°é»˜è®¤è§£ææ–¹æ¡ˆä½œä¸º fallback |
| å‰åç«¯é›†æˆé—®é¢˜ | ä¸­ | ä¸­ | å®šä¹‰æ¸…æ™° API æ¥å£ï¼Œæ¸è¿›å¼å¼€å‘ |
| SSE æµå¼ä¼ è¾“å…¼å®¹æ€§ | ä½ | é«˜ | æµ‹è¯•å¤šæµè§ˆå™¨ï¼Œå‡†å¤‡ WebSocket å¤‡é€‰ |

### 10.2 èµ„æºé£é™©

| é£é™© | å¯èƒ½æ€§ | å½±å“ | åº”å¯¹æªæ–½ |
|------|--------|------|---------|
| å¼€å‘æ—¶é—´ä¸è¶³ | ä¸­ | é«˜ | æŒ‰ä¼˜å…ˆçº§ç éœ€æ±‚ï¼ŒPhase 3 å¯å»¶å |
| æœåŠ¡å™¨èµ„æºä¸è¶³ | ä½ | ä¸­ | ä¼˜åŒ–é…ç½®ï¼Œè€ƒè™‘äº‘æœåŠ¡ |
| API é¢åº¦é™åˆ¶ | ä¸­ | ä¸­ | å®ç°è¯·æ±‚ç¼“å­˜ï¼Œæ·»åŠ é™æµ |

### 10.3 å›é€€æ–¹æ¡ˆ

| åŠŸèƒ½ | ä¸»æ–¹æ¡ˆ | å›é€€æ–¹æ¡ˆ |
|------|--------|---------|
| å‘é‡å­˜å‚¨ | Milvus | ChromaDB (ç°æœ‰) |
| è¯­éŸ³è¯†åˆ« | faster-whisper (æœ¬åœ°) | Web Speech API (æµè§ˆå™¨) |
| è¯­éŸ³åˆæˆ | Edge TTS | pyttsx3 (æœ¬åœ°) |
| æ–‡æ¡£è§£æ | MinerU API | PyPDF2 + åŸºç¡€åˆ†å— |
| é‡æ’åº | bge-reranker | æ— é‡æ’åº |

---

## åä¸€ã€éªŒæ”¶æ ‡å‡†

### 11.1 åŠŸèƒ½éªŒæ”¶

| åŠŸèƒ½ | éªŒæ”¶æ¡ä»¶ |
|------|---------|
| **ç”¨æˆ·æ³¨å†Œ** | èƒ½æˆåŠŸæ³¨å†Œæ–°ç”¨æˆ·ï¼Œå¯†ç åŠ å¯†å­˜å‚¨ |
| **ç”¨æˆ·ç™»å½•** | èƒ½ç™»å½•å¹¶è·å– JWT Token |
| **ä¼šè¯ç®¡ç†** | èƒ½åˆ›å»ºã€åˆ‡æ¢ã€åˆ é™¤ä¼šè¯ |
| **æµå¼èŠå¤©** | æ¶ˆæ¯å®æ—¶æµå¼æ˜¾ç¤ºï¼Œæ”¯æŒä¸­æ–­ |
| **å·¥å…·è°ƒç”¨** | å·¥å…·æ‰§è¡Œè¿‡ç¨‹å¯è§†åŒ–ï¼ŒçŠ¶æ€æ­£ç¡® |
| **å›¾ç‰‡ç†è§£** | èƒ½ä¸Šä¼ å›¾ç‰‡å¹¶è·å¾—åˆ†æç»“æœ |
| **è¯­éŸ³è¾“å…¥** | èƒ½å½•éŸ³å¹¶è½¬æ¢ä¸ºæ–‡å­— |
| **è¯­éŸ³è¾“å‡º** | AI å›å¤èƒ½è½¬æ¢ä¸ºè¯­éŸ³æ’­æ”¾ |
| **æ–‡æ¡£ä¸Šä¼ ** | èƒ½ä¸Šä¼  PDF å¹¶è§£æå…¥åº“ |
| **æ··åˆæ£€ç´¢** | èƒ½æ£€ç´¢åˆ°ç›¸å…³å†…å®¹å¹¶æ˜¾ç¤ºå¼•ç”¨ |
| **Docker éƒ¨ç½²** | docker-compose up ä¸€é”®å¯åŠ¨ |

### 11.2 æ€§èƒ½éªŒæ”¶

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | æµ‹è¯•æ–¹æ³• |
|------|--------|---------|
| é¦–å±åŠ è½½ | < 2s | Lighthouse |
| ç™»å½•å“åº” | < 500ms | API æµ‹è¯• |
| æµå¼é¦– Token | < 1s | æ‰‹åŠ¨æµ‹è¯• |
| æ£€ç´¢å»¶è¿Ÿ | < 500ms | API æµ‹è¯• |
| å¹¶å‘ç”¨æˆ· | 100+ | å‹åŠ›æµ‹è¯• |

### 11.3 è´¨é‡éªŒæ”¶

- [ ] æ‰€æœ‰ API æœ‰ OpenAPI æ–‡æ¡£
- [ ] å…³é”®è·¯å¾„æœ‰å•å…ƒæµ‹è¯•
- [ ] æ— ä¸¥é‡å®‰å…¨æ¼æ´
- [ ] é”™è¯¯æç¤ºç”¨æˆ·å‹å¥½
- [ ] ç§»åŠ¨ç«¯å¯æ­£å¸¸ä½¿ç”¨

---

## åäºŒã€é™„å½•

### 12.1 å‚è€ƒèµ„æ–™

| èµ„æº | é“¾æ¥ |
|------|------|
| Next.js æ–‡æ¡£ | https://nextjs.org/docs |
| shadcn/ui | https://ui.shadcn.com |
| Tailwind CSS | https://tailwindcss.com |
| FastAPI | https://fastapi.tiangolo.com |
| Milvus | https://milvus.io/docs |
| faster-whisper | https://github.com/guillaumekln/faster-whisper |
| Edge TTS | https://github.com/rany2/edge-tts |
| MinerU | https://github.com/opendatalab/MinerU |

### 12.2 æœ¯è¯­è¡¨

| æœ¯è¯­ | è¯´æ˜ |
|------|------|
| SSE | Server-Sent Eventsï¼ŒæœåŠ¡å™¨æ¨é€äº‹ä»¶ |
| JWT | JSON Web Tokenï¼Œè®¤è¯ä»¤ç‰Œ |
| RAG | Retrieval-Augmented Generationï¼Œæ£€ç´¢å¢å¼ºç”Ÿæˆ |
| RRF | Reciprocal Rank Fusionï¼Œæ’åèåˆç®—æ³• |
| BM25 | Best Matching 25ï¼Œç»å…¸æ£€ç´¢ç®—æ³• |
| OCR | Optical Character Recognitionï¼Œå…‰å­¦å­—ç¬¦è¯†åˆ« |
| TTS | Text-to-Speechï¼Œæ–‡å­—è½¬è¯­éŸ³ |
| STT | Speech-to-Textï¼Œè¯­éŸ³è½¬æ–‡å­— |

### 12.3 å˜æ›´å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | å˜æ›´å†…å®¹ | ä½œè€… |
|------|------|---------|------|
| 1.0 | 2025-12-31 | åˆå§‹ç‰ˆæœ¬ | Claude Code |

---

> **æ–‡æ¡£çŠ¶æ€**: ğŸ“‹ è§„åˆ’é˜¶æ®µ
> **æœ€åæ›´æ–°**: 2025-12-31
> **ä¸‹ä¸€æ­¥**: éœ€æ±‚ç¡®è®¤åè¿›å…¥å¼€å‘é˜¶æ®µ